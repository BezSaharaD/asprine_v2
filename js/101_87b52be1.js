(()=>{"use strict";function t(){let t={};for(let s of arguments)s.walk((s=>{if(s.getUsedStats)for(let i of s.getUsedStats()){let s=e(i);s!=i&&(t[s]=(t[s]||0)+1),t[i]=(t[i]||0)+1}}));return Object.keys(t)}function e(t){return t.replace(/(_\d+)+$/,"")}class s{constructor(t,e){this.items=t||[],e&&Object.assign(this,e)}getType(){return"block"}hasItems(){return!0}compileChildrens(t){return this.items.filter((t=>!t.isBlank())).map((e=>e.compile(t)))}isBlank(){for(let t of this.items)if(!t.isBlank())return!1;return!0}isCollapsable(){return!0}isVariableSet(){return!1}isVariableGet(){return!1}process(t){return this}compile(t){return this.compileChildrens(t).join(";\n")}execute(e,s){return e.stats.ensure(t(this)),Function("stats","return "+this.compile(s))(e.stats)}getSignature(){return"("+(this.isCollapsable()?"":"!")+this.getType()+":"+this.items.map((t=>t.getSignature())).join(",")+")"}treeBlockFields(){return[this.items]}makeResult(){return this.noReturn?this:new i([this])}walk(t,e){for(let s of this.treeBlockFields()){for(let i of s)e&&e(i)||t(i);for(let i of s)e&&e(i)||i.walk&&i.walk(t,e)}}walkReplace(t){for(let e of this.treeBlockFields()){let s=[];for(let i of e){let e=t(i);e&&s.push(e)}e.splice(0,e.length,...s);for(let s of e)s.walkReplace&&s.walkReplace(t)}}getInfoProperties(){let t={};for(let e of Object.keys(this))"object"!=typeof this[e]&&(t[e]=this[e]);return t}}class i extends s{getType(){return"block_return"}appendChildren(){let t=this.items.pop();for(let t of arguments)this.items.push(t);t&&this.items.push(t)}compile(t){let e=this.items.map((e=>e.compile(t)));return e[e.length-1]="return "+e[e.length-1],e.join(";\n")}}class r{constructor(t){Object.assign(this,t)}getType(){return"item"}hasItems(){return!1}isVariableSet(){return!1}isVariableGet(){return!1}compile(t){return this.value||0}isBlank(){return this.static&&this.blank}process(t){return this}getSignature(){throw`Item ${this.constructor.name} has no "getSignature" method!`}}const n=["atk","hp","def"],l=new Map;new Map;class a{constructor(t){if(t){const e=Object.keys(t);for(let s=0;s<e.length;s++)this[e[s]]=t[e[s]]}}add(t,e){this[t]=(this[t]||0)+e}set(t,e){this[t]=e}get(t){return this[t]||0}del(t){delete this[t]}isSet(t){return this.hasOwnProperty(t)}getTotal(t){const e=this[t+"_base"]||0;let s=this[t]||0;const i=this[t+"_percent"]||0;return i&&e&&(s+=e*(i/100)),e+s}getTotalPercent(t){return(this[t+"_base"]||0)*(1+(this[t+"_percent"]||0))+(this[t]||0)}getBaseBonus(t){let e=this["base_dmg_bonus_"+t]||0,s=this[t+"_base_atk_percent"];return s&&(e+=this.getTotal("atk")*s/100),s=this[t+"_base_def_percent"],s&&(e+=this.getTotal("def")*s/100),s=this[t+"_base_hp_percent"],s&&(e+=this.getTotal("hp")*s/100),s=this[t+"_base_mastery_percent"],s&&(e+=this.getTotal("mastery")*s/100),e}isEmpty(){return 0===Object.keys(this).length}concat(t){const e=Object.keys(t);for(let s=0;s<e.length;s++){const i=e[s];this[i]=(this[i]||0)+t[i]}}clear(){const t=Object.keys(this);for(let e=0;e<t.length;e++)delete this[t[e]]}copyFrom(t){this.clear();const e=Object.keys(t);for(let s=0;s<e.length;s++)this[e[s]]=t[e[s]]}getSetFunc(){const t=Object.keys(this).sort(),e=t.join(",");if(l.get(e)){const e=t.map((t=>this[t]));return this._createSetFunc(t,e)}const s=[];for(let e=0;e<t.length;e++)s.push(`stats.${t[e]} = ${this[t[e]]}`);const i=Function("stats",s.join(";"));return l.set(e,!0),i}_createSetFunc(t,e){const s=[];for(let i=0;i<t.length;i++)s.push(`stats.${t[i]} = ${e[i]}`);return Function("stats",s.join(";"))}getConcatFunc(t){const e=Object.keys(this),s=[];for(let t=0;t<e.length;t++)s.push(`stats.${e[t]} += ${this[e[t]]}`);if(t){const e=Object.keys(t);for(let i=0;i<e.length;i++)s.push(`stats.${e[i]} = ${t[e[i]]}`)}return Function("stats",s.join(";"))}truncate(t){const e=Object.keys(this);for(let s=0;s<e.length;s++)t.includes(e[s])||delete this[e[s]]}ensure(t){for(let e=0;e<t.length;e++)this[t[e]]||(this[t[e]]=0)}processPercent(){const t=Object.keys(this);for(let e=0;e<t.length;e++)h(t[e])&&(this[t[e]]=this[t[e]]/100)}revertPercent(){const t=Object.keys(this);for(let e=0;e<t.length;e++)h(t[e])&&(this[t[e]]=100*this[t[e]])}calcPost(){const t=this.calcTotals();if(this.post_atk_hp_bonus){const e=(this.post_atk_hp_bonus||0)/100;this.atk=(this.atk||0)+(t.hp_total||0)*e}}calcTotals(t){const e=new a;t||="";const s=["atk","def","hp"];for(let i=0;i<s.length;i++){const r=s[i];if(t&&t!==r)continue;const n=this[r+"_base"]||0,l=n*(this[r+"_percent"]||0)/100+(this[r]||0),a=n+l;e[r+"_base"]=n,e[r+"_bonus"]=l,e[r+"_total"]=a}const i=["crit_rate","crit_dmg","mastery","healing","healing_recv","recharge","shield","recovery"];for(let s=0;s<i.length;s++){const r=i[s];if(t&&t!==r)continue;const n=this[r+"_base"]||0,l=this[r]||0,a=n+l;e[r+"_base"]=n,e[r+"_bonus"]=l,e[r+"_total"]=a}const r=["anemo","geo","electro","pyro","cryo","hydro","phys"],n=["dmg_","res_"];for(let s=0;s<r.length;s++)for(let i=0;i<n.length;i++){const l=n[i]+r[s];if(t&&t!==l)continue;const a=this[l+"_base"]||0,o=this[l]||0,u=a+o;e[l+"_base"]=a,e[l+"_bonus"]=o,e[l+"_total"]=u}return e}applyPostEffects(t,e,s){if(!e||!e.length)return;const i={};for(let t=0;t<e.length;t++){const r=e[t],n=r.getPriority();s&&n>s||(i[n]||(i[n]=[]),i[n].push(r))}const r=Object.keys(i).sort(((t,e)=>t-e));for(let e=0;e<r.length;e++){const s=new a,n=i[r[e]];for(let e=0;e<n.length;e++){const i=n[e].getData(this,t);s.concat(i)}this.concat(s)}}getFormatted(t,e){return a.format(t,this[t]||0,e)}revert(){const t=new a,e=Object.keys(this);for(let s=0;s<e.length;s++)t[e[s]]=-1*this[e[s]];return t}static roundStatValue(t,e,s){const i=s||h(t||"");return e=parseFloat(e)+1e-8,i?e.toFixed(1):Math.round(e)}static format(t,e,s){s||={};let i=e;const r=h(t);return Math.abs(e)<1e-5?s.zero?"0":"":(!function(t){return!!h(t)||c.test(t)}(t)?(i=Math.round(i),s.minimize&&(i>1e7?i=(i/1e6).toFixed(2)+"m":i>1e6&&(i=(i/1e6).toFixed(3)+"m"))):(i+=1e-8,i=i.toFixed(s.decimal_digits||1),s.no_decimal_zero&&(i=i.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"")),r&&(i+="%")),i=i.toString().replace(/\B(?=(\d{3})+(?!\d))/g," "),s.signed&&(e<0?"0"===i&&(i="-0"):i="+"+i),i)}static diff(t,e){const s=Object.assign({},t,e),i=new a,r=Object.keys(s);for(let s=0;s<r.length;s++){const n=r[s],l=(e[n]||0)-(t[n]||0);l&&(i[n]=l)}return i}}const o=/_percent/,u=/^(bond_of_life|stamina|recovery|duration|atk_speed|move_speed|healing|recharge|crit_|dmg_|enemy_|res_|.*bonus_|.*shield|.*_multi)/,c=/(_cooldown|_decimal)/;function h(t){return!!o.test(t)||u.test(t)}class f extends r{getType(){return"item_const"}getSignature(){return"(const:"+this.value+")"}}class g extends r{getType(){return"item_stat"}compile(t){return"stats."+this.stat}process(t){return t.staticStats&&t.staticStats.includes(this.stat)?new f({value:this.value,comment:this.stat}):super.process()}getUsedStats(){return[this.stat]}getSignature(){return"(stat:"+this.stat+")"}}class p extends g{getType(){return"item_stat_total"}getUsedStats(){return[this.stat,this.stat+"_base",this.stat+"_percent"]}process(t){return new w([new k([new g({stat:this.statBaseName(),value:this.baseBalue}),new v([new g({stat:this.statPercentName(),value:this.percentValue})],{comment:this.stat+"_percent",percent:!0})]),new g({stat:this.statFlatName(),value:this.flatValue})],{comment:this.stat}).process(t)}statBaseName(){return this.replaceName(this.stat+"_base")}statPercentName(){return this.replaceName(this.stat+"_percent")}statFlatName(){return this.replaceName(this.stat)}replaceName(t){return this.replace&&this.replace[t]?this.replace[t]:t}compile(t){return`(stats.${this.statBaseName()} * (1 + stats.${this.statPercentName()}) + stats.${this.statFlatName()})`}}class d extends r{constructor(t){t.name=t.ref.name,delete t.ref,super(t)}getType(){return"variable_get"}isVariableGet(){return!0}compile(t){return this.name}getSignature(){return"(var_value:"+this.name+")"}}function m(t,e){return t.indexOf("*")>0?function(t,e){if(!n.includes(t))return new w([m(t+"_base",e),m(t,e)],{comment:t,percent:h(t)});return new p({stat:t,value:e.getTotalPercent(t),baseBalue:e.get(t+"_base"),percentValue:e.get(t+"_percent"),flatValue:e.get(t)})}(t.replace("*",""),e):new g({stat:t,value:e.get(t)})}let b=BigInt(0);function y(t){return(t||"var")+"_"+ ++b}function S(t,e){let s=new d({ref:t}),i=new I([new j([new f({value:1}),new w([s,e])])]),r=new I([new j([new f({value:1}),new w([s,new k([new f({value:2}),e])])])]),n=new I([new j([new f({value:1}),new w([s,new k([new f({value:3}),e])])])]),l=new I([new j([new f({value:1}),new w([s,new k([new f({value:4}),e])])])]),a=new I([new j([new f({value:1}),new w([s,new k([new f({value:5}),e])])])]),o=new d({ref:i}),u=new d({ref:r}),c=new d({ref:n}),h=new d({ref:l}),g=new d({ref:a}),p=new C([new k([new f({value:-1}),g]),new w([s,o,u,c,h,new f({value:-1}),new k([new f({value:-1}),s,o]),new k([new f({value:-1}),s,u]),new k([s,o,u]),new k([new f({value:-1}),o,u]),new k([new f({value:-1}),s,c]),new k([s,o,c]),new k([new f({value:-1}),o,c]),new k([s,u,c]),new k([new f({value:-1}),s,o,u,c]),new k([o,u,c]),new k([new f({value:-1}),u,c]),new k([new f({value:-1}),s,h]),new k([s,o,h]),new k([new f({value:-1}),o,h]),new k([s,u,h]),new k([new f({value:-1}),s,o,u,h]),new k([o,u,h]),new k([new f({value:-1}),u,h]),new k([s,c,h]),new k([new f({value:-1}),s,o,c,h]),new k([o,c,h]),new k([new f({value:-1}),s,u,c,h]),new k([s,o,u,c,h]),new k([new f({value:-1}),o,u,c,h]),new k([u,c,h]),new k([new f({value:-1}),c,h]),new k([new f({value:4}),s,g]),new k([new f({value:-3}),s,o,g]),new k([new f({value:3}),o,g]),new k([new f({value:-2}),s,u,g]),new k([new f({value:2}),s,o,u,g]),new k([new f({value:-2}),o,u,g]),new k([new f({value:2}),u,g]),new k([new f({value:-1}),s,c,g]),new k([s,o,c,g]),new k([new f({value:-1}),o,c,g]),new k([s,u,c,g]),new k([new f({value:-1}),s,o,u,c,g]),new k([o,u,c,g]),new k([new f({value:-1}),u,c,g]),new k([c,g]),new k([new f({value:-5}),g])])]);return[[t,i,r,n,l,a],new I([p],{name:"crit_rate_avg"})]}class w extends s{getType(){return"block_sum"}dontShrink(){return 0}compile(t){let e=this.compileChildrens(t),s=e.join(" + ");return e.length>1&&(s="("+s+")"),s||"0"}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof f&&0!=t.value)),s=this.items.filter((t=>!(t instanceof f)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=0;for(let t of e)i+=t.value;let r=new f({value:i,comment:"processed"});if(0==s.length&&!this.dontShrink())return r;t.push(r);for(let e of s)t.push(e);this.items=t}else this.items=[...e,...s];return 0==this.items.length&&(this.items=[new f({value:0})]),super.process(t)}}class v extends w{getType(){return"block_sum_plus"}compile(t){let e=this.compileChildrens(t);return 0==e.length?"":(e.unshift(1),"("+e.join(" + ")+")")}process(t){return new w([new f({value:1}),...this.items.map((e=>e.process(t)))],this.getInfoProperties(t)).process(t)}}class _ extends s{getType(){return"block_subtract"}compile(t){let e=this.compileChildrens(t),s=e.join(" - ");return e.length>1&&(s="("+s+")"),s||"0"}}class k extends s{getType(){return"block_multi"}compile(t){let e=this.compileChildrens(t),s=e.join(" * ");return e.length>1&&(s="("+s+")"),s||0}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof f&&1!=t.value)),s=this.items.filter((t=>!(t instanceof f)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=1;for(let t of e)i*=t.value;let r=new f({value:i,comment:"processed"});if(0==s.length)return r;t.push(r);for(let e of s)t.push(e);this.items=t}else this.items=[...e,...s];return 1==this.items.length&&"block_multi"==this.getType()?this.items[0]:super.process()}}class C extends s{getType(){return"block_divide"}compile(t){let e=this.compileChildrens(t),s=e.join(" / ");return e.length>1&&(s="("+s+")"),s||0}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof f)),s=this.items.filter((t=>!(t instanceof f)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=e.shift().value;for(let t of e)i/=t.value;let r=new f({value:i,comment:"processed"});if(0==s.length)return r;t.push(r);for(let e of s)t.push(e);this.items=t}return super.process()}}class j extends s{getType(){return"block_min"}compile(t){let e=this.compileChildrens(t);return e.length>1?"Math.min("+e.join(", ")+")":e[0]}}class I extends w{getType(){return"variable_set"}isCollapsable(){return!1}isVariableSet(){return!0}constructor(t,e){(e=Object.assign({},e)).name=y(e.name),super(t,e)}compile(t){return"let "+this.name+" = "+super.compile(t)}}class B extends w{constructor(t,e){e.name=e.ref.name,delete e.ref,super(t,e)}getType(){return"variable_inc"}isCollapsable(){return!1}isVariableSet(){return!0}isVariableGet(){return!0}compile(t){return this.name+" += "+super.compile(t)}}class O extends s{getType(){return"post"}}class A extends s{getType(){return"isolated"}}class D extends w{getType(){return"stat_increase"}isCollapsable(){return!1}getAssignedStats(){return[this.stat]}compile(t){let e=super.compile(t);return this.newName?"stats."+this.newName+" = stats."+this.stat+" + "+e:"stats."+this.stat+" += "+e}}class z extends w{getType(){return"stat_decrease"}isCollapsable(){return!1}getAssignedStats(){return[this.stat]}compile(t){let e=super.compile(t);return"stats."+this.stat+" -= "+e}}class T{constructor(e,s){this.tree=e,this.postItems=s||[],this.usedStats=t(this.tree,...this.postItems),this.assignedStats=function(){let t={};for(let e of arguments){if(e.getAssignedStats)for(let s of e.getAssignedStats())t[s]=(t[s]||0)+1;e.walk((e=>{if(e.getAssignedStats)for(let s of e.getAssignedStats())t[s]=(t[s]||0)+1}))}return Object.keys(t)}(this.tree,...this.postItems),this.isReacted=!1}checkForReaction(){this.tree.walk((t=>{t.isReacted&&(this.isReacted=!0)}))}prepare(t,e){e=Object.assign({},e);let i,r="damage_rotation_result"==this.tree.getType(),n=this.tree.makeResult();if(r||(i=this.makePostTree(e)),this.processed=new s,e.dontProcessTree||(this.processBlock(n,e),i&&this.processBlock(i,e)),i&&this.processed.items.push(i),this.processed.items.push(n),i&&i.revert&&i.revert.length){let t=this.processed.items[this.processed.items.length-1];t.appendChildren?t.appendChildren(...i.revert):this.processed.items.push(...i.revert)}}processBlock(t,e){t.walkReplace((t=>t.process(e))),t.process(e),this.processVariables(t,e)}makePostTree(t){let e=[];for(let s of this.postItems)(t.dontProcessStats||s.stat&&this.usedStats.includes(s.stat))&&e.push(s);if(0==e.length)return;let[s,i]=T.postTreeBlocks(e,t);return new O(s,{revert:i})}static filterPostByStats(s,i){let r=[],n=P(s);i=[].concat(i);for(let s of Object.keys(n).sort().reverse())for(let l of n[s]){let s=e(l.stat);if(l.stat&&(i.includes(l.stat)||i.includes(s))){r.push(l);for(let e of t(l))i.includes(e)||i.push(e)}}return r}static postTreeBlocks(t){let e=[],s=[],i=P(t);for(let t of Object.keys(i).sort()){let r=[],n=[];for(let e of i[t]){let t=new I([e],{name:"post_"+e.stat});r.push(t),n.push(new D([new d({ref:t})],{stat:e.stat})),s.unshift(new z([new d({ref:t})],{stat:e.stat}))}e.push(new A([...r,...n]))}return[e,s]}getCode(t){return this.processed.compile(t)}compile(t){let e=this.getCode(t);return this.compiled=Function("stats",e),e}compilePostTree(t){let e=this.makePostTree(t);return e?(t.dontProcessTree||this.processBlock(e,t),Function("stats",e.compile(t))):Function("stats","")}execute(t){return this.compiled(t.stats)}processVariables(t,e){e.dontInsertVariables||t.walk((t=>{"isolated"==t.getType()&&this.replaceBlockRepeat(t)}))}replaceBlockRepeat(t){for(let e=0;e<10;++e){let e={};t.walk((t=>{if(t.hasItems()){let s=t.getSignature();s&&!s.includes("!")&&(e[s]=(e[s]||0)+1)}}),(t=>"isolated"==t.getType()));let s=[];for(let[t,i]of Object.entries(e))i<2||s.push(t);let i=[];for(let t of s){let e=!0;for(let i of s)if(t!=i&&i.indexOf(t)>=0){e=!1;break}e&&i.push(t)}if(0==i.length)break;let r={},n={};t.walkReplace((t=>{let e=t.getSignature();if(e&&i.includes(e)){if(!r[e]){let s=new I([t]);r[e]=s,n[s.name]=s}return new d({ref:r[e]})}return t})),t.items=R(t.items,n)}}}function R(t,e){let s=[];for(;Object.keys(e).length;){s=[];for(let r of t){let t={};for(var i of(r.walk((e=>{e.isVariableGet()&&!e.isVariableSet()&&(t[e.name]=1)})),Object.keys(t)))e[i]&&(s.push(e[i]),delete e[i]);s.push(r)}t=s}return s}function P(t){let e={};for(let s of t){let t=s.priority;e[t]||(e[t]=[]),e[t].push(s)}return e}const x=1;class M{constructor(t){Object.assign(this,t)}set(t,e){this[t]=e}get(t){return this[t]}getNumber(t){return this[t]||0}concat(){for(let t of arguments)Object.assign(this,t)}getLevel(t){return E(t,this)}}function E(t,e){let s=e[t]||1;s+=e[t+"_bonus"]||0,s+=e[t+"_bonus_2"]||0;let i=/\w+_(char_skill_\w+)/.exec(t);return i&&(s+=e[i[1]+"_bonus_party"]||0),s}class F{constructor(t,e){this.stats=new a(e),this.settings=new M(t),this.multipliers=[],this.postEffects=[]}addStats(t){this.stats.concat(t)}addSettings(t){this.settings.concat(t)}getActivePostEffects(){return this.postEffects.filter((t=>t.isActive(this.settings)))}getActivePostEffectsTree(){let t=this.getActivePostEffects(),e=[];for(let s of t)if(s.getTree)for(let t of s.getTree(this))e.push(t);return e}applyPostEffects(t){for(let t of this.postEffectTreeByPriority()){let e=new T(new s([]),t),i=e.compilePostTree({dontProcessStats:!0});i&&(this.stats.ensure(e.usedStats),this.stats.ensure(e.assignedStats),i(this.stats))}this.postEffects=[]}postEffectByPriority(t){t=Object.assign({},t);let e=this.getActivePostEffects(),s={};for(let i of e){let e=i.getPriority();t.maxPriority&&e>t.maxPriority||(s[e]||(s[e]=[]),s[e].push(i))}let i=[];for(let t of Object.keys(s).sort())i.push(s[t]);return i}postEffectTreeByPriority(t){let e=this.postEffectByPriority(t),s=[];for(let t of e){let e=[];for(let s of t)e=e.concat(s.getTree(this));s.push(e)}return s}getResistance(t){return this.settings.get("enemy_res_"+t)+100*this.stats.get("enemy_res_"+t)}clone(){let t=new F(this.settings,this.stats);return t.postEffects=[].concat(this.postEffects),t.multipliers=[].concat(this.multipliers),t}}class N{static pack(t){let e=t.serialize(),s="";if(e){for(const t of e)s+=L(t);return s}}static unpack(t){let e=t.split(""),s=[],i=0;for(;e.length>0;){let t=e.shift();"\0"==t&&(t="b");let r=t.toUpperCase().charCodeAt(0)-65;if(r<0&&r>25)return null;i+=r,t.toLowerCase()==t?(s.push(i),i=0):i*=26}return i&&s.push(i),s}}function L(t){let e=parseInt(t),s="";for(;e>25;){let t=e%26;e-=t,e/=26,s=String.fromCharCode(65+t)+s}s=String.fromCharCode(65+e)+s;let i=s.substring(s.length-1);return s.substring(0,s.length-1).toUpperCase()+i.toLowerCase()}function V(t,e,s){let i=DB.Artifacts.Substats.get(t),r=DB.Artifacts.Rarity[e-1],n=i.rolls[e-1],l="percent"==i.type,o=U([],s,n,r.maxUpgrades,l);o=function(t){let e={};for(let s of t){let t=s.pop();e[[].concat(s.sort(),[t]).join("-")]=1}let s=[];for(const t of Object.keys(e).sort())s.push(t.split("-"));return s}(o),o=o.sort((function(t,e){return t[t.length-1]-e[e.length-1]||t.length-e.length}));let u=o[0],c=[];u||(u=[0]);let h=a.roundStatValue("",u.pop(),l);for(let t of u){let e=1;for(let s=0;s<n.length;++s)t==n[s]&&(e=2+s);c.push({value:a.roundStatValue("",t,l),rarity:e})}return{steps:c,maxValue:c.length*n[n.length-1],last:h,maxUpgrades:r.maxUpgrades}}function U(t,e,s,i,r){let n=[];if(i<=0){let s=H(t,e,r),i=[].concat(t);return i.push(Math.abs(s)),[i]}for(let l of s){let a=[].concat(t);a.push(l);let o=H(a,e,r);o>0?n=n.concat(U(a,e,s,i-1,r)):(0==o?a.push(0):(a=[].concat(t),a.push(Math.abs(l+o))),n.push(a))}return n}function H(t,e,s){let i=t.reduce((function(t,e){return t+e}),0),r=a.roundStatValue("",e,s)-a.roundStatValue("",i,s);return Math.abs(r)<.001?0:e-i}class G{constructor(t,e,s,i,r,n){this.rarity=t,this.level=e,this.slot=s,this.set=i,this.mainStat=r,this.subStats=n||[],this.locked=!1,this.groups=[],this.calculated=null}addStat(t,e){this.subStats.push({stat:t,value:e}),this.calculated=null}calcStats(){var t=new a;let e=DB.Artifacts.Mainstats.get(this.mainStat);if(e){let s=e.values[this.rarity-1];t.add(this.mainStat,s.getValue(this.level))}for(let e=0;e<this.subStats.length;++e){let s=this.subStats[e],i=DB.Artifacts.Substats.get(s.stat);t.add(s.stat,i.getPreciseValue(s.value,this.rarity))}return t.add("crit_value",2*t.get("crit_rate")+t.get("crit_dmg")),t}calcCache(t){this.calculated=this.calcStats(),this.calculated.truncate(t),this.calculated.processPercent()}replace(t){this.rarity=t.rarity,this.level=t.level,this.slot=t.slot,this.set=t.set,this.mainStat=t.mainStat,this.subStats=t.subStats,this.groups=t.getGroups(),this.calculated=null}getLevel(){return this.level}getSet(){return this.set}getRarity(){return this.rarity}getMainStat(){return""+this.mainStat}getSetName(){return""+this.set}getSlot(){return""+this.slot}getMainStatValue(){let t=this.getMainStat();return t?DB.Artifacts.Mainstats.get(t).values[this.rarity-1].getValue(this.level):0}getSubStats(){return this.subStats}setGroups(t){let e=t;Array.isArray(t)||(e=[t]);let s=[];for(let t of e){let e=G.trimGroupName(t);G.inGroups(s,e)||s.push(e)}this.groups=s}getGroups(){return this.groups&&0!=this.groups.length?this.groups:[""]}hasGroup(t){let e=t.toUpperCase();for(let t of this.groups)if(e==t.toUpperCase())return!0;return!1}inGroups(t){for(let e of t)if(this.hasGroup(e))return!0;return!1}isValid(){return 0==this.getErrors().length}setLocked(t){this.locked=!!t}isLocked(){return this.locked}getHash(){return N.pack(this)}getErrors(){let t=[];DB.Artifacts.Sets.get(this.set)||t.push("no_set"),DB.Artifacts.Mainstats.get(this.mainStat)||t.push("no_main_stat");let e=DB.Artifacts.Rarity[this.rarity-1],s=this.subStats.length;(s<e.minSubstats||s>e.maxSubstats)&&t.push("substat_count_mismatch");let i=!1,r=!1,n=!1,l=!1,a=[],o=0;for(const t of this.subStats){t.stat==this.mainStat&&(i=!0),a.includes(t.stat)&&(l=!0),a.push(t.stat);let e=V(t.stat,this.rarity,t.value);e.last>0&&(e.steps.length<e.maxUpgrades?n=!0:r=!0),e.steps.length>1&&(o+=e.steps.length-1)}let u=e.maxSubstats-4+Math.floor(this.level/4),c=Math.max(0,e.minSubstats-4+Math.floor(this.level/4));return o>0&&this.subStats.length<4&&t.push("not_full_substats"),(o>u||o>=e.maxUpgrades)&&t.push("too_much_upgrades"),o<c-1&&t.push("too_low_upgrades"),i&&t.push("substat_equal_main"),n&&t.push("substat_value_rolls"),r&&t.push("substat_value_range"),l&&t.push("substat_duplicate"),t}getErrorsFormatted(){let t=this.getErrors();if(0==t.length)return"";let e="";for(const s of t)e+="<p>"+UI.Lang.get("artifact_error."+s)+"</p>";return e}toGood(){let t=DB.Artifacts.Sets.get(this.set),e=DB.Artifacts.Mainstats.get(this.mainStat),s={setKey:t.getGoodId(),slotKey:this.slot,level:this.level,rarity:this.rarity,mainStatKey:e.goodId,location:"",lock:!1,substats:[]};for(const t of this.subStats){let e=DB.Artifacts.Substats.get(t.stat);if(!e)return null;s.substats.push({key:e.goodId,value:t.value})}return s}serialize(){let t=[1];t.push(DB.Artifacts.Sets.getId(this.set)),t.push(this.rarity),t.push(this.level),t.push(DB.Artifacts.Slots.getId(this.slot)),t.push(DB.Artifacts.Mainstats.getId(this.mainStat)||0),t.push(this.subStats.length);for(const e of this.subStats){t.push(DB.Artifacts.Substats.getId(e.stat));let s=DB.Artifacts.Substats.get(e.stat),i=e.value;"percent"==s.type&&(i=Math.floor(10*i)),t.push(i)}return t}clone(){return G.deserialize(this.serialize())}static deserialize(t){let e=null;if(1==t.shift()){let s=DB.Artifacts.Sets.getKeyId(t.shift());if(!s)return null;let i=t.shift();if(i<1||i>5)return null;let r=t.shift();if(r<0||r>20)return null;let n=DB.Artifacts.Slots.getKeyId(t.shift());if(!n)return null;let l=DB.Artifacts.Mainstats.getKeyId(t.shift())||"",a=t.shift();if(a<0||a>4)return null;e=new G(i,r,n,s,l);for(let s=1;s<=a;++s){let s=DB.Artifacts.Substats.getKeyId(t.shift());if(!s)return null;let i=t.shift();if(i<1)return null;let r=DB.Artifacts.Substats.get(s);if(!r)return null;i="percent"==r.type?parseFloat(i)/10:parseInt(i),e.addStat(s,i)}}return e}static fromGood(t){let e=DB.Artifacts.Sets.getKeyIdGood(t.setKey),s=DB.Artifacts.Sets.get(e);if(!s)return null;if(!DB.Artifacts.Slots.get(t.slotKey))return null;let i=DB.Artifacts.Mainstats.getKeyIdGood(t.mainStatKey),r=DB.Artifacts.Mainstats.get(i);if(!r)return null;if(!r.slots.includes(t.slotKey))return null;if(t.rarity<s.minRarity&&t.rarity>s.maxRarity)return null;let n=DB.Artifacts.Rarity[t.rarity-1];if(t.level<0&&t.level>n.maxLevel)return null;let l=new G(t.rarity,t.level,t.slotKey,e,i);if(Array.isArray(t.substats)){if(t.substats.length>4)return null;for(const e of t.substats){if(!e.key)continue;let t=DB.Artifacts.Substats.getKeyIdGood(e.key);if(!t)return null;let s=e.value;l.addStat(t,s)}}return l}static subStatsIsSimilar(t,e){if(t.subStats.length<e.subStats.length)return!1;for(let s=0;s<e.subStats.length;++s)if(t.subStats[s].stat!=e.subStats[s].stat||t.subStats[s].value<e.subStats[s].value)return!1;return!0}static inGroups(t,e){for(let s of t)if(G.groupsAreEqual(s,e))return!0;return!1}static groupsAreEqual(t,e){return t.toUpperCase()==e.toUpperCase()}static trimGroupNames(t){Array.isArray(t)||(t=[t]);let e=[];for(let s of t)e.push(G.trimGroupName(s));return e}static trimGroupName(t){let e=t||"";return e=e.replace(/[^\w\u0400-\u04ff\d_\-\s]/g,""),e=e.replace(/\s+/g," "),e.trim()}static settingName(t){return"set_pieces."+t.toLowerCase()}static settingNameShort(t){return t.toLowerCase()}}class K{constructor(t){this.params=t||{},this.entityId=0}getId(){return this.params.serializeId||0}getEntityId(){return this.entityId}getName(){return this.params.name}getNamesList(){return[this.getName()]}getType(){return""}getTitle(t){return this.params.title?UI.Lang.getTalent(this.params.title,t):""}getIcon(){return this.params.icon?this.params.icon.name:""}getDescription(t){return this.params.description?UI.Lang.getTalent(this.params.description,t):""}getInfo(){return this.params.info}getLevel(t){return E(this.params.levelSetting,t)}isHidden(t){if(this.params.isHidden)return!0;let e=this.params.hideCondition;if(e)for(let s=0;s<e.length;++s){if(e[s].isActive(t))return!0}return!1}isActive(t){return this.checkSubconditions(t)}isSerializable(){let t=this.getName(),e=this.getType();return!(!t&&!e||"static"==e)}getMaxStacks(t){return this.params.maxStacks||0}checkSubconditions(t){if(this.params.condition)return this.params.condition.isActive(t);{let e=this.params.subConditions;if(e)for(let s=0;s<e.length;++s){if(!e[s].isActive(t))return!1}}return!0}getData(t){let e={settings:{}};return this.isActive(t)?(e.settings=this.params.settings||{},e.stats=this.getStats(t)):e.stats=new a,e}getStats(t){return new a(this.params.stats||{})}getBuffRotationSection(t){return this.params.rotation||""}static allConditionsOn(t,e){let s={};for(let i=0;i<t.length;++i){const r=t[i];let n=r.getType();"stacks"==n?s[r.getName()]=r.getMaxStacks():"checkbox"==n?s[r.getName()]=!0:"dropdown"==n?s[r.getName()]=r.params.suggesterValue||0:r.getAllConditionsOn&&Object.assign(s,r.getAllConditionsOn(e))}return s}static allConditionsOff(t){let e={};for(let s=0;s<t.length;++s){const i=t[s];let r=i.getType();"stacks"==r?e[i.getName()]=0:"checkbox"==r&&(e[i.getName()]=!1)}return e}static setCommonValues(t,e){let s={};for(let i=0;i<e.length;++i){const r=e[i].getName();/^common\./.test(r)&&(t[r]||=0,s[r]=t[r])}return s}static unwrap(t,e){let s=[];for(let i of t)if(i.getCondtitionList)for(let t of i.getCondtitionList())e&&!t.isActive(e)||s.push(t);else s.push(i);return s}}class W{constructor(){this.object=null,this.settings={}}getName(){return this.object&&this.object.getName()||""}getIcon(){return this.object&&this.object.getIcon()||""}getRarity(){return this.object&&this.object.getRarity()||1}set(t){this.object=t,this.removeInvalidSettings()}get(){return this.object}getConditions(){return this.object&&this.object.getConditions()||[]}getFeatures(){return this.object&&this.object.getFeatures()||[]}getPostEffects(){return this.object&&this.object.getPostEffects()||[]}getMultipliers(){return this.object&&this.object.getMultipliers()||[]}getSettings(){return Object.assign({},this.settings)}getLevels(){return this.levels}getStats(){var t=new a;if(this.object&&this.object.statTable)for(let e=0;e<this.object.statTable.length;++e){let s=this.object.statTable[e],i=s.getValue(this.levels.level,this.levels.ascension);t.add(s.getName(),i)}return{stats:t,settings:{}}}setSettings(t){this.settings=t}modifySettings(t){return Object.assign(this.settings,t),this.getSettings()}addSettings(t){this.settings=Object.assign(this.settings,t)}isBeta(){return this.object&&this.object.isBeta()}serialize(){return[]}removeInvalidSettings(){let t=this.getConditions(),e=K.allConditionsOn(t);for(const t of Object.keys(this.settings))void 0===e[t]&&delete this.settings[t]}serializeConditions(t,e){let s=0,i=[],r=[];if(e)for(const s of K.unwrap(e,t))s.isActive(t)&&r.push(s);else for(const e of K.unwrap(this.getConditions({serialize:!0}),t))e.isActive(t)&&r.push(e);for(const e of r){if(!e.params.serializeId)continue;let r=e.getType();if("checkbox"==r)++s,i.push(e.params.serializeId);else if("stacks"==r)++s,i.push(e.params.serializeId),i.push(t[e.getName()]);else if("number"==r){++s,i.push(e.params.serializeId);let r=t[e.getName()]||0;r="decimal"==e.params.format?Math.floor(10*parseFloat(r)):parseInt(r),i.push(Math.max(0,r))}else if("dropdown"==r||"dropdown_multiple"==r){let r=e.getSelectedId(t);r&&(++s,i.push(e.params.serializeId),i.push(r))}else if("char"==r){let r=this.serializeChars(t);r.length&&(++s,i.push(e.params.serializeId),i=i.concat(r))}else if("custom_buffs"==r){let r=this.serializeCustomBuffs(t);r.length&&(++s,i.push(e.params.serializeId),i=i.concat(r))}}return i.unshift(s),i}serializeChars(t){return[]}serializeCustomBuffs(t){return[]}deserializeChars(t){return{}}deserializeCustomBuffs(t){return{}}deserializeConditions(t,e){let s={},i=t.shift(),r={};if(e)for(const t of K.unwrap(e))t.params.serializeId&&(r[t.params.serializeId]=t);else for(const t of K.unwrap(this.getConditions({serialize:!0})))t.params.serializeId&&(r[t.params.serializeId]=t);for(let e=1;e<=i;++e){let i=t.shift();if(e<1)return;let n=r[i];if(!n)return;let l=n.getType();if("checkbox"==l)s[n.getName()]=!0;else if("stacks"==l){let e=t.shift();e>n.params.maxStack&&(e=n.params.maxStack),s[n.getName()]=e}else if("number"==l){let e=t.shift();"decimal"==n.params.format&&(e=(e/10).toFixed(1)),s[n.getName()]=e}else if("dropdown"==l||"dropdown_multiple"==l){let e=n.getValueById(t.shift());s[n.getName()]=e||""}else"char"==l?s=Object.assign(s,this.deserializeChars(t)):"custom_buffs"==l&&(s=Object.assign(s,this.deserializeCustomBuffs(t)))}return s}}const $=["flower","plume","sands","goblet","circlet"];class q extends W{constructor(){super(),this.artifacts={flower:null,plume:null,sands:null,goblet:null,circlet:null}}get(){return this.artifacts}hasEquipped(){for(let t of $)if(this.artifacts[t])return!0;return!1}getSettings(){let t=Object.assign({},this.settings),e={};for(let t of $){let s=this.artifacts[t];s&&(e[s.set]=1+(e[s.set]||0))}for(let s of Object.keys(e))t[G.settingName(s)]=e[s];return t}getFeatures(){let t=[],e=this.activeSets(),s=Object.keys(e);for(let i=0;i<s.length;++i){let r=s[i],n=DB.Artifacts.Sets.get(r);if(n){let s=n.getFeatures(e[r]);t=t.concat(s)}}return t}isBeta(){let t=this.activeSets(),e=Object.keys(t);for(let t of e){let e=DB.Artifacts.Sets.get(t);if(e&&e.isBeta())return!0}return!1}getStats(t){let e={stats:new a,settings:{}};for(let s=0;s<$.length;++s){const i=$[s];let r=this.artifacts[i];r&&e.stats.concat(r.calcStats(t))}return e}getConditions(){let t=[],e=this.activeSets(),s=Object.keys(e);for(let i=0;i<s.length;++i){let r=s[i],n=DB.Artifacts.Sets.get(r);if(n){let s=n.getConditions(e[r]);t=t.concat(s)}}return t}getPostEffects(){let t=[];for(let e of DB.Artifacts.Sets.getList()){let s=e.getPostEffects();t=t.concat(s)}return t}getMultipliers(){let t=[],e=this.activeSets();for(const[s,i]of Object.entries(e)){let e=DB.Artifacts.Sets.get(s);if(e){let s=e.getMultipliers(i);t=t.concat(s)}}return t}modifySets(t){let e=[].concat(t),s={},i=DB.Artifacts.Sets.getKeys();for(let t=0;t<$.length;++t){const r=$[t];let n=this.artifacts[r];if(n){let t=e.shift();if(!t)for(const e of i){if(s[e])continue;let i=DB.Artifacts.Sets.get(e);i.getConditions(1).length||i.minRarity<=n.rarity&&i.maxRarity>=n.rarity&&(t=e)}s[t]=1,n.set=t}}}set(t){let e=t.slot;this.artifacts[e]=t,this.removeInvalidSettings()}replace(t){for(let e of t){let t=e.slot;this.artifacts[t]=e}this.removeInvalidSettings()}remove(t){let e=t.getHash();for(let t=0;t<$.length;++t){const s=$[t];let i=this.artifacts[s];i&&i.getHash()==e&&(this.artifacts[s]=null,this.removeInvalidSettings())}}clearArtifacts(){for(let t=0;t<$.length;++t){const e=$[t];this.artifacts[e]=null}}isEquipped(t){let e=t.slot;return!(!this.artifacts[e]||this.artifacts[e]!=t)}activeSets(){let t={};for(let e=0;e<$.length;++e){const s=$[e];let i=this.artifacts[s];i&&(i.set&&(t[i.set]||(t[i.set]=0),++t[i.set]))}return t}serialize(t){let e=[],s=0;for(let t=0;t<$.length;++t){const i=$[t];let r=this.artifacts[i];r&&(++s,e=e.concat(r.serialize()))}e.unshift(s);let i=this.serializeConditions(t);return e.concat(i)}static deserialize(t){let e=t.shift();if(e<0||e>5)return null;let s=new q;for(let i=1;i<=e;++i){let e=G.deserialize(t);if(!e)return null;s.set(e)}let i=s.deserializeConditions(t);return i?(s.setSettings(i),s):null}}const J={atk:{serializeId:1,flat:!0},atk_percent:{serializeId:2},def:{serializeId:3,flat:!0},def_percent:{serializeId:4},hp:{serializeId:5,flat:!0},hp_percent:{serializeId:6},mastery:{serializeId:7,flat:!0},recharge:{serializeId:8},crit_rate:{serializeId:9},crit_dmg:{serializeId:10},healing:{serializeId:11},healing_recv:{serializeId:12},shield:{serializeId:13},recharge:{serializeId:14},crit_rate:{serializeId:15},crit_dmg:{serializeId:16},healing:{serializeId:17},healing_recv:{serializeId:18},shield:{serializeId:19},dmg_all:{serializeId:20},dmg_anemo:{serializeId:21},dmg_cryo:{serializeId:22},dmg_dendro:{serializeId:23},dmg_electro:{serializeId:24},dmg_geo:{serializeId:25},dmg_hydro:{serializeId:26},dmg_pyro:{serializeId:27},dmg_phys:{serializeId:28},dmg_normal:{serializeId:29},dmg_charged:{serializeId:30},dmg_plunge:{serializeId:31},dmg_skill:{serializeId:32},dmg_burst:{serializeId:33},enemy_def_reduce:{serializeId:34},enemy_def_ignore:{serializeId:35}};let Q={};for(let t of Object.keys(J))Q[J[t].serializeId]=t;class X extends W{constructor(){super(),this.buffs=DB.Buffs,this.partyCharIds=[]}get(){return this.buffs}getFeatures(){return[]}isBeta(){return!1}getStats(t){return{stats:new a,settings:{}}}getConditions(t){let e=[];t||={};for(const t of this.buffs.getList())e=e.concat(t.getConditions());let s=this.getPartyChars();if(!t.serialize)for(let t=0;t<s.length;++t){let i=s[t];const r=DB.Chars.getById(i);r&&(e=e.concat(r.getPartyConditions()))}return e}getMultipliers(){let t=[];for(const e of this.buffs.getList())t=t.concat(e.getMultipliers());let e=this.getPartyChars();for(let s of e){const e=DB.Chars.getById(s);e&&(t=t.concat(e.getPartyMultipliers()))}return t}getPostEffects(){let t=[],e=this.getPartyChars();for(const e of this.buffs.getList())t=t.concat(e.getPostEffects());for(let s=0;s<e.length;++s){let i=e[s];const r=DB.Chars.getById(i);r&&(t=t.concat(r.getPartyPostEffects()))}return t}setPartyChars(t){this.partyCharIds=[];for(const e of t)e&&DB.Chars.getById(e)&&this.partyCharIds.push(e)}getPartyChars(){return[].concat(this.partyCharIds)}getSettings(){let t=super.getSettings(),e=1;for(let s=1;s<=3;++s){let i=this.partyCharIds[s-1];const r=DB.Chars.getById(i);r?(++e,t["party_char_"+s]=i,t["resonance_element_"+s]=r.getElement()):(t["party_char_"+s]=0,t["resonance_element_"+s]="")}return t.party_size=e,t}serialize(t){let e=this.serializeConditions(t);return[].concat(e)}serializeChars(t){let e=this.getPartyChars(),s=[],i=0;for(let r=0;r<e.length;++r){let n=e[r],l=DB.Chars.getById(n);if(l){++i;let e=l.getPartyConditions(),r=this.serializeConditions(t,e);s.push(n),s=s.concat(r)}}return s.unshift(i),s}serializeCustomBuffs(t){let e=0,s=[];for(let i of Object.keys(J)){let r=t["custom_buffs."+i];if(!r)continue;++e;let n=J[i];s.push(n.serializeId),n.flat?s.push(Math.floor(r)):s.push(Math.floor(10*r))}return e&&s.unshift(e),s}deserializeChars(t){let e=t.shift(),s={};for(let i=0;i<e;++i){let e=t.shift(),r=DB.Chars.getById(e);if(!r)return null;let n=r.getPartyConditions();s["party_char_"+(i+1)]=e;let l=this.deserializeConditions(t,n);s=Object.assign(s,l)}return s}deserializeCustomBuffs(t){let e=t.shift(),s={};for(let i=0;i<e;++i){let e=t.shift(),i=Q[e];if(!i)return null;let r=J[i],n=t.shift();r.flat||(n/=10),s["custom_buffs."+i]=n}return s}static deserialize(t){let e=new X,s=e.deserializeConditions(t);if(!s)return null;let i={};e.partyCharIds=[];for(let t=1;t<=3;++t)s["party_char_"+t]&&e.partyCharIds.push(s["party_char_"+t]);if(0==e.partyCharIds.length)for(let t=1;t<=3;++t){let r=s["old_resonance_element_"+t];if(r){delete s["old_resonance_element_"+t];for(const t of DB.Chars.getList()){let s=t.getId();if(!i[s]&&r==t.getElement()){e.partyCharIds.push(s),i[s]=1;break}}}}return e.setSettings(s),e}}class Y{constructor(t,e){this.stat=t,this.values=e}getName(){return this.stat}getValue(t){return t>0?(t>this.values.length&&(t=this.values.length),this.values[t-1]):0}getValues(){return this.values}multiply(t){let e=[];for(let s of this.values)e.push(s*t);return new Y(this.stat,e)}}const Z=new Y("",[1,2,4,6,8,10]);class tt extends W{constructor(){super(),this.levels={level:1,ascension:0,constellation:0},this.skills={attack:1,elemental:1,burst:1}}setLevels(t){this.levels.level=t.level,this.levels.ascension=t.ascension,this.levels.constellation=t.constellation}getLevels(){return{level:this.levels.level,ascension:this.levels.ascension,constellation:this.levels.constellation}}setSkills(t){this.skills.attack=t.attack,this.skills.elemental=t.elemental,this.skills.burst=t.burst}getId(){return this.object?this.object.getId():0}getName(){return this.object?this.object.getName():""}getSkills(){return{attack:this.skills.attack,elemental:this.skills.elemental,burst:this.skills.burst}}getConditions(){let t=super.getConditions();if(!this.object)return t;let e=this.object.constellation;return e&&(t=t.concat(e.getConditions(this.levels.constellation))),t=t.concat(DB.Conditions.Character),t}getFeatures(){let t=super.getFeatures();if(!this.object)return t;let e=this.getConstellation();return e&&(t=t.concat(e.getFeatures(this.levels.constellation))),t}getSettings(){let t=super.getSettings(),e=Z.getValue(this.levels.ascension||1),s={char_skill_attack:Math.min(e,this.skills.attack),char_skill_elemental:Math.min(e,this.skills.elemental),char_skill_burst:Math.min(e,this.skills.burst),char_level:this.levels.level,char_ascension:this.levels.ascension,char_constellation:this.levels.constellation};return this.object&&(s.char_id=this.object.getId(),s.char_name=this.object.name,s.char_element=this.object.element,s.char_origin=this.object.origin),t=Object.assign(t,s),t}getConstellation(){return this.object.constellation}getElement(){return this.object&&this.object.getElement()||""}getWeaponType(){return this.object&&this.object.getWeapon()||""}serialize(t){let e=[];if(!this.object)return null;e.push(this.object.getId()),e.push(this.levels.level,this.levels.ascension,this.levels.constellation),e.push(this.skills.attack,this.skills.elemental,this.skills.burst);let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=DB.Chars.getById(t.shift());if(!e)return null;let s=t.shift();if(s<1||s>90)return null;let i=t.shift();if(i<0||i>6)return null;let r=t.shift();if(r<0||r>6)return null;let n=t.shift();if(n<1||n>10)return null;let l=t.shift();if(l<1||l>10)return null;let a=t.shift();if(a<1||a>10)return null;let o=new tt;o.set(e),o.setLevels({level:s,ascension:i,constellation:r}),o.setSkills({attack:n,elemental:l,burst:a});let u=o.deserializeConditions(t);return u?(o.setSettings(u),o):null}}class et extends W{constructor(){super(),this.levels={level:1},this.resistances={phys:0,anemo:0,cryo:0,geo:0,hydro:0,pyro:0,electro:0,dendro:0}}setLevels(t){this.levels.level=t.level}setResistances(t){for(const e of["anemo","cryo","dendro","electro","geo","hydro","phys","pyro"])this.resistances[e]=parseInt(t[e])||0}getResistances(){return this.object?this.object.getResistances():this.resistances}getStats(){return{stats:new a,settings:{}}}getSettings(){let t=super.getSettings(),e=this.getResistances();return t=Object.assign(t,{enemy_level:this.levels.level,enemy_res_phys:e.phys||0,enemy_res_anemo:e.anemo||0,enemy_res_cryo:e.cryo||0,enemy_res_geo:e.geo||0,enemy_res_hydro:e.hydro||0,enemy_res_pyro:e.pyro||0,enemy_res_electro:e.electro||0,enemy_res_dendro:e.dendro||0}),this.object&&(t.enemy_type=this.object.type,t=Object.assign(t,this.object.getSettings())),t}getConditions(){let t=super.getConditions();return t=t.concat(DB.Conditions.Enemy),t}serialize(t){let e=[];e.push(this.levels.level),this.object?(e.push(2),e.push(this.object.getId())):(e.push(1),e.push(this.resistances.anemo+100),e.push(this.resistances.cryo+100),e.push(this.resistances.dendro+100),e.push(this.resistances.electro+100),e.push(this.resistances.geo+100),e.push(this.resistances.hydro+100),e.push(this.resistances.phys+100),e.push(this.resistances.pyro+100));let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=t.shift();if(e<1||e>110)return null;let s=t.shift(),i=new et;if(i.setLevels({level:e}),1==s){let e={};for(const s of["anemo","cryo","dendro","electro","geo","hydro","phys","pyro"]){let i=t.shift()-100;if(i<-100||i>1e3)return null;e[s]=i}i.setResistances(e)}else{if(2!=s)return null;{let e=DB.Enemies.getById(t.shift());if(!e)return null;i.set(e)}}let r=i.deserializeConditions(t);return r?(i.setSettings(r),i):null}}const st=["Attack","Defence","Potion"];class it extends W{constructor(){super(),this.food={Attack:{item:null,level:0},Defence:{item:null,level:0},Potion:{item:null,level:0}}}get(t){let e=this.food[t];if(e.item)return e.item}getLevel(t){let e=this.food[t];return e.item?e.level:0}set(t,e,s){this.food[t]={item:e,level:s}}isBeta(){return!1}getSettings(){return{}}getStats(t){let e={stats:new a,settings:{}};for(let t=0;t<st.length;++t){const s=st[t];let i=this.food[s];i.item&&e.stats.concat(i.item.getStats(i.level))}return e}getConditions(){return[]}getPostEffects(){return[]}serialize(){let t=[],e=0;for(let s=0;s<st.length;++s){const i=st[s];++e;let r=this.food[i];r.item?(t.push(r.item.getId()),t.push(r.level)):t.push(0)}return t.unshift(e),t}static deserialize(t){let e=new it,s=t.shift();for(let i=0;i<s;++i){let s=st[i];if(!s)return null;let r=t.shift(),n=0,l=DB.Food.get(s).getById(r);r>0&&(n=t.shift()),l&&(e.food[s]={item:l,level:n})}return e}}class rt extends W{isBeta(){return!1}getSettings(){return{}}getStats(t){return{stats:new a,settings:new M({})}}getConditions(){return[]}getFeatures(){return DB.Features.Reactions}getPostEffects(){return[]}}const nt={1:"reaction.melt",2:"reaction.vaporize"};class lt{constructor(t){this.name=t&&t.name||"",this.items=t&&t.items||[]}addItem(t){this.items.push(t)}getItems(){return this.items}getfeaturesNames(){let t=ut(this.items);return Object.keys(t)}getItem(t){return ct(t,this.items)}replaceItem(t,e){let s=this.getItem(t);if(s){for(let t of Object.getOwnPropertyNames(s))"id"!=t&&delete s[t];for(let t of Object.getOwnPropertyNames(e))s[t]=e[t]}}deleteItem(t){let e=this.getItem(t);e&&ht(e,this.items)}clone(){return lt.deserialize(this.serialize())}getHash(){return N.pack(this)}serialize(){let t=at(this.getItems());return t.unshift(0),t.unshift(3),t}static deserialize(t){let e=t.shift(),s=null;if(1==e||2==e||3==e){e>=2&&t.shift();let i=ot(t,0,e);s=new lt({items:i})}return s}static getConditionData(t,e){let s={cond:null,typeId:0,icon:"",object:"",dbObject:null,invalid:!0},i=[],r=[];if("char"==t.subtype){let n=DB.Chars.getById(t.itemId);n&&(s.typeId=1,s.object="char",s.dbObject=n,s.icon="sprite-char "+n.getIcon(),i=n.getAllConditions(),e&&t.itemId==e.getChar().getId()&&(r=i))}else if("weapon"==t.subtype){let n=DB.Conditions.Weapon;i=i.concat(n);let l=DB.Weapons.getById(t.itemId);l&&(s.typeId=2,s.object="weapon",s.icon="sprite-weapon-"+l.weapon+" "+l.getIcon(),i=i.concat(l.getConditions()),e&&t.itemId==e.getWeapon().getId()&&(r=i))}else if("artifacts"==t.subtype){let n=DB.Artifacts.Sets.getById(t.itemId);n&&(s.typeId=3,s.object="artifacts",s.icon="sprite-artifact "+n.getImage()+" flower",i=n.getConditions(5),e&&(r=e.getConditions({objects:[t.subtype]})))}else if("enemy"==t.subtype){if(i=i.concat(DB.Conditions.Enemy),s.typeId=4,s.object="enemy",t.itemId){let e=DB.Enemies.getById(t.itemId);e&&(s.icon="sprite-enemy "+e.getImage(),i=i.concat(e.getConditions()),r=i)}}else if("party"==t.subtype){let n=DB.Chars.getById(t.itemId);if(n&&(s.typeId=5,s.object="buffs",s.icon="sprite-char "+n.getIcon(),i=K.unwrap(n.getPartyConditions()),e)){let s=e.getSettings();for(let e=1;e<=3;++e)s["party_char_"+e]==t.itemId&&(r=i)}}else if("buffs"==t.subtype){let e,n=[];for(const t of DB.Buffs.getList())n=n.concat(t.getConditions());for(let s of K.unwrap(n))if(s.getId()==t.conditionId){e=s;break}e&&(s.typeId=6,s.object="buffs",s.icon=e.getIcon(),i=[e],r=i)}for(const e of i)if(e.getId()==t.conditionId){s.cond=e;break}for(const e of r)if(e.getId()==t.conditionId){s.invalid=!1;break}return s}static getArtSetByCondition(t){for(const e of DB.Artifacts.Sets.getList())for(const s of e.getConditions(5))if(s.getId()==t)return e.getId();return 0}static getEnemyByCondition(t){for(const e of DB.Enemies.getList())for(const s of e.getConditions())if(s.getId()==t)return e.getId();return 0}}function at(t){let e=[],s=0;for(const i of t)if(i)if(e.push(i.disabled?1:0),e.push(i.collapsed?1:0),"feature"==i.type){let t=DB.Features.Rotation.getByName(i.feature);t&&(++s,e.push(1),e.push(t),e.push(Math.max(1,i.count)),e.push(i.reaction||0))}else if("condition"==i.type){let t=lt.getConditionData(i);if(t.cond){let r;++s,e.push(2),e.push(t.typeId),e.push(i.itemId),e.push(t.cond.params.serializeId),r="decimal"==t.cond.params.format?Math.floor(10*parseFloat(i.value)):+i.value,e.push(r||0)}}else if("repeat"==i.type){++s,e.push(3),e.push(Math.max(1,i.count));let t=at(i.items);e=e.concat(t)}else if("uptime"==i.type){++s,e.push(4),e.push(1),e.push(Math.min(100,Math.max(0,i.percent)));let t=at([].concat(i.conditions,i.features));e=e.concat(t)}return e.unshift(s),e}function ot(t,e,s){let i=t.shift(),r=[];for(let n=0;n<i;++n){let i={disabled:!1};s>=2&&(i.disabled=!!t.shift()),s>=3&&(i.collapsed=!!t.shift());let n=t.shift();if(i.id=++e,1==n){i.type="feature";let e=t.shift();if(i.feature=DB.Features.Rotation.getById(e),!i.feature)return null;i.count=Math.max(1,t.shift()),i.reaction=t.shift()}else if(2==n){i.type="condition";let e=t.shift();if(1==e)i.subtype="char";else if(2==e)i.subtype="weapon";else if(3==e)i.subtype="artifacts";else if(4==e)i.subtype="enemy";else if(5==e)i.subtype="party";else{if(6!=e)return null;i.subtype="buffs"}i.itemId=t.shift(),i.conditionId=t.shift();let s=lt.getConditionData(i),r=t.shift();s&&s.cond&&"decimal"==s.cond.params.format&&(r=a.format("text_decimal",r/10,{no_decimal_zero:!0})),i.value=r}else if(3==n)i.type="repeat",i.count=Math.max(1,t.shift()),i.items=ot(t,e,s),e+=i.items.length;else{if(4!=n)return null;{i.type="uptime",i.typeId=t.shift(),i.percent=Math.min(100,Math.max(0,t.shift())),i.conditions=[],i.features=[];let r=ot(t,e,s);e+=r.length;for(let t of r)"condition"==t.type?i.conditions.push(t):i.features.push(t)}}r.push(i)}return r}function ut(t){let e={};for(const s of t){"feature"==s.type&&(e[s.feature]=1);for(let t of["items","conditions","features"])if(s.hasOwnProperty(t)){let i=ut(s[t]);e=Object.assign(e,i)}}return e}function ct(t,e){for(let s of e){if(s.id==t)return s;for(let e of["items","conditions","features"])if(s.hasOwnProperty(e)){let i=ct(t,s[e]);if(i)return i}}return null}function ht(t,e){let s=e.indexOf(t);if(s>=0)return e.splice(s,1),1;for(let s of e)for(let e of["items","conditions","features"])if(s.hasOwnProperty(e)){if(ht(t,s[e]))return 1}return 0}class ft extends w{compile(t){return`Math.max(0, Math.min(1, ${super.compile(t)}))`}}class gt extends v{}class pt extends s{getType(){return"damage_result"}isCollapsable(){return!1}compile(t){return"["+this.compileChildrens(t).join(", ")+"]"}getSignature(){return null}}class dt extends k{getType(){return"damage_rotation_result"}makeResult(t){return t=Object.assign({},t),new i([...this.items,new pt(this.vars)])}}class mt{constructor(t){if(this.critChance=0,this.critMulti=1,t){let e=Object.keys(t);for(let s=0;s<e.length;++s){const i=e[s];this[i]=t[i]}}this.calcCritValues()}isHealing(){return this.icon&&"heal"==this.icon}calcCritValues(){void 0===this.average&&(this.normal?(this.crit=this.normal*this.critMulti,this.average=this.normal*(1-this.critChance)+this.crit*this.critChance):(this.normal=0,this.crit=0,this.average=0))}clone(){let t=Object.assign({},this);return Object.setPrototypeOf(t,mt.prototype),t}}class bt{constructor(t){this.name=t.name||(t.multipliers&&t.multipliers.length>0?t.multipliers[0].getName():""),this.isChild=t.isChild,this.hits=t.hits,this.icon=t.icon,this.tags=t.tags||[],this.multipliers=t.multipliers||[],this.category=t.category,this.condition=t.condition,this.element="",this.damageType="",this.rotationHitDescription=t.rotationHitDescription||"",this.rotationHitCount=t.rotationHitCount||1,this.critRateBonuses=t.critRateBonuses||[],this.critDamageBonuses=t.critDamageBonuses||[]}getDamageType(){return this.damageType}getElement(){return this.element}getName(){return this.category+"."+this.name}getIsChild(){return this.isChild}getHits(){return this.hits}getTags(){return this.tags}isRotation(){return!1}hasDetails(){return!1}canReact(){}usedInRotation(){return!1}isActive(t){return!this.condition||this.condition.isActive(t.settings)}compile(t){this.compiled=this.getCompiled(t)}getDisplaySettings(t){}getMultipliers(t){let e=[];for(let s of this.multipliers)s.isActive(t)&&e.push(s);for(let s of t.multipliers)s.isActive(t)&&s.isMatchFeature(this,t)&&e.push(s);return e}getActivePostEffectsTree(t){return t.getActivePostEffectsTree()}getCritRateBlock(t){let e=this.getStatsCritRate(t).map((e=>m(e,t.stats)));return 0==e.length&&(e=[new f({value:0})]),new ft(e)}getCritDmgBlock(t){let e=this.getStatsCritDamage(t).map((e=>m(e,t.stats)));return 0==e.length&&(e=[new f({value:0})]),new gt(e)}getCompiled(t,e){if(this.compiled)return this.compiled;e=Object.assign({dontProcessTree:1},e);let s=this.getTree(t),i=this.getActivePostEffectsTree(t),r=new T(s,i);return t.settings.reaction&&r.checkForReaction(),t.stats.ensure(r.usedStats),t.stats.ensure(r.assignedStats),r.prepare(t,e),r.compile(e),r}checkConditions(t){return!this.condition||this.condition.isActive(t.settings)}compile(t,e){let s=this.getTree(t);return this.compileTree(s,e)}compileTree(t,e){return e=Object.assign({},e),t.compile(e)}getResult(t){if(!this.checkConditions(t))return{};let e=this.getCompiled(t),[s,i,r]=e.execute(t);return{[this.getName()]:new mt({icon:this.icon||this.getElement(t),normal:s,crit:i,average:r,isReacted:e.isReacted,format:this.format,digits:this.digits,damageType:this.damageType,noCritValues:this.noCritValues})}}getUsedStats(e){let s=this.getTree(e),i=e.getActivePostEffectsTree(),r=new T(s,i);return e.stats.ensure(r.usedStats),r.prepare(e,{}),t(r.processed)}getRotationHitMiltiplier(t){return this.rotationHitCount}getDisplayRotationHitMiltiplier(t){return this.getRotationHitMiltiplier(t)}getRotationHitDescription(){return this.rotationHitDescription}static getTree(t){let e={};for(const s of Object.keys(t)){let i=s.split("."),r=i.shift(),n=i.join(".");void 0===e[r]&&(e[r]={}),e[r][n]=t[s]}return e}static buildDropdown(t,e){e=Object.assign({},e);let s=[],i=t.getFeaturesHash(t.getBuildData(),e),r=bt.getTree(i);for(let t of Object.keys(r)){s.push({isCaption:!0,value:"section_"+t,text:UI.Lang.get("feature_section."+t)});for(let e of Object.keys(r[t])){let i=r[t][e];if(i.hidden)continue;let n=t+"."+e,l="feature_"+n;i.title&&(l=i.title),l=UI.Lang.get(l),i.isChild&&(l=" "+l),s.push({value:n,text:l,isSubitem:!0,isChild:!!i.isChild})}}return s}}const yt=["","melt","vaporize","quicken"];class St{constructor(t,e){t=[].concat(t),this.infoBlock,t.length>0&&"info"==t[0].type&&(this.infoBlock=t.shift()),this.items=t,this.opts=Object.assign({},e)}getTree(t,e){let[s,i,r,n]=this.processBlock(this.items,t,{usedStats:e});return new dt(s,{vars:[new d({ref:i}),new d({ref:r}),new d({ref:n})]})}processBlock(t,e,s){let i=new I([new f({value:0})],{name:"total_normal"}),r=new I([new f({value:0})],{name:"total_crit"}),n=new I([new f({value:0})],{name:"total_average"}),l=[i,r,n],a=e.clone(),o=a.settings?a.settings.rotation_include:"",u=[],c=[],h=[];t=function(t){let e=[],s=[];for(let i of t)"feature"==i.type?e.push(i):"condition"==i.type?(s&&(e=e.concat(s),s=[]),e.push(i)):("repeat"==i.type||"uptime"==i.type)&&s.push(i);s&&(e=e.concat(s));return e}(t),this.opts.ignoreSideEffects||(s=kt(s));for(let e of t)if("feature"==e.type){a.settings.reaction=vt(e);let t=_t(e.feature,a);if(!t)continue;if(!t.usedInRotation())continue;if(o){let e=t.getElement(a),s=t.getDamageType();if(o!=e&&o!=s)continue}let l=t.getTree(a);It(l,s);let c=[new f({value:e.count,comment:"rotation_hit_count"}),new k(l.items)],h=t.getRotationHitMiltiplier(a);"object"==typeof h?c.push(h):1!=h&&c.push(new f({value:h,comment:"rotation_hit_multi"}));let g=new I([new k(c)],{name:"normal"}),p=new I([l.critRate],{name:"crit_rate"}),m=new I([l.critDmg],{name:"crit_dmg"}),b=new I([new k([new d({ref:g}),new d({ref:m})])],{name:"crit_hit"}),y=[];l.royalCrit&&([y,p]=S(p,l.royalCrit)),y.length>0&&(u=u.concat(y)),u.push(g),u.push(p),u.push(m),u.push(b),u.push(new B([new d({ref:g})],{ref:i})),u.push(new B([new d({ref:b})],{ref:r})),u.push(new B([new k([new d({ref:g}),new _([new f({value:1}),new d({ref:p})])]),new k([new d({ref:b}),new d({ref:p})])],{ref:n}))}else if("condition"==e.type){if(u.length||c.length||h.length){let t=wt(u,c,h,s);t&&l.push(t),u=[],c=[],h=[]}for(let t of Object.keys(e.stats)){if(/^text_/.test(t))continue;let i={stat:t};if(s.copyStats){let e=Ct(s,t),r=jt(t);i={stat:e,newName:r},s.stats[t]=r}c.push(new D([new f({value:e.stats.get(t)})],i))}s.usedStats&&e.stats.truncate(s.usedStats),a.addStats(e.stats),a.addSettings(e.settings);let t=s&&s.stats?Object.keys(s.stats):[];for(let i of e.postEffects)if(i.getTree)for(let e of i.getTree(a,s))t.includes(e.stat)&&(e.stat=s.stats[e.stat]),It(e,s),h.push(e)}else if("repeat"==e.type){if(u.length||c.length||h.length){let t=wt(u,c,h,s);t&&l.push(t),u=[],c=[],h=[]}let[t,o,g,p]=this.processBlock(e.items,a,kt(s));u.push(wt([...t,...[[o,i],[g,r],[p,n]].map((t=>{let[s,i]=t;return new B([new k([new f({value:e.count}),new d({ref:s})])],{ref:i})}))],[],[],s))}else if("uptime"==e.type){if(u.length||c.length||h.length){let t=wt(u,c,h,s);t&&l.push(t),u=[],c=[],h=[]}if(e.percent>0){let t=e.percent/100,[l,o,c,h]=this.processBlock([...e.conditions,...e.items],a,kt(s));u.push(wt([...l,...[[o,i],[c,r],[h,n]].map((e=>{let[s,i]=e;return new B([new k([new f({value:t}),new d({ref:s})])],{ref:i})}))],[],[],s))}if(e.percent<100){let t=1-e.percent/100,[l,o,c,h]=this.processBlock(e.items,a,kt(s));u.push(wt([...l,...[[o,i],[c,r],[h,n]].map((e=>{let[s,i]=e;return new B([new k([new f({value:t}),new d({ref:s})])],{ref:i})}))],[],[],s))}}if(u.length||c.length||h.length){let t=wt(u,c,h,s);t&&l.push(t)}return[l,i,r,n]}}function wt(e,s,i,r){if(0==e.length&&0==s.length)return null;let n=t(...e),l=e,a=T.filterPostByStats(i,n);if(a.length){let[t,e]=T.postTreeBlocks(a);l=[...t,new A(l),...e]}return s.length&&(l=[...s,...l]),new A(l)}function vt(t){return yt[t.reaction||0]}function _t(t,e){t=Array.isArray(t)?t:[t];for(let s of t)if(s.isActive(e)&&s.usedInRotation())return s}function kt(t){let e=Object.assign({},t);if(e.stats={},e.copyStats=!0,t.stats)for(let s of Object.keys(t.stats))e.stats[s]=t.stats[s];return e}function Ct(t,e){return t.stats&&t.stats[e]||e}function jt(t){return y(t)}function It(t,e){if(e.stats){let s=Object.keys(e.stats);t.walk((t=>{if("item_stat_total"==t.getType())for(let i of[t.stat,t.stat+"_base",t.stat+"_percent"])s.includes(i)&&(t.replace||(t.replace={}),t.replace[i]=e.stats[i]);else t.stat&&s.includes(t.stat)&&(t.stat=e.stats[t.stat])}))}}class Bt extends bt{constructor(t){super(t),this.items=t.items}getName(){return"rotation.total"}getTree(t,e){return new St(this.items,e).getTree(t)}compile(t,e){let s=this.getTree(t,e);return this.compileTree(s,e)}compileTree(t,e){return e=Object.assign({},e),t.compile(e)}getResult(t){if(!this.checkConditions(t))return{};let e=this.getCompiled(t),[s,i,r]=e.execute(t),n=this.getElement(t);return t.settings&&t.settings.rotation_include&&(n=t.settings.rotation_include),{[this.getName()]:new mt({icon:n,normal:s,crit:i,average:r})}}getResultForEditor(t){let e=t.getBuildData();return this.processBlock(this.items,e)}processBlock(t,e){let s=[];for(let i of t)if("feature"==i.type){e.settings.reaction=vt(i);let t=Ot(i.feature,e);if(t){let r=t.getResult(e)[t.getName()];s.push({result:r,count:i.count,subLine:At(i.feature,e)})}else s.push({})}else if("condition"==i.type)i.settings&&e.addSettings(i.settings),i.stats&&e.addStats(i.stats),i.postEffects&&i.postEffects.length&&(e.postEffects=i.postEffects),i.multipliers&&i.multipliers.length&&(e.multipliers=i.multipliers);else if("repeat"==i.type){let t=e.clone();t.addSettings({inside_rotation_block:1});let r=this.processBlock(i.items,t);s=s.concat(r)}else if("uptime"==i.type){let t=e.clone();t.addSettings({inside_rotation_block:1});let r=t.clone(),n=this.processBlock(i.items,t),l=this.processBlock(i.conditions.concat(i.items),r),a=i.percent/100,o=1-a;for(let t=0;t<n.length;++t){let e=n[t].result,s=l[t].result;if(e||s){s?e||(n[t]=Object.assign({},l[t]),e=n[t].result={normal:0,crit:0,average:0}):s={normal:0,crit:0,average:0};for(let t of["normal","crit","average"])e[t]=e[t]*o+s[t]*a}}s=s.concat(n)}else"invalid"==i.type&&s.push({});return s}getDisplaySettings(t){let e={},s={},i=[{settings:{rotation_include:null},setTotal:1,icon:"multi"}];!function t(e,s,i,r){let n=s.clone();for(let s of e)if("feature"==s.type){let t=Ot(s.feature,n);t&&(i[t.getElement(n)]=1,r[t.getDamageType()]=1)}else"condition"==s.type?(s.settings&&n.addSettings(s.settings),s.stats&&n.addStats(s.stats)):"repeat"==s.type?t(s.items,n,i,r):"uptime"==s.type&&(t(s.items,n,i,r),t([...s.conditions,...s.items],n,i,r))}(this.items,t,e,s);for(let t of Object.keys(e))i.push({id:"rotation.total_"+t,title:"rotation."+t,isChild:!0,settings:{rotation_include:t},getTotal:1});for(let t of Object.keys(s))i.push({id:"rotation.total_"+t,title:"rotation."+t,icon:"multi",isChild:!0,settings:{rotation_include:t},getTotal:1});return i}}function Ot(t,e){t=Array.isArray(t)?t:[t];for(let s of t)if(s.isActive(e)&&s.usedInRotation())return s}function At(t,e){let s=Ot(t,e),i=s.getRotationHitDescription(e);if(i)return{descr:"talent_descr."+i,value:s.getDisplayRotationHitMiltiplier(e)}}class Dt{constructor(t,e,s){this.build=t,this.rotation=e,this.opts=Object.assign({},s)}buildFeaturesList(){let t={},e=this.rotation.getfeaturesNames();for(let t of Object.keys(nt))e.push(nt[t]);for(let s of e){let e=this.build.getAllFeaturesByName(s,{ignoreRotation:!0});e.length&&(t[s]=e)}if(this.opts.loadArtifactsFeatures){let e=this.build.getBuildData();for(let s of DB.Artifacts.Sets.getList())for(let i of s.getFeatures(5)){let s=i.getResult(e.stats,e.settings);for(let e of Object.keys(s))t[e]=i}}return t}processConditions(t){if(0==this.conditions.length)return;let e=t.getBuildData(),s={},i=0;for(const r of this.conditions){let n,l={};if(r.static)l=r.getSettings(e.settings),n=r.object,++i;else{let e=lt.getConditionData(r,t);if(!e.invalid&&e.cond&&e.cond.getName()&&Pt.includes(e.object)){++i,n=e.object;let t=e.cond.getType();l[e.cond.getName()]="dropdown"==t||"dropdown_multiple"==t?e.cond.getValueById(r.value):r.value}}n&&(s=Object.assign(s,l),t[n].addSettings(l),t.setCommonSettings(l))}if(this.conditions=[],!i)return;let r=t.getBuildData(),n=r.getActivePostEffects(),l=a.diff(e.stats,r.stats),o=function(t,e){let s={};for(let i of Object.keys(e))void 0!==t[i]&&t[i]==e[i]||(s[i]=e[i]);for(let i of Object.keys(t))void 0===e[i]&&(s[i]=void 0);return s}(e.settings,r.settings);return Object.keys(l).length||Object.keys(o).length||n.length?{type:"condition",stats:l,settings:o,postEffects:n}:void 0}processBlock(t,e,s){let i=[],r=[],n=e.filter((t=>!t.disabled));n.length&&"condition"!=n[0].type&&r.push({type:"condition",static:1,getSettings:()=>({})});for(const t of e)if(r.push(t),"feature"==t.type&&this.features[t.feature])for(let e of this.features[t.feature])if(e&&e.getRotationAfterItems){let i=e.getRotationAfterItems(t,{insideBlock:s});for(const t of i)r.push(t)}for(const e of r)if(!e.disabled){if("condition"!=e.type){let e=this.processConditions(t);e&&i.push(e)}if("feature"==e.type){let t=this.features[e.feature];if(t){++this.featuresTotal;let s={type:e.type,feature:t,featureName:e.feature,count:e.count,reaction:e.reaction};i.push(s)}else i.push({type:"invalid"})}else if("condition"==e.type)this.conditions.push(e);else if("repeat"==e.type){let s=this.processBlock(t,e.items,1);s&&i.push({type:e.type,count:e.count,items:s})}else if("uptime"==e.type){let s=this.processBlock(t,e.features,1);if(!s)continue;let r=this.processBlock(t,e.conditions,1);0==r.length?i.push({type:"repeat",count:1,items:s}):i.push({type:e.type,percent:e.percent,conditions:r,items:s})}}let l=this.processConditions(t);return l&&i.push(l),i}buildInfoBlock(){let t={type:"info"},e=0;if(this.sideEffectStats.length&&(e=1,t.sideEffectStats=this.sideEffectStats),e)return t}compile(){this.features=this.buildFeaturesList(),this.featuresTotal=0,this.conditions=[],this.sideEffectStats=[];let t=[].concat(this.rotation.getItems());t.unshift({type:"condition",static:1,getSettings:()=>({})});let e=this.processBlock(this.build.cloneWithArtifactSettings(),t);if(0==this.featuresTotal)return null;let s=this.buildInfoBlock();return s&&e.unshift(s),new Bt({name:this.rotation.name,items:e})}}class zt extends W{constructor(){super(),this.object=new lt}set(t){this.object=t?t.clone():new lt}isBeta(){return!1}getConditions(){return[]}getFeatures(){return[]}getPostEffects(){return[]}getSettings(){return[]}getMultipliers(){return[]}serialize(){return this.object.serialize()}static deserialize(t){if(0==t.length)return new zt;let e=lt.deserialize(t),s=new zt;return s.set(e),s}}class Tt extends W{isBeta(){return!1}getSettings(){return{}}getStats(t){return{stats:new a,settings:new M({})}}getConditions(){return[]}getFeatures(){return DB.Features.Stats}getPostEffects(){return[]}}class Rt extends W{constructor(){super(),this.levels={level:1,ascension:0,refine:1}}setLevels(t){this.levels.level=t.level,this.levels.ascension=t.ascension,this.levels.refine=Math.min(5,Math.max(1,t.refine))}getStats(){var t=super.getStats();if(this.object&&this.object.refineTable)for(let e of this.object.refineTable)t.stats.add(e.getName(),e.getValue(this.levels.refine));return t}getSettings(){let t=super.getSettings(),e={weapon_level:this.levels.level,weapon_ascension:this.levels.ascension,weapon_refine:this.levels.refine};return this.object&&(e.weapon_id=this.object.getId(),e.weapon_type=this.object.weapon),t=Object.assign(t,e),t}getId(){return this.object?this.object.getId():0}getName(){return this.object?this.object.getName():""}getConditions(){let t=super.getConditions();return t=t.concat(DB.Conditions.Weapon),t}serialize(t){let e=[];if(!this.object)return null;e.push(this.object.getId()),e.push(this.levels.level,this.levels.ascension,this.levels.refine);let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=DB.Weapons.getById(t.shift());if(!e)return null;let s=t.shift();if(s<1||s>90)return null;let i=t.shift();if(i<0||i>6)return null;let r=t.shift();if(r<0||r>5)return null;let n=new Rt;n.set(e),n.setLevels({level:s,ascension:i,refine:r||1});let l=n.deserializeConditions(t);return l?(n.setSettings(l),n):null}}const Pt=["char","weapon","artifacts","enemy","buffs","rotation","food","reaction","static"],xt=["char","weapon","artifacts","enemy","buffs","rotation","food"];class Mt{constructor(){this.char=new tt,this.weapon=new Rt,this.artifacts=new q,this.enemy=new et,this.buffs=new X,this.rotation=new zt,this.food=new it,this.reaction=new rt,this.static=new Tt}getChar(){return this.char}setChar(t){let e=this.getCommonSettings("char");this.char.set(t);let s="";this.weapon.object&&(s=this.weapon.object.weapon),s!=t.weapon&&this.setWeapon(DB.Weapons.get(t.weapon).getFirst());let i=this.buffs.getPartyChars();this.buffs.setPartyChars(i.filter((e=>e!=t.getId()))),this.setCharSettings(e)}setCharLevels(t){this.char.setLevels(t)}setCharSkills(t){this.char.setSkills(t)}setCharSettings(t){this.char.setSettings(t),this.setCommonSettings(t)}getWeapon(){return this.weapon}setWeapon(t){let e=this.getCommonSettings("weapon");this.weapon.set(t),this.setWeaponSettings(e)}setWeaponLevels(t){this.weapon.setLevels(t)}setWeaponSettings(t){this.weapon.setSettings(t),this.setCommonSettings(t)}setEnemy(t){this.enemy.set(t)}setEnemyLevels(t){this.enemy.setLevels(t)}setEnemyResistances(t){this.enemy.setResistances(t)}setEnemySettings(t){this.enemy.setSettings(t),this.setCommonSettings(t)}getEnemy(){return this.enemy}setArtifact(t){this.artifacts.set(t)}replaceArtifacts(t){this.artifacts.replace(t)}getArtifacts(){return this.artifacts.get()}getArtifactsHashList(){let t=[],e=this.getArtifacts();return Object.keys(e).forEach((function(s){let i=e[s];i&&t.push(i.getHash())})),t}removeArtifact(t){this.artifacts.remove(t)}clearArtifacts(){this.artifacts.clearArtifacts()}setArtifactsSettings(t){this.artifacts.setSettings(t),this.setCommonSettings(t)}isEquipped(t){return this.artifacts.isEquipped(t)}getBuffs(){return this.buffs.get()}setBuffsSettings(t){this.buffs.setSettings(t),this.setCommonSettings(t)}modifyBuffsSettings(t){let e=this.buffs.modifySettings(t);this.setCommonSettings(e)}setPartyChars(t){this.buffs.setPartyChars(t)}getPartyChars(){return this.buffs.getPartyChars()}setRotation(t){this.rotation.set(t)}getRotation(){return this.rotation.get()}setFood(t,e,s){return this.food.set(t,e,s)}getFood(t){return this.food.get(t)}getFoodLevel(t){return this.food.getLevel(t)}hasBetaContent(){for(let t of Pt)if(this[t]&&this[t].isBeta())return!0;return!1}refreshCommonSettings(){let t=this.getSettings();for(let e of Pt){if(!this[e])continue;let s=this[e].getSettings(),i=this.getActiveConditions(t,{objects:[e]});K.setCommonValues(s,i),this[e].setSettings(s)}}getCommonSettings(t){let e=this.getSettings(),s=this[t].getSettings();for(let t of Object.keys(e))/^common\./.test(t)&&(s[t]=e[t]);return s}setCommonSettings(t){let e=[];for(const s of Object.keys(t))/^common\./.test(s)&&e.push(s);if(0!=e.length)for(let s of Pt){if(!this[s])continue;let i=this[s].getSettings();for(const s of Object.keys(i))e.includes(s)&&(i[s]=t[s]);this[s].setSettings(i)}}getConditions(t){let e=[],s=Pt;for(let i=0;i<s.length;++i){let r=s[i];this[r]&&(t&&t.objects&&!t.objects.includes(r)||(e=e.concat(this[r].getConditions())))}return e}getActiveConditions(t,e){let s=[],i=Pt;for(let r=0;r<i.length;++r){let n=i[r];if(!this[n])continue;if(e&&e.objects&&!e.objects.includes(n))continue;let l=this[n].getConditions();for(let e=0;e<l.length;++e){const i=l[e];i.params.hideInactive&&!i.checkSubconditions(t)||s.push(i)}}return s}getArtifactsConditions(){return this.artifacts?this.artifacts.getConditions():[]}getSettings(){let t={},e=Pt;for(let s=0;s<e.length;++s){let i=e[s];this[i]&&(t=Object.assign(t,this[i].getSettings()))}return t}getBaseStats(t,e){let s=new F;t&&s.stats.concat(t),s.settings.concat(this.getSettings(),e);let i=Pt;for(let t=0;t<i.length;++t){let e=i[t];if(!this[e])continue;let r=this[e].getConditions();for(let t=0;t<r.length;++t){let e=r[t].getData(s.settings);s.stats.concat(e.stats),s.settings.concat(s.settings,e.settings)}}for(let t=0;t<i.length;++t){let e=i[t];if(!this[e])continue;let r=this[e].getStats(s.settings);s.stats.concat(r.stats),s.settings.concat(s.settings,r.settings)}return s.stats.get("dmg_own")&&s.stats.add("dmg_"+s.settings.char_element,s.stats.get("dmg_own")),s.multipliers=this.getMultipliers(),s.postEffects=this.getPostEffects(),s}getBaseStatsWithSets(t,e){let s=this.getBaseStats(t,e),i=this.getPostEffects();return s.stats.applyPostEffects(s.settings,i,x),s}getPostEffects(){let t=[],e=Pt;for(let s=0;s<e.length;++s){let i=e[s];this[i]&&(t=t.concat(this[i].getPostEffects()))}return t}getMultipliers(){let t=[];for(let e of Pt)this[e]&&(t=t.concat(this[e].getMultipliers()));return t=t.concat(DB.CalcData.Multipliers),t}getStats(t,e){return this.getBaseStats(t,e)}getBuildData(t,e){let s=this.getBaseStats(t,e);return s.stats.processPercent(),s}calcFeatures(t){let e=this.getBuildData();return this.getFeatures(e,t)}getFeaturesList(t){let e=[];t=Object.assign({},t);for(let s of Pt){if(!this[s])continue;let i;if("rotation"==s){if(!t.ignoreRotation){let t=this.compileRotation();t&&(i=[t])}}else i=this[s].getFeatures();i&&(e=e.concat(i))}return e}compileRotation(){return new Dt(this,this.getRotation()).compile()}getFeaturesHash(t,e){e=Object.assign({},e);let s={};for(let i of this.getFeaturesList())t&&!i.checkConditions(t)||e.checkCallback&&!e.checkCallback(i)||(s[i.getName()]=i);return s}getFeatures(t){let e={};for(let s of this.getFeaturesList())e=Object.assign(e,s.getResult(t));return e}getFeaturesNames(){let t={},e=this.getStats(),s=this.getFeaturesList();for(let i=0;i<s.length;++i){const r=s[i];Object.assign(t,r.getFeatureNamesHash(e.stats,e.settings))}return t}getFeatureResultByName(t){let e=this.getFeatureByName(t);if(!e)return;let s=this.getBuildData();return e.getResult(s)[t]}getFeatureByName(t,e){if(!t)return null;e||=this.getBuildData();for(let s of this.getFeaturesList())if(s.isActive(e)&&t==s.getName())return s;return null}getAllFeaturesByName(t,e){if(!t)return[];let s=[];for(let i of this.getFeaturesList(e))t==i.getName()&&s.push(i);return s}clone(){return Mt.deserialize(this.serialize())}cloneWithArtifactSettings(){let t=Mt.deserialize(this.serialize());return t.artifacts.modifySettings(this.artifacts.getSettings()),t}getHash(){return N.pack(this)}serialize(){let t=[1],e=this.getSettings();for(let t of Pt)if(this[t])for(let s of this[t].getConditions()){let t=s.getData(e);Object.assign(e,t.settings)}for(let s of xt){if(!this[s])return null;let i=this[s].serialize(e);if(!i)return null;t=t.concat(i)}return t}static deserialize(t){let e=null;if(1==t.shift()){if(e=new Mt,e.char=tt.deserialize(t),!e.char)return null;if(e.weapon=Rt.deserialize(t),!e.weapon)return null;if(e.artifacts=q.deserialize(t),!e.artifacts)return null;if(e.enemy=et.deserialize(t),!e.enemy)return null;if(e.buffs=X.deserialize(t),!e.buffs)return null;if(e.rotation=zt.deserialize(t),!e.rotation)return null;if(e.food=it.deserialize(t),!e.food)return null}return e}}class Et{constructor(t){this.build=t.build,this.combinations=t.combinations,this.featureName=t.feature,this.settings=t.settings,this.progressCallback=t.progressCallback,this.prepare()}prepare(){this.applySets();let t=this.build.getFeatureByName(this.featureName);this.buildData=this.build.getBuildData();let e=this.buildData.getActivePostEffectsTree(),s=t.getTree(this.buildData),i=new T(s,e),r=i.usedStats,n=["recharge"].concat(r);this.buildData.stats.ensure(n),r.includes("crit_value")&&(this.calcCritValue=!0,r.push("crit_rate"),r.push("crit_dmg")),i.prepare(this.buildData),i.compile(),this.compiled=i,this.usefulStats=[],this.uselessStats=[],this.statRolls=function(t){let e={};for(let s of DB.Artifacts.Substats.getKeys()){let i=DB.Artifacts.Substats.get(s).rolls[4];if(e[s]="min"==t?[i[0]]:"max"==t?[i[i.length-1]]:[i[1],i[2]],h(s))for(let t=0;t<e[s].length;++t)e[s][t]=e[s][t]/100}return e}(this.settings.mode);for(let t of DB.Artifacts.Substats.getKeys())r.includes(t)?this.usefulStats.push(t):this.uselessStats.push(t);this.progressTotal=this.combinations.length*this.usefulStats.length,this.progressCurrent=0}setsList(){let t=Array.isArray(this.settings.sets)?[].concat(this.settings.sets):[];if(t.length<5){let e=[];for(let t of DB.Artifacts.Sets.getList())t.isBeta()||e.push(t.key);for(let s of Vt(e)){if(t.includes(s))continue;if(!(DB.Artifacts.Sets.get(s).maxRarity<5)&&(t.push(s),t.length>=5))break}}return Vt(t)}applySets(){let t=this.setsList();this.artifactSets=[].concat(t),this.build.clearArtifacts();let e=["hp","atk"];for(let s of DB.Artifacts.Slots.getKeys()){let i=new G(5,20,s,t.shift()||"",e.shift()||"",[]);this.build.setArtifact(i)}let s=this.build.getConditions({objects:"artifacts"}),i=K.allConditionsOn(s);this.settings.required_sets_settings&&(i=Object.assign(i,this.settings.required_sets_settings)),this.build.setArtifactsSettings(i)}makeTestObject(t,e){let s=new Ft(t,this.usefulStats,this.usefulStats,this.statRolls,this.settings);if(s.satisfyStat("recharge",this.minRecharge,e))return s}makeObject(t,e){return new Ft(t,this.usefulStats,this.uselessStats,this.statRolls,this.settings)}generate(){let t=[],e=this.buildData.stats.getSetFunc();this.minRecharge=this.settings.minRecharge/100;for(let s of this.combinations){let i,r=Lt(s),n=0;for(let t of this.usefulStats){let l=new a,o=this.usefulStats.length-1;e(l),r(l);let u=this.makeTestObject(s,l);if(!u){this.updateProgress();continue}let c=u.getStatRollsAllowed(t);for(let l=1;l<=c;++l){let u=new a;e(u),r(u);let c,h=this.makeObject(s,u);h.satisfyStat("recharge",this.minRecharge,u);for(let e=0;e<l;e++){let e=h.addRoll(t);u.add(t,e)}if(o>0)for(;;){let e,s=h.getAllowedRolls(t);if(0==s.length)break;if([e,c]=this.getBestRoll(u,s),!e)break;let i=h.addRoll(e);u.add(e,i)}else this.buildData.stats=u,c=this.compiled.execute(this.buildData)[2];c>n&&(n=c,i=h)}this.updateProgress()}i&&t.push({value:n,mainStats:s,rollsPerStat:i.getDistribution(),artifacts:i.makeArtifacts(this.setsList())})}return t.sort(((t,e)=>e.value-t.value))}getBestRoll(t,e){let s,i=0;for(let r of e){t.add(r.stat,r.value),this.calcCritValue&&t.set("crit_value",2*t.get("crit_rate")+t.get("crit_dmg")),this.buildData.stats=t;let e=this.compiled.execute(this.buildData)[2];e>i&&(i=e,s=r.stat),t.add(r.stat,-1*r.value)}return[s,i]}updateProgress(){++this.progressCurrent,this.progressCallback&&this.progressCallback({total:this.progressTotal,completed:this.progressCurrent})}}class Ft{constructor(t,e,s,i,r){this.mainStats={flower:"hp",plume:"atk",...t},this.usefulStats=e,this.uselessStats=s,this.rollsCnt=0,this.rolls={},this.statValues=i,this.stats=new a,this.settings=r}getMainStatsCnt(t){let e=0;for(let s of Object.values(this.mainStats))t==s&&++e;return e}getStatMaxAllowed(t){let e=this.settings.count,s=45,i=6*(5-this.getMainStatsCnt(t));return"crit_rate"!=t&&"crit_dmg"!=t||(s=this.settings.critRolls),Math.min(e,s,i)}getStatRollsAllowed(t){let e=0;return"crit_rate"==t||"crit_dmg"==t?(e+=this.rolls.crit_rate?this.rolls.crit_rate.length:0,e+=this.rolls.crit_dmg?this.rolls.crit_dmg.length:0):e=this.rolls[t]?this.rolls[t].length:0,this.getStatMaxAllowed(t)-e}getAllowedRolls(t){let e=[];if(this.rollsCnt>=this.settings.count)return e;let s=0;for(let t of Object.keys(this.rolls)){let e=this.rolls[t].length;for(let s of Object.values(this.mainStats))t!=s&&--e;s+=Math.max(0,e)}for(let i of DB.Artifacts.Substats.getKeys()){if(t&&t==i)continue;if(!this.usefulStats.includes(i))continue;if(s>=25&&this.rolls[i])continue;let r=this.getRollValue(i);this.getStatRollsAllowed(i)>0&&e.push({stat:i,value:r})}return e}getRollValue(t){let e=this.statValues[t].length;if(e>1){let s=(1+(this.rolls[t]?this.rolls[t].length:0))%e;return this.statValues[t][s]}return this.statValues[t][0]}satisfyStat(t,e,s){let i=s.getTotal(t);for(;i-e<-.001;){if(this.getStatRollsAllowed(t)<=0)return!1;let e=this.addRoll(t);i+=e,s.add(t,e)}return!0}addRoll(t){let e=this.getRollValue(t);return this.rolls[t]||(this.rolls[t]=[]),this.rolls[t].push(e),++this.rollsCnt,this.stats.add(t,e),e}getDistribution(){let t={};for(let[e,s]of Object.entries(this.rolls))t[e]=s.length;return t}getDistibutor(){return new Nt(this.mainStats,this.rolls)}makeArtifacts(t){let e=[],s=this.getDistibutor();s.process(),s.fillUselessStats(this.uselessStats,this.statValues);for(let i of Object.keys(this.mainStats)){let r=new G(5,20,i,t.shift(),this.mainStats[i],[]);for(let[t,e]of Object.entries(s.result[i])){let s=e.reduce(((t,e)=>t+e));h(t)?(s=Math.round(1e4*s)/100,s=Math.round(10*s)/10,s=parseFloat(s.toFixed(1))):s=Math.round(s),r.addStat(t,s)}e.push(r)}return e}}class Nt{constructor(t,e){this.mainStats=t,this.rolls={};for(let t of Object.keys(e))this.rolls[t]=[].concat(e[t]);this.prepare(),this.result={plume:{},flower:{},sands:{},goblet:{},circlet:{}},this.rollsCount={plume:0,flower:0,sands:0,goblet:0,circlet:0},this.upgradesCount={plume:0,flower:0,sands:0,goblet:0,circlet:0}}prepare(){this.possibleStatSlots={};for(let t of Object.keys(this.rolls)){this.possibleStatSlots[t]=[];for(let e of Object.keys(this.mainStats))this.mainStats[e]!=t&&this.possibleStatSlots[t].push(e)}}process(){this.lowCounters();let t={};for(let e of Object.keys(this.rolls)){let s=Object.values(this.mainStats).reduce(((t,s)=>t+(e==s?0:1)),0);t[s]||(t[s]=[]),t[s].push(e)}for(let e of Object.keys(t).sort(((t,e)=>t-e))){let s=t[e];for(;0!=s.length;)for(let t of s){let e=this.rolls[t].splice(0,1);this.putIntoLowestCount(t,e),0==this.rolls[t].length&&(delete this.rolls[t],s.splice(s.indexOf(t),1))}}this.balanceUpgrades()}balanceUpgrades(){if(Object.values(this.upgradesCount).reduce(((t,e)=>t+e),0)<=25)return;let t=1,e=0;for(;t&&!(++e>10);){t=0;t:for(let e of Object.keys(this.mainStats))if(!(this.upgradesCount[e]<=5))for(let s of Object.keys(this.result[e]))if(1!=this.result[e][s].length)for(let i of Object.keys(this.mainStats)){if(e==i)continue;if(s==this.mainStats[i])continue;if(this.result[i][s])continue;if(Object.keys(this.result[i]).length>=4)continue;let r=this.result[e][s].pop();this.result[i][s]=[r],--this.upgradesCount[e],t=1;break t}}for(e=0,t=1;t&&!(++e>10);){t=0;t:for(let e of Object.keys(this.mainStats))if(!(this.upgradesCount[e]<=5))for(let s of Object.keys(this.result[e]))if(1!=this.result[e][s].length)for(let i of Object.keys(this.mainStats)){if(e==i)continue;if(s==this.mainStats[i])continue;if(!this.result[i][s])continue;if(this.upgradesCount[i]>=5)continue;let r=this.result[e][s].pop();this.result[i][s].push(r),--this.upgradesCount[e],++this.upgradesCount[i],t=1;break t}}}fillUselessStats(t,e){for(let[s,i]of Object.entries(this.mainStats)){let r=Vt([].concat(t)).filter((t=>t!=i)),n=[];for(;Object.keys(this.result[s]).length<4;){let t=r.pop();if(!t)break;n.push(t),this.putIntoSlot(s,t,e[t][0])}if(0!=n.length)for(;this.upgradesCount[s]<5;)for(let t of n)if(this.putIntoSlot(s,t,e[t][0]),this.upgradesCount[s]>=5)break}}lowCounters(){for(let t of Object.keys(this.rolls))this.rolls[t].length>2||(this.putIntoLowestDifferent(t,this.rolls[t]),delete this.rolls[t])}putIntoLowestCount(t,e){let s=[];for(let[e,i]of Object.entries(this.mainStats))t!=i&&(Object.keys(this.result[e]).length>=4&&!this.result[e][t]||this.result[e][t]&&this.upgradesCount[e]>=5||s.push({slot:e,used:this.upgradesCount[e]+Object.values(this.result[e]).length-(this.result[e][t]?0:2)}));if(0==s.length)for(let[e,i]of Object.entries(this.mainStats))t!=i&&this.result[e][t]&&s.push({slot:e,used:this.upgradesCount[e]});s=s.sort(((t,e)=>t.used-e.used)),this.putIntoSlot(s[0].slot,t,e)}putIntoLowestDifferent(t,e){let s=[];for(let[e,i]of Object.entries(this.mainStats))t!=i&&(Object.keys(this.result[e])>=4&&!this.result[e][t]||s.push({slot:e,used:Object.values(this.result[e]).length}));s=s.sort(((t,e)=>t.used-e.used)),this.putIntoSlot(s[0].slot,t,e)}putIntoSlot(t,e,s){this.result[t][e]||(Object.keys(this.result[t]).length,this.result[t][e]=[]),this.result[t][e]=this.result[t][e].concat(s),this.rollsCount[t]+=s.length,this.refreshUpgrages(t)}refreshUpgrages(t){let e=0;for(let[s,i]of Object.entries(this.result[t]))e+=i.length-1;this.upgradesCount[t]=e}}function Lt(t){let e=new a;for(let s of Object.keys(t)){let i=t[s],r=DB.Artifacts.Mainstats.get(i).values[4].getValue(20);h(i)&&(r/=100),e.add(i,r)}return e.getConcatFunc()}function Vt(t){let e,s=[].concat(t),i=s.length;for(;0!=i;)e=Math.floor(Math.random()*i),i--,[s[i],s[e]]=[s[e],s[i]];return s}class Ut extends Et{makeTestObject(t,e){let s=new Ht(t,this.usefulStats,this.usefulStats,this.statRolls,this.settings);for(let t of DB.Artifacts.Substats.getKeys())for(let i=1;i<=2;++i){let i=s.addRoll(t);e.add(t,i)}if(s.satisfyStat("recharge",this.minRecharge,e))return s}makeObject(t,e){let s=new Ht(t,this.usefulStats,this.uselessStats,this.statRolls,this.settings);for(let t of DB.Artifacts.Substats.getKeys())for(let i=1;i<=2;++i){let i=s.addRoll(t);e.add(t,i)}return s}}class Ht extends Ft{constructor(t,e,s,i,r){(r=Object.assign({},r)).count=40,r.critRolls=40,super(t,e,s,i,r)}getStatMaxAllowed(t){let e=2+2*(5-this.getMainStatsCnt(t));return Math.min(40,e)}getStatRollsAllowed(t){let e=this.rolls[t]?this.rolls[t].length:0;return this.getStatMaxAllowed(t)-e}getDistibutor(){return new Gt(this.mainStats,this.rolls)}}class Gt extends Nt{fillUselessStats(){}process(){for(let t of Object.keys(this.rolls)){let e=this.rolls[t].splice(0,1);this.putIntoLowestCount(t,e),0==this.rolls[t].length&&delete this.rolls[t]}let t={};for(let e of Object.keys(this.rolls)){let s=Object.values(this.mainStats).reduce(((t,s)=>t+(e==s?0:1)),0);t[s]||(t[s]=[]),t[s].push(e)}let e={};for(let t of Object.keys(this.rolls))e[t]=this.rolls[t].length;for(let t of Object.keys(e).sort(((t,s)=>e[s]-e[t])))for(;this.rolls[t]&&this.rolls[t].length>0;){let e=this.rolls[t].splice(0,1);this.putIntoLowestCount(t,e),0==this.rolls[t].length&&delete this.rolls[t]}}}importScripts("db.js?3.1.3b"),self.onmessage=function(t){let e;t.data.build=Mt.deserialize(t.data.build),t.data.progressCallback=t=>{self.postMessage({progress:t})},e=t.data.settings.kqms?new Ut(t.data):new Et(t.data);let s=e.generate();for(let t of s){let e=[];for(let s of t.artifacts)e.push(s.serialize());t.artifacts=e}self.postMessage({result:s})}})();