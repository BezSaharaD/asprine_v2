(()=>{"use strict";class t{static pack(t){let s=t.serialize(),i="";if(s){for(const t of s)i+=e(t);return i}}static unpack(t){let e=t.split(""),s=[],i=0;for(;e.length>0;){let t=e.shift();"\0"==t&&(t="b");let n=t.toUpperCase().charCodeAt(0)-65;if(n<0&&n>25)return null;i+=n,t.toLowerCase()==t?(s.push(i),i=0):i*=26}return i&&s.push(i),s}}function e(t){let e=parseInt(t),s="";for(;e>25;){let t=e%26;e-=t,e/=26,s=String.fromCharCode(65+t)+s}s=String.fromCharCode(65+e)+s;let i=s.substring(s.length-1);return s.substring(0,s.length-1).toUpperCase()+i.toLowerCase()}const s=new Map;new Map;class i{constructor(t){if(t){const e=Object.keys(t);for(let s=0;s<e.length;s++)this[e[s]]=t[e[s]]}}add(t,e){this[t]=(this[t]||0)+e}set(t,e){this[t]=e}get(t){return this[t]||0}del(t){delete this[t]}isSet(t){return this.hasOwnProperty(t)}getTotal(t){const e=this[t+"_base"]||0;let s=this[t]||0;const i=this[t+"_percent"]||0;return i&&e&&(s+=e*(i/100)),e+s}getTotalPercent(t){return(this[t+"_base"]||0)*(1+(this[t+"_percent"]||0))+(this[t]||0)}getBaseBonus(t){let e=this["base_dmg_bonus_"+t]||0,s=this[t+"_base_atk_percent"];return s&&(e+=this.getTotal("atk")*s/100),s=this[t+"_base_def_percent"],s&&(e+=this.getTotal("def")*s/100),s=this[t+"_base_hp_percent"],s&&(e+=this.getTotal("hp")*s/100),s=this[t+"_base_mastery_percent"],s&&(e+=this.getTotal("mastery")*s/100),e}isEmpty(){return 0===Object.keys(this).length}concat(t){const e=Object.keys(t);for(let s=0;s<e.length;s++){const i=e[s];this[i]=(this[i]||0)+t[i]}}clear(){const t=Object.keys(this);for(let e=0;e<t.length;e++)delete this[t[e]]}copyFrom(t){this.clear();const e=Object.keys(t);for(let s=0;s<e.length;s++)this[e[s]]=t[e[s]]}getSetFunc(){const t=Object.keys(this).sort(),e=t.join(",");if(s.get(e)){const e=t.map((t=>this[t]));return this._createSetFunc(t,e)}const i=[];for(let e=0;e<t.length;e++)i.push(`stats.${t[e]} = ${this[t[e]]}`);const n=Function("stats",i.join(";"));return s.set(e,!0),n}_createSetFunc(t,e){const s=[];for(let i=0;i<t.length;i++)s.push(`stats.${t[i]} = ${e[i]}`);return Function("stats",s.join(";"))}getConcatFunc(t){const e=Object.keys(this),s=[];for(let t=0;t<e.length;t++)s.push(`stats.${e[t]} += ${this[e[t]]}`);if(t){const e=Object.keys(t);for(let i=0;i<e.length;i++)s.push(`stats.${e[i]} = ${t[e[i]]}`)}return Function("stats",s.join(";"))}truncate(t){const e=Object.keys(this);for(let s=0;s<e.length;s++)t.includes(e[s])||delete this[e[s]]}ensure(t){for(let e=0;e<t.length;e++)this[t[e]]||(this[t[e]]=0)}processPercent(){const t=Object.keys(this);for(let e=0;e<t.length;e++)l(t[e])&&(this[t[e]]=this[t[e]]/100)}revertPercent(){const t=Object.keys(this);for(let e=0;e<t.length;e++)l(t[e])&&(this[t[e]]=100*this[t[e]])}calcPost(){const t=this.calcTotals();if(this.post_atk_hp_bonus){const e=(this.post_atk_hp_bonus||0)/100;this.atk=(this.atk||0)+(t.hp_total||0)*e}}calcTotals(t){const e=new i;t||="";const s=["atk","def","hp"];for(let i=0;i<s.length;i++){const n=s[i];if(t&&t!==n)continue;const r=this[n+"_base"]||0,a=r*(this[n+"_percent"]||0)/100+(this[n]||0),l=r+a;e[n+"_base"]=r,e[n+"_bonus"]=a,e[n+"_total"]=l}const n=["crit_rate","crit_dmg","mastery","healing","healing_recv","recharge","shield","recovery"];for(let s=0;s<n.length;s++){const i=n[s];if(t&&t!==i)continue;const r=this[i+"_base"]||0,a=this[i]||0,l=r+a;e[i+"_base"]=r,e[i+"_bonus"]=a,e[i+"_total"]=l}const r=["anemo","geo","electro","pyro","cryo","hydro","phys"],a=["dmg_","res_"];for(let s=0;s<r.length;s++)for(let i=0;i<a.length;i++){const n=a[i]+r[s];if(t&&t!==n)continue;const l=this[n+"_base"]||0,o=this[n]||0,c=l+o;e[n+"_base"]=l,e[n+"_bonus"]=o,e[n+"_total"]=c}return e}applyPostEffects(t,e,s){if(!e||!e.length)return;const n={};for(let t=0;t<e.length;t++){const i=e[t],r=i.getPriority();s&&r>s||(n[r]||(n[r]=[]),n[r].push(i))}const r=Object.keys(n).sort(((t,e)=>t-e));for(let e=0;e<r.length;e++){const s=new i,a=n[r[e]];for(let e=0;e<a.length;e++){const i=a[e].getData(this,t);s.concat(i)}this.concat(s)}}getFormatted(t,e){return i.format(t,this[t]||0,e)}revert(){const t=new i,e=Object.keys(this);for(let s=0;s<e.length;s++)t[e[s]]=-1*this[e[s]];return t}static roundStatValue(t,e,s){const i=s||l(t||"");return e=parseFloat(e)+1e-8,i?e.toFixed(1):Math.round(e)}static format(t,e,s){s||={};let i=e;const n=l(t);return Math.abs(e)<1e-5?s.zero?"0":"":(!function(t){return!!l(t)||a.test(t)}(t)?(i=Math.round(i),s.minimize&&(i>1e7?i=(i/1e6).toFixed(2)+"m":i>1e6&&(i=(i/1e6).toFixed(3)+"m"))):(i+=1e-8,i=i.toFixed(s.decimal_digits||1),s.no_decimal_zero&&(i=i.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"")),n&&(i+="%")),i=i.toString().replace(/\B(?=(\d{3})+(?!\d))/g," "),s.signed&&(e<0?"0"===i&&(i="-0"):i="+"+i),i)}static diff(t,e){const s=Object.assign({},t,e),n=new i,r=Object.keys(s);for(let s=0;s<r.length;s++){const i=r[s],a=(e[i]||0)-(t[i]||0);a&&(n[i]=a)}return n}}const n=/_percent/,r=/^(bond_of_life|stamina|recovery|duration|atk_speed|move_speed|healing|recharge|crit_|dmg_|enemy_|res_|.*bonus_|.*shield|.*_multi)/,a=/(_cooldown|_decimal)/;function l(t){return!!n.test(t)||r.test(t)}function o(t,e,s){let n=DB.Artifacts.Substats.get(t),r=DB.Artifacts.Rarity[e-1],a=n.rolls[e-1],l="percent"==n.type,o=c([],s,a,r.maxUpgrades,l);o=function(t){let e={};for(let s of t){let t=s.pop();e[[].concat(s.sort(),[t]).join("-")]=1}let s=[];for(const t of Object.keys(e).sort())s.push(t.split("-"));return s}(o),o=o.sort((function(t,e){return t[t.length-1]-e[e.length-1]||t.length-e.length}));let u=o[0],h=[];u||(u=[0]);let f=i.roundStatValue("",u.pop(),l);for(let t of u){let e=1;for(let s=0;s<a.length;++s)t==a[s]&&(e=2+s);h.push({value:i.roundStatValue("",t,l),rarity:e})}return{steps:h,maxValue:h.length*a[a.length-1],last:f,maxUpgrades:r.maxUpgrades}}function c(t,e,s,i,n){let r=[];if(i<=0){let s=u(t,e,n),i=[].concat(t);return i.push(Math.abs(s)),[i]}for(let a of s){let l=[].concat(t);l.push(a);let o=u(l,e,n);o>0?r=r.concat(c(l,e,s,i-1,n)):(0==o?l.push(0):(l=[].concat(t),l.push(Math.abs(a+o))),r.push(l))}return r}function u(t,e,s){let n=t.reduce((function(t,e){return t+e}),0),r=i.roundStatValue("",e,s)-i.roundStatValue("",n,s);return Math.abs(r)<.001?0:e-n}class h{constructor(t,e,s,i,n,r){this.rarity=t,this.level=e,this.slot=s,this.set=i,this.mainStat=n,this.subStats=r||[],this.locked=!1,this.groups=[],this.calculated=null}addStat(t,e){this.subStats.push({stat:t,value:e}),this.calculated=null}calcStats(){var t=new i;let e=DB.Artifacts.Mainstats.get(this.mainStat);if(e){let s=e.values[this.rarity-1];t.add(this.mainStat,s.getValue(this.level))}for(let e=0;e<this.subStats.length;++e){let s=this.subStats[e],i=DB.Artifacts.Substats.get(s.stat);t.add(s.stat,i.getPreciseValue(s.value,this.rarity))}return t.add("crit_value",2*t.get("crit_rate")+t.get("crit_dmg")),t}calcCache(t){this.calculated=this.calcStats(),this.calculated.truncate(t),this.calculated.processPercent()}replace(t){this.rarity=t.rarity,this.level=t.level,this.slot=t.slot,this.set=t.set,this.mainStat=t.mainStat,this.subStats=t.subStats,this.groups=t.getGroups(),this.calculated=null}getLevel(){return this.level}getSet(){return this.set}getRarity(){return this.rarity}getMainStat(){return""+this.mainStat}getSetName(){return""+this.set}getSlot(){return""+this.slot}getMainStatValue(){let t=this.getMainStat();return t?DB.Artifacts.Mainstats.get(t).values[this.rarity-1].getValue(this.level):0}getSubStats(){return this.subStats}setGroups(t){let e=t;Array.isArray(t)||(e=[t]);let s=[];for(let t of e){let e=h.trimGroupName(t);h.inGroups(s,e)||s.push(e)}this.groups=s}getGroups(){return this.groups&&0!=this.groups.length?this.groups:[""]}hasGroup(t){let e=t.toUpperCase();for(let t of this.groups)if(e==t.toUpperCase())return!0;return!1}inGroups(t){for(let e of t)if(this.hasGroup(e))return!0;return!1}isValid(){return 0==this.getErrors().length}setLocked(t){this.locked=!!t}isLocked(){return this.locked}getHash(){return t.pack(this)}getErrors(){let t=[];DB.Artifacts.Sets.get(this.set)||t.push("no_set"),DB.Artifacts.Mainstats.get(this.mainStat)||t.push("no_main_stat");let e=DB.Artifacts.Rarity[this.rarity-1],s=this.subStats.length;(s<e.minSubstats||s>e.maxSubstats)&&t.push("substat_count_mismatch");let i=!1,n=!1,r=!1,a=!1,l=[],c=0;for(const t of this.subStats){t.stat==this.mainStat&&(i=!0),l.includes(t.stat)&&(a=!0),l.push(t.stat);let e=o(t.stat,this.rarity,t.value);e.last>0&&(e.steps.length<e.maxUpgrades?r=!0:n=!0),e.steps.length>1&&(c+=e.steps.length-1)}let u=e.maxSubstats-4+Math.floor(this.level/4),h=Math.max(0,e.minSubstats-4+Math.floor(this.level/4));return c>0&&this.subStats.length<4&&t.push("not_full_substats"),(c>u||c>=e.maxUpgrades)&&t.push("too_much_upgrades"),c<h-1&&t.push("too_low_upgrades"),i&&t.push("substat_equal_main"),r&&t.push("substat_value_rolls"),n&&t.push("substat_value_range"),a&&t.push("substat_duplicate"),t}getErrorsFormatted(){let t=this.getErrors();if(0==t.length)return"";let e="";for(const s of t)e+="<p>"+UI.Lang.get("artifact_error."+s)+"</p>";return e}toGood(){let t=DB.Artifacts.Sets.get(this.set),e=DB.Artifacts.Mainstats.get(this.mainStat),s={setKey:t.getGoodId(),slotKey:this.slot,level:this.level,rarity:this.rarity,mainStatKey:e.goodId,location:"",lock:!1,substats:[]};for(const t of this.subStats){let e=DB.Artifacts.Substats.get(t.stat);if(!e)return null;s.substats.push({key:e.goodId,value:t.value})}return s}serialize(){let t=[1];t.push(DB.Artifacts.Sets.getId(this.set)),t.push(this.rarity),t.push(this.level),t.push(DB.Artifacts.Slots.getId(this.slot)),t.push(DB.Artifacts.Mainstats.getId(this.mainStat)||0),t.push(this.subStats.length);for(const e of this.subStats){t.push(DB.Artifacts.Substats.getId(e.stat));let s=DB.Artifacts.Substats.get(e.stat),i=e.value;"percent"==s.type&&(i=Math.floor(10*i)),t.push(i)}return t}clone(){return h.deserialize(this.serialize())}static deserialize(t){let e=null;if(1==t.shift()){let s=DB.Artifacts.Sets.getKeyId(t.shift());if(!s)return null;let i=t.shift();if(i<1||i>5)return null;let n=t.shift();if(n<0||n>20)return null;let r=DB.Artifacts.Slots.getKeyId(t.shift());if(!r)return null;let a=DB.Artifacts.Mainstats.getKeyId(t.shift())||"",l=t.shift();if(l<0||l>4)return null;e=new h(i,n,r,s,a);for(let s=1;s<=l;++s){let s=DB.Artifacts.Substats.getKeyId(t.shift());if(!s)return null;let i=t.shift();if(i<1)return null;let n=DB.Artifacts.Substats.get(s);if(!n)return null;i="percent"==n.type?parseFloat(i)/10:parseInt(i),e.addStat(s,i)}}return e}static fromGood(t){let e=DB.Artifacts.Sets.getKeyIdGood(t.setKey),s=DB.Artifacts.Sets.get(e);if(!s)return null;if(!DB.Artifacts.Slots.get(t.slotKey))return null;let i=DB.Artifacts.Mainstats.getKeyIdGood(t.mainStatKey),n=DB.Artifacts.Mainstats.get(i);if(!n)return null;if(!n.slots.includes(t.slotKey))return null;if(t.rarity<s.minRarity&&t.rarity>s.maxRarity)return null;let r=DB.Artifacts.Rarity[t.rarity-1];if(t.level<0&&t.level>r.maxLevel)return null;let a=new h(t.rarity,t.level,t.slotKey,e,i);if(Array.isArray(t.substats)){if(t.substats.length>4)return null;for(const e of t.substats){if(!e.key)continue;let t=DB.Artifacts.Substats.getKeyIdGood(e.key);if(!t)return null;let s=e.value;a.addStat(t,s)}}return a}static subStatsIsSimilar(t,e){if(t.subStats.length<e.subStats.length)return!1;for(let s=0;s<e.subStats.length;++s)if(t.subStats[s].stat!=e.subStats[s].stat||t.subStats[s].value<e.subStats[s].value)return!1;return!0}static inGroups(t,e){for(let s of t)if(h.groupsAreEqual(s,e))return!0;return!1}static groupsAreEqual(t,e){return t.toUpperCase()==e.toUpperCase()}static trimGroupNames(t){Array.isArray(t)||(t=[t]);let e=[];for(let s of t)e.push(h.trimGroupName(s));return e}static trimGroupName(t){let e=t||"";return e=e.replace(/[^\w\u0400-\u04ff\d_\-\s]/g,""),e=e.replace(/\s+/g," "),e.trim()}static settingName(t){return"set_pieces."+t.toLowerCase()}static settingNameShort(t){return t.toLowerCase()}}const f=["atk","hp","def"];function g(){let t={};for(let e of arguments)e.walk((e=>{if(e.getUsedStats)for(let s of e.getUsedStats()){let e=p(s);e!=s&&(t[e]=(t[e]||0)+1),t[s]=(t[s]||0)+1}}));return Object.keys(t)}function p(t){return t.replace(/(_\d+)+$/,"")}class d{constructor(t,e){this.items=t||[],e&&Object.assign(this,e)}getType(){return"block"}hasItems(){return!0}compileChildrens(t){return this.items.filter((t=>!t.isBlank())).map((e=>e.compile(t)))}isBlank(){for(let t of this.items)if(!t.isBlank())return!1;return!0}isCollapsable(){return!0}isVariableSet(){return!1}isVariableGet(){return!1}process(t){return this}compile(t){return this.compileChildrens(t).join(";\n")}execute(t,e){return t.stats.ensure(g(this)),Function("stats","return "+this.compile(e))(t.stats)}getSignature(){return"("+(this.isCollapsable()?"":"!")+this.getType()+":"+this.items.map((t=>t.getSignature())).join(",")+")"}treeBlockFields(){return[this.items]}makeResult(){return this.noReturn?this:new m([this])}walk(t,e){for(let s of this.treeBlockFields()){for(let i of s)e&&e(i)||t(i);for(let i of s)e&&e(i)||i.walk&&i.walk(t,e)}}walkReplace(t){for(let e of this.treeBlockFields()){let s=[];for(let i of e){let e=t(i);e&&s.push(e)}e.splice(0,e.length,...s);for(let s of e)s.walkReplace&&s.walkReplace(t)}}getInfoProperties(){let t={};for(let e of Object.keys(this))"object"!=typeof this[e]&&(t[e]=this[e]);return t}}class m extends d{getType(){return"block_return"}appendChildren(){let t=this.items.pop();for(let t of arguments)this.items.push(t);t&&this.items.push(t)}compile(t){let e=this.items.map((e=>e.compile(t)));return e[e.length-1]="return "+e[e.length-1],e.join(";\n")}}class b{constructor(t){Object.assign(this,t)}getType(){return"item"}hasItems(){return!1}isVariableSet(){return!1}isVariableGet(){return!1}compile(t){return this.value||0}isBlank(){return this.static&&this.blank}process(t){return this}getSignature(){throw`Item ${this.constructor.name} has no "getSignature" method!`}}class y extends b{getType(){return"item_const"}getSignature(){return"(const:"+this.value+")"}}class w extends b{getType(){return"item_stat"}compile(t){return"stats."+this.stat}process(t){return t.staticStats&&t.staticStats.includes(this.stat)?new y({value:this.value,comment:this.stat}):super.process()}getUsedStats(){return[this.stat]}getSignature(){return"(stat:"+this.stat+")"}}class S extends w{getType(){return"item_stat_total"}getUsedStats(){return[this.stat,this.stat+"_base",this.stat+"_percent"]}process(t){return new I([new O([new w({stat:this.statBaseName(),value:this.baseBalue}),new B([new w({stat:this.statPercentName(),value:this.percentValue})],{comment:this.stat+"_percent",percent:!0})]),new w({stat:this.statFlatName(),value:this.flatValue})],{comment:this.stat}).process(t)}statBaseName(){return this.replaceName(this.stat+"_base")}statPercentName(){return this.replaceName(this.stat+"_percent")}statFlatName(){return this.replaceName(this.stat)}replaceName(t){return this.replace&&this.replace[t]?this.replace[t]:t}compile(t){return`(stats.${this.statBaseName()} * (1 + stats.${this.statPercentName()}) + stats.${this.statFlatName()})`}}class v extends b{constructor(t){t.name=t.ref.name,delete t.ref,super(t)}getType(){return"variable_get"}isVariableGet(){return!0}compile(t){return this.name}getSignature(){return"(var_value:"+this.name+")"}}function _(t,e){return t.indexOf("*")>0?function(t,e){if(!f.includes(t))return new I([_(t+"_base",e),_(t,e)],{comment:t,percent:l(t)});return new S({stat:t,value:e.getTotalPercent(t),baseBalue:e.get(t+"_base"),percentValue:e.get(t+"_percent"),flatValue:e.get(t)})}(t.replace("*",""),e):new w({stat:t,value:e.get(t)})}let C=BigInt(0);function k(t){return(t||"var")+"_"+ ++C}function j(t,e){let s=new v({ref:t}),i=new T([new A([new y({value:1}),new I([s,e])])]),n=new T([new A([new y({value:1}),new I([s,new O([new y({value:2}),e])])])]),r=new T([new A([new y({value:1}),new I([s,new O([new y({value:3}),e])])])]),a=new T([new A([new y({value:1}),new I([s,new O([new y({value:4}),e])])])]),l=new T([new A([new y({value:1}),new I([s,new O([new y({value:5}),e])])])]),o=new v({ref:i}),c=new v({ref:n}),u=new v({ref:r}),h=new v({ref:a}),f=new v({ref:l}),g=new z([new O([new y({value:-1}),f]),new I([s,o,c,u,h,new y({value:-1}),new O([new y({value:-1}),s,o]),new O([new y({value:-1}),s,c]),new O([s,o,c]),new O([new y({value:-1}),o,c]),new O([new y({value:-1}),s,u]),new O([s,o,u]),new O([new y({value:-1}),o,u]),new O([s,c,u]),new O([new y({value:-1}),s,o,c,u]),new O([o,c,u]),new O([new y({value:-1}),c,u]),new O([new y({value:-1}),s,h]),new O([s,o,h]),new O([new y({value:-1}),o,h]),new O([s,c,h]),new O([new y({value:-1}),s,o,c,h]),new O([o,c,h]),new O([new y({value:-1}),c,h]),new O([s,u,h]),new O([new y({value:-1}),s,o,u,h]),new O([o,u,h]),new O([new y({value:-1}),s,c,u,h]),new O([s,o,c,u,h]),new O([new y({value:-1}),o,c,u,h]),new O([c,u,h]),new O([new y({value:-1}),u,h]),new O([new y({value:4}),s,f]),new O([new y({value:-3}),s,o,f]),new O([new y({value:3}),o,f]),new O([new y({value:-2}),s,c,f]),new O([new y({value:2}),s,o,c,f]),new O([new y({value:-2}),o,c,f]),new O([new y({value:2}),c,f]),new O([new y({value:-1}),s,u,f]),new O([s,o,u,f]),new O([new y({value:-1}),o,u,f]),new O([s,c,u,f]),new O([new y({value:-1}),s,o,c,u,f]),new O([o,c,u,f]),new O([new y({value:-1}),c,u,f]),new O([u,f]),new O([new y({value:-5}),f])])]);return[[t,i,n,r,a,l],new T([g],{name:"crit_rate_avg"})]}class I extends d{getType(){return"block_sum"}dontShrink(){return 0}compile(t){let e=this.compileChildrens(t),s=e.join(" + ");return e.length>1&&(s="("+s+")"),s||"0"}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof y&&0!=t.value)),s=this.items.filter((t=>!(t instanceof y)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=0;for(let t of e)i+=t.value;let n=new y({value:i,comment:"processed"});if(0==s.length&&!this.dontShrink())return n;t.push(n);for(let e of s)t.push(e);this.items=t}else this.items=[...e,...s];return 0==this.items.length&&(this.items=[new y({value:0})]),super.process(t)}}class B extends I{getType(){return"block_sum_plus"}compile(t){let e=this.compileChildrens(t);return 0==e.length?"":(e.unshift(1),"("+e.join(" + ")+")")}process(t){return new I([new y({value:1}),...this.items.map((e=>e.process(t)))],this.getInfoProperties(t)).process(t)}}class D extends d{getType(){return"block_subtract"}compile(t){let e=this.compileChildrens(t),s=e.join(" - ");return e.length>1&&(s="("+s+")"),s||"0"}}class O extends d{getType(){return"block_multi"}compile(t){let e=this.compileChildrens(t),s=e.join(" * ");return e.length>1&&(s="("+s+")"),s||0}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof y&&1!=t.value)),s=this.items.filter((t=>!(t instanceof y)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=1;for(let t of e)i*=t.value;let n=new y({value:i,comment:"processed"});if(0==s.length)return n;t.push(n);for(let e of s)t.push(e);this.items=t}else this.items=[...e,...s];return 1==this.items.length&&"block_multi"==this.getType()?this.items[0]:super.process()}}class z extends d{getType(){return"block_divide"}compile(t){let e=this.compileChildrens(t),s=e.join(" / ");return e.length>1&&(s="("+s+")"),s||0}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof y)),s=this.items.filter((t=>!(t instanceof y)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=e.shift().value;for(let t of e)i/=t.value;let n=new y({value:i,comment:"processed"});if(0==s.length)return n;t.push(n);for(let e of s)t.push(e);this.items=t}return super.process()}}class A extends d{getType(){return"block_min"}compile(t){let e=this.compileChildrens(t);return e.length>1?"Math.min("+e.join(", ")+")":e[0]}}class T extends I{getType(){return"variable_set"}isCollapsable(){return!1}isVariableSet(){return!0}constructor(t,e){(e=Object.assign({},e)).name=k(e.name),super(t,e)}compile(t){return"let "+this.name+" = "+super.compile(t)}}class P extends I{constructor(t,e){e.name=e.ref.name,delete e.ref,super(t,e)}getType(){return"variable_inc"}isCollapsable(){return!1}isVariableSet(){return!0}isVariableGet(){return!0}compile(t){return this.name+" += "+super.compile(t)}}class F extends d{getType(){return"post"}}class E extends d{getType(){return"isolated"}}class x extends I{getType(){return"stat_increase"}isCollapsable(){return!1}getAssignedStats(){return[this.stat]}compile(t){let e=super.compile(t);return this.newName?"stats."+this.newName+" = stats."+this.stat+" + "+e:"stats."+this.stat+" += "+e}}class N extends I{getType(){return"stat_decrease"}isCollapsable(){return!1}getAssignedStats(){return[this.stat]}compile(t){let e=super.compile(t);return"stats."+this.stat+" -= "+e}}class R{constructor(t,e){this.tree=t,this.postItems=e||[],this.usedStats=g(this.tree,...this.postItems),this.assignedStats=function(){let t={};for(let e of arguments){if(e.getAssignedStats)for(let s of e.getAssignedStats())t[s]=(t[s]||0)+1;e.walk((e=>{if(e.getAssignedStats)for(let s of e.getAssignedStats())t[s]=(t[s]||0)+1}))}return Object.keys(t)}(this.tree,...this.postItems),this.isReacted=!1}checkForReaction(){this.tree.walk((t=>{t.isReacted&&(this.isReacted=!0)}))}prepare(t,e){e=Object.assign({},e);let s,i="damage_rotation_result"==this.tree.getType(),n=this.tree.makeResult();if(i||(s=this.makePostTree(e)),this.processed=new d,e.dontProcessTree||(this.processBlock(n,e),s&&this.processBlock(s,e)),s&&this.processed.items.push(s),this.processed.items.push(n),s&&s.revert&&s.revert.length){let t=this.processed.items[this.processed.items.length-1];t.appendChildren?t.appendChildren(...s.revert):this.processed.items.push(...s.revert)}}processBlock(t,e){t.walkReplace((t=>t.process(e))),t.process(e),this.processVariables(t,e)}makePostTree(t){let e=[];for(let s of this.postItems)(t.dontProcessStats||s.stat&&this.usedStats.includes(s.stat))&&e.push(s);if(0==e.length)return;let[s,i]=R.postTreeBlocks(e,t);return new F(s,{revert:i})}static filterPostByStats(t,e){let s=[],i=L(t);e=[].concat(e);for(let t of Object.keys(i).sort().reverse())for(let n of i[t]){let t=p(n.stat);if(n.stat&&(e.includes(n.stat)||e.includes(t))){s.push(n);for(let t of g(n))e.includes(t)||e.push(t)}}return s}static postTreeBlocks(t){let e=[],s=[],i=L(t);for(let t of Object.keys(i).sort()){let n=[],r=[];for(let e of i[t]){let t=new T([e],{name:"post_"+e.stat});n.push(t),r.push(new x([new v({ref:t})],{stat:e.stat})),s.unshift(new N([new v({ref:t})],{stat:e.stat}))}e.push(new E([...n,...r]))}return[e,s]}getCode(t){return this.processed.compile(t)}compile(t){let e=this.getCode(t);return this.compiled=Function("stats",e),e}compilePostTree(t){let e=this.makePostTree(t);return e?(t.dontProcessTree||this.processBlock(e,t),Function("stats",e.compile(t))):Function("stats","")}execute(t){return this.compiled(t.stats)}processVariables(t,e){e.dontInsertVariables||t.walk((t=>{"isolated"==t.getType()&&this.replaceBlockRepeat(t)}))}replaceBlockRepeat(t){for(let e=0;e<10;++e){let e={};t.walk((t=>{if(t.hasItems()){let s=t.getSignature();s&&!s.includes("!")&&(e[s]=(e[s]||0)+1)}}),(t=>"isolated"==t.getType()));let s=[];for(let[t,i]of Object.entries(e))i<2||s.push(t);let i=[];for(let t of s){let e=!0;for(let i of s)if(t!=i&&i.indexOf(t)>=0){e=!1;break}e&&i.push(t)}if(0==i.length)break;let n={},r={};t.walkReplace((t=>{let e=t.getSignature();if(e&&i.includes(e)){if(!n[e]){let s=new T([t]);n[e]=s,r[s.name]=s}return new v({ref:n[e]})}return t})),t.items=M(t.items,r)}}}function M(t,e){let s=[];for(;Object.keys(e).length;){s=[];for(let n of t){let t={};for(var i of(n.walk((e=>{e.isVariableGet()&&!e.isVariableSet()&&(t[e.name]=1)})),Object.keys(t)))e[i]&&(s.push(e[i]),delete e[i]);s.push(n)}t=s}return s}function L(t){let e={};for(let s of t){let t=s.priority;e[t]||(e[t]=[]),e[t].push(s)}return e}const V=1;class H{constructor(t){Object.assign(this,t)}set(t,e){this[t]=e}get(t){return this[t]}getNumber(t){return this[t]||0}concat(){for(let t of arguments)Object.assign(this,t)}getLevel(t){return G(t,this)}}function G(t,e){let s=e[t]||1;s+=e[t+"_bonus"]||0,s+=e[t+"_bonus_2"]||0;let i=/\w+_(char_skill_\w+)/.exec(t);return i&&(s+=e[i[1]+"_bonus_party"]||0),s}class U{constructor(t,e){this.stats=new i(e),this.settings=new H(t),this.multipliers=[],this.postEffects=[]}addStats(t){this.stats.concat(t)}addSettings(t){this.settings.concat(t)}getActivePostEffects(){return this.postEffects.filter((t=>t.isActive(this.settings)))}getActivePostEffectsTree(){let t=this.getActivePostEffects(),e=[];for(let s of t)if(s.getTree)for(let t of s.getTree(this))e.push(t);return e}applyPostEffects(t){for(let t of this.postEffectTreeByPriority()){let e=new R(new d([]),t),s=e.compilePostTree({dontProcessStats:!0});s&&(this.stats.ensure(e.usedStats),this.stats.ensure(e.assignedStats),s(this.stats))}this.postEffects=[]}postEffectByPriority(t){t=Object.assign({},t);let e=this.getActivePostEffects(),s={};for(let i of e){let e=i.getPriority();t.maxPriority&&e>t.maxPriority||(s[e]||(s[e]=[]),s[e].push(i))}let i=[];for(let t of Object.keys(s).sort())i.push(s[t]);return i}postEffectTreeByPriority(t){let e=this.postEffectByPriority(t),s=[];for(let t of e){let e=[];for(let s of t)e=e.concat(s.getTree(this));s.push(e)}return s}getResistance(t){return this.settings.get("enemy_res_"+t)+100*this.stats.get("enemy_res_"+t)}clone(){let t=new U(this.settings,this.stats);return t.postEffects=[].concat(this.postEffects),t.multipliers=[].concat(this.multipliers),t}}class K{constructor(t){this.params=t||{},this.entityId=0}getId(){return this.params.serializeId||0}getEntityId(){return this.entityId}getName(){return this.params.name}getNamesList(){return[this.getName()]}getType(){return""}getTitle(t){return this.params.title?UI.Lang.getTalent(this.params.title,t):""}getIcon(){return this.params.icon?this.params.icon.name:""}getDescription(t){return this.params.description?UI.Lang.getTalent(this.params.description,t):""}getInfo(){return this.params.info}getLevel(t){return G(this.params.levelSetting,t)}isHidden(t){if(this.params.isHidden)return!0;let e=this.params.hideCondition;if(e)for(let s=0;s<e.length;++s){if(e[s].isActive(t))return!0}return!1}isActive(t){return this.checkSubconditions(t)}isSerializable(){let t=this.getName(),e=this.getType();return!(!t&&!e||"static"==e)}getMaxStacks(t){return this.params.maxStacks||0}checkSubconditions(t){if(this.params.condition)return this.params.condition.isActive(t);{let e=this.params.subConditions;if(e)for(let s=0;s<e.length;++s){if(!e[s].isActive(t))return!1}}return!0}getData(t){let e={settings:{}};return this.isActive(t)?(e.settings=this.params.settings||{},e.stats=this.getStats(t)):e.stats=new i,e}getStats(t){return new i(this.params.stats||{})}getBuffRotationSection(t){return this.params.rotation||""}static allConditionsOn(t,e){let s={};for(let i=0;i<t.length;++i){const n=t[i];let r=n.getType();"stacks"==r?s[n.getName()]=n.getMaxStacks():"checkbox"==r?s[n.getName()]=!0:"dropdown"==r?s[n.getName()]=n.params.suggesterValue||0:n.getAllConditionsOn&&Object.assign(s,n.getAllConditionsOn(e))}return s}static allConditionsOff(t){let e={};for(let s=0;s<t.length;++s){const i=t[s];let n=i.getType();"stacks"==n?e[i.getName()]=0:"checkbox"==n&&(e[i.getName()]=!1)}return e}static setCommonValues(t,e){let s={};for(let i=0;i<e.length;++i){const n=e[i].getName();/^common\./.test(n)&&(t[n]||=0,s[n]=t[n])}return s}static unwrap(t,e){let s=[];for(let i of t)if(i.getCondtitionList)for(let t of i.getCondtitionList())e&&!t.isActive(e)||s.push(t);else s.push(i);return s}}const $={normal:0,crit:1,average:2},W=["crit_value"];class q{constructor(t){this.build=t.build,this.artifacts=t.artifacts,this.featureName=t.featureName,this.featureType=t.featureType,this.settings=t.settings,this.limit=t.limit||20}prepare(){this.currentArts=this.build.getArtifacts(),this.build.clearArtifacts(),this.build.artifacts.modifySettings(this.settings.sets_settings),this.buildData=this.build.getBuildData();const t=this.build.getActiveConditions(this.buildData.settings);K.setCommonValues(this.buildData.settings,t),this.prepareArtifactSets(),this.prepareDynamicStats();const e={ignoreSideEffects:1,staticStats:[]};this.featureVariants={},this.usedStats=[];const s=[],i=[],n=this.settings.stats||{},r=Object.keys(n);for(let t=0;t<r.length;t++){let e=r[t].replace("_min","").replace("_max","");i.push(e),i.push(e+"_base"),f.includes(e)&&i.push(e+"_percent")}this.usedStats=this.usedStats.concat(i);const a=this.getVariations();for(let t=0;t<a.length;t++){const e=a[t],i=this.build.clone(),n=Object.assign({},this.settings.sets_settings),r=[],l=[];for(let t=0;t<e.length;t++){const s=e[t];if(s.setId){r.push(s.name),n[h.settingName(s.setId)]=s.pieces;for(let t=0;t<s.pieces;t++)l.push(s.setId)}}const o=DB.Artifacts.Slots.getKeys();for(let t=0;t<o.length;t++){const e=l.pop();if(!e)break;const s=new h(5,20,o[t],e,"",[]);i.setArtifact(s)}const c=r.sort().join("-")||"default";i.artifacts.modifySettings(n);const u=i.getBuildData();this.addDynamicStats(u.getActivePostEffectsTree());const f=i.getFeatureByName(this.featureName);f.items&&this.addDynamicStatsFromItems(u,f.items),s.push({variandId:c,feature:f,buildData:u})}for(let t=0;t<s.length;t++){const n=s[t],r=n.buildData.postEffectTreeByPriority(),a=this.filterPostEffects(n.feature,n.buildData),l=n.feature.getTree(n.buildData,e),o=new R(l,a);let c=o.usedStats;this.usedStats=this.usedStats.concat(c),c=c.concat(i),n.buildData.stats.ensure(c),e.staticStats=this.makeStaticStats(c),o.prepare(n.buildData,e),o.compile(e),o.checkFunc=Q(this.settings.stats,r),this.featureVariants[n.variandId]=o}this.buildData.stats.truncate(this.usedStats),this.buildData.stats.ensure(this.usedStats),this.prepareArtifacts()}getVariations(){const t={},e=[],s=Object.keys(this.setData);for(let i=0;i<s.length;i++){const n=s[i],r=Object.keys(this.setData[n]);for(let s=0;s<r.length;s++){const i=r[s],a=this.setData[n][i];a.variation&&!t[a.variation]&&(t[a.variation]=1,e.push({name:a.variation,setId:n,pieces:parseInt(i)}))}}const i=[[{name:"default"}]];for(let t=0;t<e.length;t++){const s=e[t];i.push([s]);for(let n=t+1;n<e.length;n++){const t=e[n];s.pieces+t.pieces<=5&&i.push([s,t])}}return i}filterPostEffects(t,e){if(t.isRotation())return[];const s=e.postEffectTreeByPriority();e.postEffects=[];const i=[];for(let n=0;n<s.length;n++){const r=s[n],a=t.getTree(e),l=new R(a,i).usedStats;for(let t=0;t<r.length;t++){const e=r[t],s=e.getAssignedStats();for(let t=0;t<s.length;t++)if(l.includes(s[t])){i.push(e);break}}}return i}prepareArtifacts(){this.slots={flower:[],plume:[],sands:[],goblet:[],circlet:[]},this.setNames={},this.totalCombinations=1;for(let t=0;t<this.artifacts.length;t++){const e=this.artifacts[t];this.setNames[e.set]=1,e.calcCache(this.usedStats),e.concatFunc=e.calculated.getConcatFunc(),this.slots[e.slot].push(e)}const t=Object.keys(this.slots);for(let e=0;e<t.length;e++){const s=t[e];if(0===this.slots[s].length){const t=this.currentArts[s];if(t)t.calcCache(this.usedStats),this.slots[s].push(t);else{const t=new h(5,0,s,"none","none",[]);t.isEmpty=!0,t.calculated=new i,t.concatFunc=t.calculated.getConcatFunc(),this.slots[s].push(t)}}this.totalCombinations*=this.slots[s].length}}prepareArtifactSets(){const t={};for(let e=0;e<this.artifacts.length;e++){const s=this.artifacts[e];t[s.set]||(t[s.set]={}),t[s.set][s.slot]=1}const e={},s=Object.keys(t);for(let i=0;i<s.length;i++)e[s[i]]=Object.keys(t[s[i]]).length;this.setData={};const n=Object.assign({},this.buildData.settings),r=this.buildData.getActivePostEffects().length,a=DB.Artifacts.Sets.getKeys();for(let t=0;t<a.length;t++){const s=a[t],l=DB.Artifacts.Sets.get(s).getConditionsByPieces(),o=new i;let c;const u={},f=h.settingNameShort(s),g=e[s]||0,p=this.build.getBuildData();let d=r,m="";for(let t=1;t<l.length&&!(t>g);t++){p.addSettings({[h.settingName(s)]:t});const e=l[t];let r={};if(e.length){r=K.allConditionsOn(e,n);const t=Object.keys(r);for(let e=0;e<t.length;e++){const s=t[e];n.hasOwnProperty(s)&&(r[s]=n[s])}const s=Object.assign({},r,n),a=new i;for(let t=0;t<e.length;t++){const i=e[t].getData(s);a.concat(i.stats)}o.concat(a),Object.assign(u,r),p.addSettings(r)}const a=p.getActivePostEffects().length,g=e.filter((t=>t.isSerializable())).length;if(a>d?(d=a,m=f+t):g&&(m=f+t),Object.keys(o).length||c||m){const e=new i(o);e.processPercent(),this.setData[s]||(this.setData[s]={}),this.setData[s][t]={stats:e,variation:m,concatFunc:e.getConcatFunc()}}}}}prepareDynamicStats(){const t={},e=DB.Artifacts.Mainstats.getKeys(),s=DB.Artifacts.Substats.getKeys();for(let s=0;s<e.length;s++)t[e[s]]=1;for(let e=0;e<s.length;e++)t[s[e]]=1;const i=Object.keys(this.setData);for(let e=0;e<i.length;e++){const s=Object.keys(this.setData[i[e]]);for(let n=0;n<s.length;n++){const r=this.setData[i[e]][s[n]].stats,a=Object.keys(r);for(let e=0;e<a.length;e++)/^text_/.test(a[e])||(t[a[e]]=1)}}this.dynamicStats=Object.keys(t)}addDynamicStats(t){for(let e=0;e<t.length;e++){const s=t[e];s.stat&&!this.dynamicStats.includes(s.stat)&&this.dynamicStats.push(s.stat)}}addDynamicStatsFromItems(t,e){for(let s=0;s<e.length;s++){const i=e[s];if(i.postEffects)for(let e=0;e<i.postEffects.length;e++){const s=i.postEffects[e];s.getTree&&this.addDynamicStats(s.getTree(t))}i.items&&this.addDynamicStatsFromItems(t,i.items),i.conditions&&this.addDynamicStatsFromItems(t,i.conditions)}}makeStaticStats(t){const e=[];for(let s=0;s<t.length;s++){const i=t[s];this.dynamicStats.includes(i)||W.includes(i)||e.push(i)}return e}getResult(t){const e=[];let s=0;this.currentCombinations=0,this.skippedCombinations=0;const n=$[this.featureType],r=this.buildData.stats.getSetFunc(),a=new i,l={},o=function*(t,e,s,i){let n,r,a,l,o;const c={},u=Object.keys(e);for(let t=0;t<u.length;t++)c[u[t]]=0;const h=function(t){const e=[],s=Object.entries(t.setMaxValues);for(let t=0;t<s.length;t++){const[i,n]=s[t];e.push("if(sets."+i+">="+n+")return true")}return e.push("return false"),Function("sets",e.join(";"))}(t),f=function(t){const e=[],s=Object.entries(t.setMinValues);for(let t=0;t<s.length;t++){const[i,n]=s[t];e.push("if(sets."+i+"<"+n+")return true")}return e.push("return false"),Function("sets",e.join(";"))}(t),g=s.circlet.length,p=g*s.goblet.length,d=p*s.sands.length,m=s.flower,b=s.plume,y=s.sands,w=s.goblet,S=s.circlet;for(let t=0;t<m.length;--c[n?n.set:""],++t){n=m[t],++c[n.set];for(let t=0;t<b.length;--c[r?r.set:""],++t)if(r=b[t],++c[r.set],h(c))i(d);else for(let t=0;t<y.length;--c[a?a.set:""],++t)if(a=y[t],++c[a.set],h(c))i(p);else for(let t=0;t<w.length;--c[l?l.set:""],++t)if(l=w[t],++c[l.set],h(c))i(g);else for(let t=0;t<S.length;--c[o?o.set:""],++t)o=S[t],++c[o.set],h(c)||f(c)?i(1):yield[n,r,a,l,o]}}(this.settings,this.setNames,this.slots,(e=>{this.currentCombinations+=e,this.skippedCombinations+=e,t&&(this.currentCombinations%5e4==0||e>5e4)&&t(this.currentCombinations,this.totalCombinations,this.skippedCombinations)}));let c;for(t(this.currentCombinations,this.totalCombinations,this.skippedCombinations);(c=o.next())&&!c.done;){this.currentCombinations++;const i=Object.keys(l);for(let t=0;t<i.length;t++)l[i[t]]=0;const o=c.value;a.clear(),r(a);for(let t=0;t<o.length;t++){const e=o[t];e&&(l[e.set]=(l[e.set]||0)+1,e.concatFunc(a))}const u=[],h=Object.keys(l);for(let t=0;t<h.length;t++){const e=h[t],s=l[e];if(0===s)continue;const i=this.setData[e]&&this.setData[e][s];i&&(i.variation&&u.push(i.variation),i.concatFunc&&i.concatFunc(a))}const f=u.length?u.sort().join("-"):"default",g=this.featureVariants[f];if(!g.checkFunc||g.checkFunc(a)){this.buildData.stats=a;const t=g.execute(this.buildData)[n]||0;t>=s&&e.push({value:t,artifacts:o.slice()})}else this.skippedCombinations++;t&&this.currentCombinations%5e4==0&&(e.length>100*this.limit&&(J(e,this.limit),s=e[e.length-1].value),t(this.currentCombinations,this.totalCombinations,this.skippedCombinations))}return t(this.currentCombinations,this.totalCombinations,this.skippedCombinations),J(e,this.limit),function(t){for(let e=0;e<t.length;e++){const s=t[e],i=[];for(let t=0;t<s.artifacts.length;t++)s.artifacts[t].isEmpty||i.push(s.artifacts[t]);s.artifacts=i}}(e),e}}function J(t,e){t.sort(((t,e)=>e.value-t.value)),t.splice(e)}function Q(t,e){const[s,i]=function(t){const e=[],s=[],i=Object.keys(t);for(let n=0;n<i.length;n++){const r=i[n],a=/^(.*)_(min|max)$/.exec(r);if(!a)continue;const o=a[1],c=a[2];let u,h=t[r];h&&(l(o)&&(h/=100),u=f.includes(o)?"stats."+o+"_base*(1+stats."+o+"_percent)+stats."+o:"stats."+o+"_base+stats."+o,s.includes(o)||(s.push(o),s.push(o+"_base"),f.includes(o)&&s.push(o+"_percent")),"max"===c?e.push("if("+u+">"+h+")return false"):"min"===c&&e.push("if("+u+"<"+h+")return false"))}return[e,s]}(t);if(0===s.length)return;let n=s.join(";\n");const r=function(t,e){let s=[].concat(e),i=[];for(let e of t){let t=[];for(let n of e)s.includes(n.stat)&&(i.push(n),t=t.concat(g(n)));s=s.concat(t)}return i}(e,i);if(r){const[t,e]=R.postTreeBlocks(r);n=X(t)+";\n"+n+";\n"+X(e)}return Function("stats",n+";\nreturn true")}function X(t){const e=new R(new d(t,{noReturn:!0}),[]);return e.prepare(),e.getCode()}class Y{constructor(){this.object=null,this.settings={}}getName(){return this.object&&this.object.getName()||""}getIcon(){return this.object&&this.object.getIcon()||""}getRarity(){return this.object&&this.object.getRarity()||1}set(t){this.object=t,this.removeInvalidSettings()}get(){return this.object}getConditions(){return this.object&&this.object.getConditions()||[]}getFeatures(){return this.object&&this.object.getFeatures()||[]}getPostEffects(){return this.object&&this.object.getPostEffects()||[]}getMultipliers(){return this.object&&this.object.getMultipliers()||[]}getSettings(){return Object.assign({},this.settings)}getLevels(){return this.levels}getStats(){var t=new i;if(this.object&&this.object.statTable)for(let e=0;e<this.object.statTable.length;++e){let s=this.object.statTable[e],i=s.getValue(this.levels.level,this.levels.ascension);t.add(s.getName(),i)}return{stats:t,settings:{}}}setSettings(t){this.settings=t}modifySettings(t){return Object.assign(this.settings,t),this.getSettings()}addSettings(t){this.settings=Object.assign(this.settings,t)}isBeta(){return this.object&&this.object.isBeta()}serialize(){return[]}removeInvalidSettings(){let t=this.getConditions(),e=K.allConditionsOn(t);for(const t of Object.keys(this.settings))void 0===e[t]&&delete this.settings[t]}serializeConditions(t,e){let s=0,i=[],n=[];if(e)for(const s of K.unwrap(e,t))s.isActive(t)&&n.push(s);else for(const e of K.unwrap(this.getConditions({serialize:!0}),t))e.isActive(t)&&n.push(e);for(const e of n){if(!e.params.serializeId)continue;let n=e.getType();if("checkbox"==n)++s,i.push(e.params.serializeId);else if("stacks"==n)++s,i.push(e.params.serializeId),i.push(t[e.getName()]);else if("number"==n){++s,i.push(e.params.serializeId);let n=t[e.getName()]||0;n="decimal"==e.params.format?Math.floor(10*parseFloat(n)):parseInt(n),i.push(Math.max(0,n))}else if("dropdown"==n||"dropdown_multiple"==n){let n=e.getSelectedId(t);n&&(++s,i.push(e.params.serializeId),i.push(n))}else if("char"==n){let n=this.serializeChars(t);n.length&&(++s,i.push(e.params.serializeId),i=i.concat(n))}else if("custom_buffs"==n){let n=this.serializeCustomBuffs(t);n.length&&(++s,i.push(e.params.serializeId),i=i.concat(n))}}return i.unshift(s),i}serializeChars(t){return[]}serializeCustomBuffs(t){return[]}deserializeChars(t){return{}}deserializeCustomBuffs(t){return{}}deserializeConditions(t,e){let s={},i=t.shift(),n={};if(e)for(const t of K.unwrap(e))t.params.serializeId&&(n[t.params.serializeId]=t);else for(const t of K.unwrap(this.getConditions({serialize:!0})))t.params.serializeId&&(n[t.params.serializeId]=t);for(let e=1;e<=i;++e){let i=t.shift();if(e<1)return;let r=n[i];if(!r)return;let a=r.getType();if("checkbox"==a)s[r.getName()]=!0;else if("stacks"==a){let e=t.shift();e>r.params.maxStack&&(e=r.params.maxStack),s[r.getName()]=e}else if("number"==a){let e=t.shift();"decimal"==r.params.format&&(e=(e/10).toFixed(1)),s[r.getName()]=e}else if("dropdown"==a||"dropdown_multiple"==a){let e=r.getValueById(t.shift());s[r.getName()]=e||""}else"char"==a?s=Object.assign(s,this.deserializeChars(t)):"custom_buffs"==a&&(s=Object.assign(s,this.deserializeCustomBuffs(t)))}return s}}const Z=["flower","plume","sands","goblet","circlet"];class tt extends Y{constructor(){super(),this.artifacts={flower:null,plume:null,sands:null,goblet:null,circlet:null}}get(){return this.artifacts}hasEquipped(){for(let t of Z)if(this.artifacts[t])return!0;return!1}getSettings(){let t=Object.assign({},this.settings),e={};for(let t of Z){let s=this.artifacts[t];s&&(e[s.set]=1+(e[s.set]||0))}for(let s of Object.keys(e))t[h.settingName(s)]=e[s];return t}getFeatures(){let t=[],e=this.activeSets(),s=Object.keys(e);for(let i=0;i<s.length;++i){let n=s[i],r=DB.Artifacts.Sets.get(n);if(r){let s=r.getFeatures(e[n]);t=t.concat(s)}}return t}isBeta(){let t=this.activeSets(),e=Object.keys(t);for(let t of e){let e=DB.Artifacts.Sets.get(t);if(e&&e.isBeta())return!0}return!1}getStats(t){let e={stats:new i,settings:{}};for(let s=0;s<Z.length;++s){const i=Z[s];let n=this.artifacts[i];n&&e.stats.concat(n.calcStats(t))}return e}getConditions(){let t=[],e=this.activeSets(),s=Object.keys(e);for(let i=0;i<s.length;++i){let n=s[i],r=DB.Artifacts.Sets.get(n);if(r){let s=r.getConditions(e[n]);t=t.concat(s)}}return t}getPostEffects(){let t=[];for(let e of DB.Artifacts.Sets.getList()){let s=e.getPostEffects();t=t.concat(s)}return t}getMultipliers(){let t=[],e=this.activeSets();for(const[s,i]of Object.entries(e)){let e=DB.Artifacts.Sets.get(s);if(e){let s=e.getMultipliers(i);t=t.concat(s)}}return t}modifySets(t){let e=[].concat(t),s={},i=DB.Artifacts.Sets.getKeys();for(let t=0;t<Z.length;++t){const n=Z[t];let r=this.artifacts[n];if(r){let t=e.shift();if(!t)for(const e of i){if(s[e])continue;let i=DB.Artifacts.Sets.get(e);i.getConditions(1).length||i.minRarity<=r.rarity&&i.maxRarity>=r.rarity&&(t=e)}s[t]=1,r.set=t}}}set(t){let e=t.slot;this.artifacts[e]=t,this.removeInvalidSettings()}replace(t){for(let e of t){let t=e.slot;this.artifacts[t]=e}this.removeInvalidSettings()}remove(t){let e=t.getHash();for(let t=0;t<Z.length;++t){const s=Z[t];let i=this.artifacts[s];i&&i.getHash()==e&&(this.artifacts[s]=null,this.removeInvalidSettings())}}clearArtifacts(){for(let t=0;t<Z.length;++t){const e=Z[t];this.artifacts[e]=null}}isEquipped(t){let e=t.slot;return!(!this.artifacts[e]||this.artifacts[e]!=t)}activeSets(){let t={};for(let e=0;e<Z.length;++e){const s=Z[e];let i=this.artifacts[s];i&&(i.set&&(t[i.set]||(t[i.set]=0),++t[i.set]))}return t}serialize(t){let e=[],s=0;for(let t=0;t<Z.length;++t){const i=Z[t];let n=this.artifacts[i];n&&(++s,e=e.concat(n.serialize()))}e.unshift(s);let i=this.serializeConditions(t);return e.concat(i)}static deserialize(t){let e=t.shift();if(e<0||e>5)return null;let s=new tt;for(let i=1;i<=e;++i){let e=h.deserialize(t);if(!e)return null;s.set(e)}let i=s.deserializeConditions(t);return i?(s.setSettings(i),s):null}}const et={atk:{serializeId:1,flat:!0},atk_percent:{serializeId:2},def:{serializeId:3,flat:!0},def_percent:{serializeId:4},hp:{serializeId:5,flat:!0},hp_percent:{serializeId:6},mastery:{serializeId:7,flat:!0},recharge:{serializeId:8},crit_rate:{serializeId:9},crit_dmg:{serializeId:10},healing:{serializeId:11},healing_recv:{serializeId:12},shield:{serializeId:13},recharge:{serializeId:14},crit_rate:{serializeId:15},crit_dmg:{serializeId:16},healing:{serializeId:17},healing_recv:{serializeId:18},shield:{serializeId:19},dmg_all:{serializeId:20},dmg_anemo:{serializeId:21},dmg_cryo:{serializeId:22},dmg_dendro:{serializeId:23},dmg_electro:{serializeId:24},dmg_geo:{serializeId:25},dmg_hydro:{serializeId:26},dmg_pyro:{serializeId:27},dmg_phys:{serializeId:28},dmg_normal:{serializeId:29},dmg_charged:{serializeId:30},dmg_plunge:{serializeId:31},dmg_skill:{serializeId:32},dmg_burst:{serializeId:33},enemy_def_reduce:{serializeId:34},enemy_def_ignore:{serializeId:35}};let st={};for(let t of Object.keys(et))st[et[t].serializeId]=t;class it extends Y{constructor(){super(),this.buffs=DB.Buffs,this.partyCharIds=[]}get(){return this.buffs}getFeatures(){return[]}isBeta(){return!1}getStats(t){return{stats:new i,settings:{}}}getConditions(t){let e=[];t||={};for(const t of this.buffs.getList())e=e.concat(t.getConditions());let s=this.getPartyChars();if(!t.serialize)for(let t=0;t<s.length;++t){let i=s[t];const n=DB.Chars.getById(i);n&&(e=e.concat(n.getPartyConditions()))}return e}getMultipliers(){let t=[];for(const e of this.buffs.getList())t=t.concat(e.getMultipliers());let e=this.getPartyChars();for(let s of e){const e=DB.Chars.getById(s);e&&(t=t.concat(e.getPartyMultipliers()))}return t}getPostEffects(){let t=[],e=this.getPartyChars();for(const e of this.buffs.getList())t=t.concat(e.getPostEffects());for(let s=0;s<e.length;++s){let i=e[s];const n=DB.Chars.getById(i);n&&(t=t.concat(n.getPartyPostEffects()))}return t}setPartyChars(t){this.partyCharIds=[];for(const e of t)e&&DB.Chars.getById(e)&&this.partyCharIds.push(e)}getPartyChars(){return[].concat(this.partyCharIds)}getSettings(){let t=super.getSettings(),e=1;for(let s=1;s<=3;++s){let i=this.partyCharIds[s-1];const n=DB.Chars.getById(i);n?(++e,t["party_char_"+s]=i,t["resonance_element_"+s]=n.getElement()):(t["party_char_"+s]=0,t["resonance_element_"+s]="")}return t.party_size=e,t}serialize(t){let e=this.serializeConditions(t);return[].concat(e)}serializeChars(t){let e=this.getPartyChars(),s=[],i=0;for(let n=0;n<e.length;++n){let r=e[n],a=DB.Chars.getById(r);if(a){++i;let e=a.getPartyConditions(),n=this.serializeConditions(t,e);s.push(r),s=s.concat(n)}}return s.unshift(i),s}serializeCustomBuffs(t){let e=0,s=[];for(let i of Object.keys(et)){let n=t["custom_buffs."+i];if(!n)continue;++e;let r=et[i];s.push(r.serializeId),r.flat?s.push(Math.floor(n)):s.push(Math.floor(10*n))}return e&&s.unshift(e),s}deserializeChars(t){let e=t.shift(),s={};for(let i=0;i<e;++i){let e=t.shift(),n=DB.Chars.getById(e);if(!n)return null;let r=n.getPartyConditions();s["party_char_"+(i+1)]=e;let a=this.deserializeConditions(t,r);s=Object.assign(s,a)}return s}deserializeCustomBuffs(t){let e=t.shift(),s={};for(let i=0;i<e;++i){let e=t.shift(),i=st[e];if(!i)return null;let n=et[i],r=t.shift();n.flat||(r/=10),s["custom_buffs."+i]=r}return s}static deserialize(t){let e=new it,s=e.deserializeConditions(t);if(!s)return null;let i={};e.partyCharIds=[];for(let t=1;t<=3;++t)s["party_char_"+t]&&e.partyCharIds.push(s["party_char_"+t]);if(0==e.partyCharIds.length)for(let t=1;t<=3;++t){let n=s["old_resonance_element_"+t];if(n){delete s["old_resonance_element_"+t];for(const t of DB.Chars.getList()){let s=t.getId();if(!i[s]&&n==t.getElement()){e.partyCharIds.push(s),i[s]=1;break}}}}return e.setSettings(s),e}}class nt{constructor(t,e){this.stat=t,this.values=e}getName(){return this.stat}getValue(t){return t>0?(t>this.values.length&&(t=this.values.length),this.values[t-1]):0}getValues(){return this.values}multiply(t){let e=[];for(let s of this.values)e.push(s*t);return new nt(this.stat,e)}}const rt=new nt("",[1,2,4,6,8,10]);class at extends Y{constructor(){super(),this.levels={level:1,ascension:0,constellation:0},this.skills={attack:1,elemental:1,burst:1}}setLevels(t){this.levels.level=t.level,this.levels.ascension=t.ascension,this.levels.constellation=t.constellation}getLevels(){return{level:this.levels.level,ascension:this.levels.ascension,constellation:this.levels.constellation}}setSkills(t){this.skills.attack=t.attack,this.skills.elemental=t.elemental,this.skills.burst=t.burst}getId(){return this.object?this.object.getId():0}getName(){return this.object?this.object.getName():""}getSkills(){return{attack:this.skills.attack,elemental:this.skills.elemental,burst:this.skills.burst}}getConditions(){let t=super.getConditions();if(!this.object)return t;let e=this.object.constellation;return e&&(t=t.concat(e.getConditions(this.levels.constellation))),t=t.concat(DB.Conditions.Character),t}getFeatures(){let t=super.getFeatures();if(!this.object)return t;let e=this.getConstellation();return e&&(t=t.concat(e.getFeatures(this.levels.constellation))),t}getSettings(){let t=super.getSettings(),e=rt.getValue(this.levels.ascension||1),s={char_skill_attack:Math.min(e,this.skills.attack),char_skill_elemental:Math.min(e,this.skills.elemental),char_skill_burst:Math.min(e,this.skills.burst),char_level:this.levels.level,char_ascension:this.levels.ascension,char_constellation:this.levels.constellation};return this.object&&(s.char_id=this.object.getId(),s.char_name=this.object.name,s.char_element=this.object.element,s.char_origin=this.object.origin),t=Object.assign(t,s),t}getConstellation(){return this.object.constellation}getElement(){return this.object&&this.object.getElement()||""}getWeaponType(){return this.object&&this.object.getWeapon()||""}serialize(t){let e=[];if(!this.object)return null;e.push(this.object.getId()),e.push(this.levels.level,this.levels.ascension,this.levels.constellation),e.push(this.skills.attack,this.skills.elemental,this.skills.burst);let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=DB.Chars.getById(t.shift());if(!e)return null;let s=t.shift();if(s<1||s>90)return null;let i=t.shift();if(i<0||i>6)return null;let n=t.shift();if(n<0||n>6)return null;let r=t.shift();if(r<1||r>10)return null;let a=t.shift();if(a<1||a>10)return null;let l=t.shift();if(l<1||l>10)return null;let o=new at;o.set(e),o.setLevels({level:s,ascension:i,constellation:n}),o.setSkills({attack:r,elemental:a,burst:l});let c=o.deserializeConditions(t);return c?(o.setSettings(c),o):null}}class lt extends Y{constructor(){super(),this.levels={level:1},this.resistances={phys:0,anemo:0,cryo:0,geo:0,hydro:0,pyro:0,electro:0,dendro:0}}setLevels(t){this.levels.level=t.level}setResistances(t){for(const e of["anemo","cryo","dendro","electro","geo","hydro","phys","pyro"])this.resistances[e]=parseInt(t[e])||0}getResistances(){return this.object?this.object.getResistances():this.resistances}getStats(){return{stats:new i,settings:{}}}getSettings(){let t=super.getSettings(),e=this.getResistances();return t=Object.assign(t,{enemy_level:this.levels.level,enemy_res_phys:e.phys||0,enemy_res_anemo:e.anemo||0,enemy_res_cryo:e.cryo||0,enemy_res_geo:e.geo||0,enemy_res_hydro:e.hydro||0,enemy_res_pyro:e.pyro||0,enemy_res_electro:e.electro||0,enemy_res_dendro:e.dendro||0}),this.object&&(t.enemy_type=this.object.type,t=Object.assign(t,this.object.getSettings())),t}getConditions(){let t=super.getConditions();return t=t.concat(DB.Conditions.Enemy),t}serialize(t){let e=[];e.push(this.levels.level),this.object?(e.push(2),e.push(this.object.getId())):(e.push(1),e.push(this.resistances.anemo+100),e.push(this.resistances.cryo+100),e.push(this.resistances.dendro+100),e.push(this.resistances.electro+100),e.push(this.resistances.geo+100),e.push(this.resistances.hydro+100),e.push(this.resistances.phys+100),e.push(this.resistances.pyro+100));let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=t.shift();if(e<1||e>110)return null;let s=t.shift(),i=new lt;if(i.setLevels({level:e}),1==s){let e={};for(const s of["anemo","cryo","dendro","electro","geo","hydro","phys","pyro"]){let i=t.shift()-100;if(i<-100||i>1e3)return null;e[s]=i}i.setResistances(e)}else{if(2!=s)return null;{let e=DB.Enemies.getById(t.shift());if(!e)return null;i.set(e)}}let n=i.deserializeConditions(t);return n?(i.setSettings(n),i):null}}const ot=["Attack","Defence","Potion"];class ct extends Y{constructor(){super(),this.food={Attack:{item:null,level:0},Defence:{item:null,level:0},Potion:{item:null,level:0}}}get(t){let e=this.food[t];if(e.item)return e.item}getLevel(t){let e=this.food[t];return e.item?e.level:0}set(t,e,s){this.food[t]={item:e,level:s}}isBeta(){return!1}getSettings(){return{}}getStats(t){let e={stats:new i,settings:{}};for(let t=0;t<ot.length;++t){const s=ot[t];let i=this.food[s];i.item&&e.stats.concat(i.item.getStats(i.level))}return e}getConditions(){return[]}getPostEffects(){return[]}serialize(){let t=[],e=0;for(let s=0;s<ot.length;++s){const i=ot[s];++e;let n=this.food[i];n.item?(t.push(n.item.getId()),t.push(n.level)):t.push(0)}return t.unshift(e),t}static deserialize(t){let e=new ct,s=t.shift();for(let i=0;i<s;++i){let s=ot[i];if(!s)return null;let n=t.shift(),r=0,a=DB.Food.get(s).getById(n);n>0&&(r=t.shift()),a&&(e.food[s]={item:a,level:r})}return e}}class ut extends Y{isBeta(){return!1}getSettings(){return{}}getStats(t){return{stats:new i,settings:new H({})}}getConditions(){return[]}getFeatures(){return DB.Features.Reactions}getPostEffects(){return[]}}const ht={1:"reaction.melt",2:"reaction.vaporize"};class ft{constructor(t){this.name=t&&t.name||"",this.items=t&&t.items||[]}addItem(t){this.items.push(t)}getItems(){return this.items}getfeaturesNames(){let t=dt(this.items);return Object.keys(t)}getItem(t){return mt(t,this.items)}replaceItem(t,e){let s=this.getItem(t);if(s){for(let t of Object.getOwnPropertyNames(s))"id"!=t&&delete s[t];for(let t of Object.getOwnPropertyNames(e))s[t]=e[t]}}deleteItem(t){let e=this.getItem(t);e&&bt(e,this.items)}clone(){return ft.deserialize(this.serialize())}getHash(){return t.pack(this)}serialize(){let t=gt(this.getItems());return t.unshift(0),t.unshift(3),t}static deserialize(t){let e=t.shift(),s=null;if(1==e||2==e||3==e){e>=2&&t.shift();let i=pt(t,0,e);s=new ft({items:i})}return s}static getConditionData(t,e){let s={cond:null,typeId:0,icon:"",object:"",dbObject:null,invalid:!0},i=[],n=[];if("char"==t.subtype){let r=DB.Chars.getById(t.itemId);r&&(s.typeId=1,s.object="char",s.dbObject=r,s.icon="sprite-char "+r.getIcon(),i=r.getAllConditions(),e&&t.itemId==e.getChar().getId()&&(n=i))}else if("weapon"==t.subtype){let r=DB.Conditions.Weapon;i=i.concat(r);let a=DB.Weapons.getById(t.itemId);a&&(s.typeId=2,s.object="weapon",s.icon="sprite-weapon-"+a.weapon+" "+a.getIcon(),i=i.concat(a.getConditions()),e&&t.itemId==e.getWeapon().getId()&&(n=i))}else if("artifacts"==t.subtype){let r=DB.Artifacts.Sets.getById(t.itemId);r&&(s.typeId=3,s.object="artifacts",s.icon="sprite-artifact "+r.getImage()+" flower",i=r.getConditions(5),e&&(n=e.getConditions({objects:[t.subtype]})))}else if("enemy"==t.subtype){if(i=i.concat(DB.Conditions.Enemy),s.typeId=4,s.object="enemy",t.itemId){let e=DB.Enemies.getById(t.itemId);e&&(s.icon="sprite-enemy "+e.getImage(),i=i.concat(e.getConditions()),n=i)}}else if("party"==t.subtype){let r=DB.Chars.getById(t.itemId);if(r&&(s.typeId=5,s.object="buffs",s.icon="sprite-char "+r.getIcon(),i=K.unwrap(r.getPartyConditions()),e)){let s=e.getSettings();for(let e=1;e<=3;++e)s["party_char_"+e]==t.itemId&&(n=i)}}else if("buffs"==t.subtype){let e,r=[];for(const t of DB.Buffs.getList())r=r.concat(t.getConditions());for(let s of K.unwrap(r))if(s.getId()==t.conditionId){e=s;break}e&&(s.typeId=6,s.object="buffs",s.icon=e.getIcon(),i=[e],n=i)}for(const e of i)if(e.getId()==t.conditionId){s.cond=e;break}for(const e of n)if(e.getId()==t.conditionId){s.invalid=!1;break}return s}static getArtSetByCondition(t){for(const e of DB.Artifacts.Sets.getList())for(const s of e.getConditions(5))if(s.getId()==t)return e.getId();return 0}static getEnemyByCondition(t){for(const e of DB.Enemies.getList())for(const s of e.getConditions())if(s.getId()==t)return e.getId();return 0}}function gt(t){let e=[],s=0;for(const i of t)if(i)if(e.push(i.disabled?1:0),e.push(i.collapsed?1:0),"feature"==i.type){let t=DB.Features.Rotation.getByName(i.feature);t&&(++s,e.push(1),e.push(t),e.push(Math.max(1,i.count)),e.push(i.reaction||0))}else if("condition"==i.type){let t=ft.getConditionData(i);if(t.cond){let n;++s,e.push(2),e.push(t.typeId),e.push(i.itemId),e.push(t.cond.params.serializeId),n="decimal"==t.cond.params.format?Math.floor(10*parseFloat(i.value)):+i.value,e.push(n||0)}}else if("repeat"==i.type){++s,e.push(3),e.push(Math.max(1,i.count));let t=gt(i.items);e=e.concat(t)}else if("uptime"==i.type){++s,e.push(4),e.push(1),e.push(Math.min(100,Math.max(0,i.percent)));let t=gt([].concat(i.conditions,i.features));e=e.concat(t)}return e.unshift(s),e}function pt(t,e,s){let n=t.shift(),r=[];for(let a=0;a<n;++a){let n={disabled:!1};s>=2&&(n.disabled=!!t.shift()),s>=3&&(n.collapsed=!!t.shift());let a=t.shift();if(n.id=++e,1==a){n.type="feature";let e=t.shift();if(n.feature=DB.Features.Rotation.getById(e),!n.feature)return null;n.count=Math.max(1,t.shift()),n.reaction=t.shift()}else if(2==a){n.type="condition";let e=t.shift();if(1==e)n.subtype="char";else if(2==e)n.subtype="weapon";else if(3==e)n.subtype="artifacts";else if(4==e)n.subtype="enemy";else if(5==e)n.subtype="party";else{if(6!=e)return null;n.subtype="buffs"}n.itemId=t.shift(),n.conditionId=t.shift();let s=ft.getConditionData(n),r=t.shift();s&&s.cond&&"decimal"==s.cond.params.format&&(r=i.format("text_decimal",r/10,{no_decimal_zero:!0})),n.value=r}else if(3==a)n.type="repeat",n.count=Math.max(1,t.shift()),n.items=pt(t,e,s),e+=n.items.length;else{if(4!=a)return null;{n.type="uptime",n.typeId=t.shift(),n.percent=Math.min(100,Math.max(0,t.shift())),n.conditions=[],n.features=[];let i=pt(t,e,s);e+=i.length;for(let t of i)"condition"==t.type?n.conditions.push(t):n.features.push(t)}}r.push(n)}return r}function dt(t){let e={};for(const s of t){"feature"==s.type&&(e[s.feature]=1);for(let t of["items","conditions","features"])if(s.hasOwnProperty(t)){let i=dt(s[t]);e=Object.assign(e,i)}}return e}function mt(t,e){for(let s of e){if(s.id==t)return s;for(let e of["items","conditions","features"])if(s.hasOwnProperty(e)){let i=mt(t,s[e]);if(i)return i}}return null}function bt(t,e){let s=e.indexOf(t);if(s>=0)return e.splice(s,1),1;for(let s of e)for(let e of["items","conditions","features"])if(s.hasOwnProperty(e)){if(bt(t,s[e]))return 1}return 0}class yt extends I{compile(t){return`Math.max(0, Math.min(1, ${super.compile(t)}))`}}class wt extends B{}class St extends d{getType(){return"damage_result"}isCollapsable(){return!1}compile(t){return"["+this.compileChildrens(t).join(", ")+"]"}getSignature(){return null}}class vt extends O{getType(){return"damage_rotation_result"}makeResult(t){return t=Object.assign({},t),new m([...this.items,new St(this.vars)])}}class _t{constructor(t){if(this.critChance=0,this.critMulti=1,t){let e=Object.keys(t);for(let s=0;s<e.length;++s){const i=e[s];this[i]=t[i]}}this.calcCritValues()}isHealing(){return this.icon&&"heal"==this.icon}calcCritValues(){void 0===this.average&&(this.normal?(this.crit=this.normal*this.critMulti,this.average=this.normal*(1-this.critChance)+this.crit*this.critChance):(this.normal=0,this.crit=0,this.average=0))}clone(){let t=Object.assign({},this);return Object.setPrototypeOf(t,_t.prototype),t}}class Ct{constructor(t){this.name=t.name||(t.multipliers&&t.multipliers.length>0?t.multipliers[0].getName():""),this.isChild=t.isChild,this.hits=t.hits,this.icon=t.icon,this.tags=t.tags||[],this.multipliers=t.multipliers||[],this.category=t.category,this.condition=t.condition,this.element="",this.damageType="",this.rotationHitDescription=t.rotationHitDescription||"",this.rotationHitCount=t.rotationHitCount||1,this.critRateBonuses=t.critRateBonuses||[],this.critDamageBonuses=t.critDamageBonuses||[]}getDamageType(){return this.damageType}getElement(){return this.element}getName(){return this.category+"."+this.name}getIsChild(){return this.isChild}getHits(){return this.hits}getTags(){return this.tags}isRotation(){return!1}hasDetails(){return!1}canReact(){}usedInRotation(){return!1}isActive(t){return!this.condition||this.condition.isActive(t.settings)}compile(t){this.compiled=this.getCompiled(t)}getDisplaySettings(t){}getMultipliers(t){let e=[];for(let s of this.multipliers)s.isActive(t)&&e.push(s);for(let s of t.multipliers)s.isActive(t)&&s.isMatchFeature(this,t)&&e.push(s);return e}getActivePostEffectsTree(t){return t.getActivePostEffectsTree()}getCritRateBlock(t){let e=this.getStatsCritRate(t).map((e=>_(e,t.stats)));return 0==e.length&&(e=[new y({value:0})]),new yt(e)}getCritDmgBlock(t){let e=this.getStatsCritDamage(t).map((e=>_(e,t.stats)));return 0==e.length&&(e=[new y({value:0})]),new wt(e)}getCompiled(t,e){if(this.compiled)return this.compiled;e=Object.assign({dontProcessTree:1},e);let s=this.getTree(t),i=this.getActivePostEffectsTree(t),n=new R(s,i);return t.settings.reaction&&n.checkForReaction(),t.stats.ensure(n.usedStats),t.stats.ensure(n.assignedStats),n.prepare(t,e),n.compile(e),n}checkConditions(t){return!this.condition||this.condition.isActive(t.settings)}compile(t,e){let s=this.getTree(t);return this.compileTree(s,e)}compileTree(t,e){return e=Object.assign({},e),t.compile(e)}getResult(t){if(!this.checkConditions(t))return{};let e=this.getCompiled(t),[s,i,n]=e.execute(t);return{[this.getName()]:new _t({icon:this.icon||this.getElement(t),normal:s,crit:i,average:n,isReacted:e.isReacted,format:this.format,digits:this.digits,damageType:this.damageType,noCritValues:this.noCritValues})}}getUsedStats(t){let e=this.getTree(t),s=t.getActivePostEffectsTree(),i=new R(e,s);return t.stats.ensure(i.usedStats),i.prepare(t,{}),g(i.processed)}getRotationHitMiltiplier(t){return this.rotationHitCount}getDisplayRotationHitMiltiplier(t){return this.getRotationHitMiltiplier(t)}getRotationHitDescription(){return this.rotationHitDescription}static getTree(t){let e={};for(const s of Object.keys(t)){let i=s.split("."),n=i.shift(),r=i.join(".");void 0===e[n]&&(e[n]={}),e[n][r]=t[s]}return e}static buildDropdown(t,e){e=Object.assign({},e);let s=[],i=t.getFeaturesHash(t.getBuildData(),e),n=Ct.getTree(i);for(let t of Object.keys(n)){s.push({isCaption:!0,value:"section_"+t,text:UI.Lang.get("feature_section."+t)});for(let e of Object.keys(n[t])){let i=n[t][e];if(i.hidden)continue;let r=t+"."+e,a="feature_"+r;i.title&&(a=i.title),a=UI.Lang.get(a),i.isChild&&(a=" "+a),s.push({value:r,text:a,isSubitem:!0,isChild:!!i.isChild})}}return s}}const kt=["","melt","vaporize","quicken"];class jt{constructor(t,e){t=[].concat(t),this.infoBlock,t.length>0&&"info"==t[0].type&&(this.infoBlock=t.shift()),this.items=t,this.opts=Object.assign({},e)}getTree(t,e){let[s,i,n,r]=this.processBlock(this.items,t,{usedStats:e});return new vt(s,{vars:[new v({ref:i}),new v({ref:n}),new v({ref:r})]})}processBlock(t,e,s){let i=new T([new y({value:0})],{name:"total_normal"}),n=new T([new y({value:0})],{name:"total_crit"}),r=new T([new y({value:0})],{name:"total_average"}),a=[i,n,r],l=e.clone(),o=l.settings?l.settings.rotation_include:"",c=[],u=[],h=[];t=function(t){let e=[],s=[];for(let i of t)"feature"==i.type?e.push(i):"condition"==i.type?(s&&(e=e.concat(s),s=[]),e.push(i)):("repeat"==i.type||"uptime"==i.type)&&s.push(i);s&&(e=e.concat(s));return e}(t),this.opts.ignoreSideEffects||(s=Ot(s));for(let e of t)if("feature"==e.type){l.settings.reaction=Bt(e);let t=Dt(e.feature,l);if(!t)continue;if(!t.usedInRotation())continue;if(o){let e=t.getElement(l),s=t.getDamageType();if(o!=e&&o!=s)continue}let a=t.getTree(l);Tt(a,s);let u=[new y({value:e.count,comment:"rotation_hit_count"}),new O(a.items)],h=t.getRotationHitMiltiplier(l);"object"==typeof h?u.push(h):1!=h&&u.push(new y({value:h,comment:"rotation_hit_multi"}));let f=new T([new O(u)],{name:"normal"}),g=new T([a.critRate],{name:"crit_rate"}),p=new T([a.critDmg],{name:"crit_dmg"}),d=new T([new O([new v({ref:f}),new v({ref:p})])],{name:"crit_hit"}),m=[];a.royalCrit&&([m,g]=j(g,a.royalCrit)),m.length>0&&(c=c.concat(m)),c.push(f),c.push(g),c.push(p),c.push(d),c.push(new P([new v({ref:f})],{ref:i})),c.push(new P([new v({ref:d})],{ref:n})),c.push(new P([new O([new v({ref:f}),new D([new y({value:1}),new v({ref:g})])]),new O([new v({ref:d}),new v({ref:g})])],{ref:r}))}else if("condition"==e.type){if(c.length||u.length||h.length){let t=It(c,u,h,s);t&&a.push(t),c=[],u=[],h=[]}for(let t of Object.keys(e.stats)){if(/^text_/.test(t))continue;let i={stat:t};if(s.copyStats){let e=zt(s,t),n=At(t);i={stat:e,newName:n},s.stats[t]=n}u.push(new x([new y({value:e.stats.get(t)})],i))}s.usedStats&&e.stats.truncate(s.usedStats),l.addStats(e.stats),l.addSettings(e.settings);let t=s&&s.stats?Object.keys(s.stats):[];for(let i of e.postEffects)if(i.getTree)for(let e of i.getTree(l,s))t.includes(e.stat)&&(e.stat=s.stats[e.stat]),Tt(e,s),h.push(e)}else if("repeat"==e.type){if(c.length||u.length||h.length){let t=It(c,u,h,s);t&&a.push(t),c=[],u=[],h=[]}let[t,o,f,g]=this.processBlock(e.items,l,Ot(s));c.push(It([...t,...[[o,i],[f,n],[g,r]].map((t=>{let[s,i]=t;return new P([new O([new y({value:e.count}),new v({ref:s})])],{ref:i})}))],[],[],s))}else if("uptime"==e.type){if(c.length||u.length||h.length){let t=It(c,u,h,s);t&&a.push(t),c=[],u=[],h=[]}if(e.percent>0){let t=e.percent/100,[a,o,u,h]=this.processBlock([...e.conditions,...e.items],l,Ot(s));c.push(It([...a,...[[o,i],[u,n],[h,r]].map((e=>{let[s,i]=e;return new P([new O([new y({value:t}),new v({ref:s})])],{ref:i})}))],[],[],s))}if(e.percent<100){let t=1-e.percent/100,[a,o,u,h]=this.processBlock(e.items,l,Ot(s));c.push(It([...a,...[[o,i],[u,n],[h,r]].map((e=>{let[s,i]=e;return new P([new O([new y({value:t}),new v({ref:s})])],{ref:i})}))],[],[],s))}}if(c.length||u.length||h.length){let t=It(c,u,h,s);t&&a.push(t)}return[a,i,n,r]}}function It(t,e,s,i){if(0==t.length&&0==e.length)return null;let n=g(...t),r=t,a=R.filterPostByStats(s,n);if(a.length){let[t,e]=R.postTreeBlocks(a);r=[...t,new E(r),...e]}return e.length&&(r=[...e,...r]),new E(r)}function Bt(t){return kt[t.reaction||0]}function Dt(t,e){t=Array.isArray(t)?t:[t];for(let s of t)if(s.isActive(e)&&s.usedInRotation())return s}function Ot(t){let e=Object.assign({},t);if(e.stats={},e.copyStats=!0,t.stats)for(let s of Object.keys(t.stats))e.stats[s]=t.stats[s];return e}function zt(t,e){return t.stats&&t.stats[e]||e}function At(t){return k(t)}function Tt(t,e){if(e.stats){let s=Object.keys(e.stats);t.walk((t=>{if("item_stat_total"==t.getType())for(let i of[t.stat,t.stat+"_base",t.stat+"_percent"])s.includes(i)&&(t.replace||(t.replace={}),t.replace[i]=e.stats[i]);else t.stat&&s.includes(t.stat)&&(t.stat=e.stats[t.stat])}))}}class Pt extends Ct{constructor(t){super(t),this.items=t.items}getName(){return"rotation.total"}getTree(t,e){return new jt(this.items,e).getTree(t)}compile(t,e){let s=this.getTree(t,e);return this.compileTree(s,e)}compileTree(t,e){return e=Object.assign({},e),t.compile(e)}getResult(t){if(!this.checkConditions(t))return{};let e=this.getCompiled(t),[s,i,n]=e.execute(t),r=this.getElement(t);return t.settings&&t.settings.rotation_include&&(r=t.settings.rotation_include),{[this.getName()]:new _t({icon:r,normal:s,crit:i,average:n})}}getResultForEditor(t){let e=t.getBuildData();return this.processBlock(this.items,e)}processBlock(t,e){let s=[];for(let i of t)if("feature"==i.type){e.settings.reaction=Bt(i);let t=Ft(i.feature,e);if(t){let n=t.getResult(e)[t.getName()];s.push({result:n,count:i.count,subLine:Et(i.feature,e)})}else s.push({})}else if("condition"==i.type)i.settings&&e.addSettings(i.settings),i.stats&&e.addStats(i.stats),i.postEffects&&i.postEffects.length&&(e.postEffects=i.postEffects),i.multipliers&&i.multipliers.length&&(e.multipliers=i.multipliers);else if("repeat"==i.type){let t=e.clone();t.addSettings({inside_rotation_block:1});let n=this.processBlock(i.items,t);s=s.concat(n)}else if("uptime"==i.type){let t=e.clone();t.addSettings({inside_rotation_block:1});let n=t.clone(),r=this.processBlock(i.items,t),a=this.processBlock(i.conditions.concat(i.items),n),l=i.percent/100,o=1-l;for(let t=0;t<r.length;++t){let e=r[t].result,s=a[t].result;if(e||s){s?e||(r[t]=Object.assign({},a[t]),e=r[t].result={normal:0,crit:0,average:0}):s={normal:0,crit:0,average:0};for(let t of["normal","crit","average"])e[t]=e[t]*o+s[t]*l}}s=s.concat(r)}else"invalid"==i.type&&s.push({});return s}getDisplaySettings(t){let e={},s={},i=[{settings:{rotation_include:null},setTotal:1,icon:"multi"}];!function t(e,s,i,n){let r=s.clone();for(let s of e)if("feature"==s.type){let t=Ft(s.feature,r);t&&(i[t.getElement(r)]=1,n[t.getDamageType()]=1)}else"condition"==s.type?(s.settings&&r.addSettings(s.settings),s.stats&&r.addStats(s.stats)):"repeat"==s.type?t(s.items,r,i,n):"uptime"==s.type&&(t(s.items,r,i,n),t([...s.conditions,...s.items],r,i,n))}(this.items,t,e,s);for(let t of Object.keys(e))i.push({id:"rotation.total_"+t,title:"rotation."+t,isChild:!0,settings:{rotation_include:t},getTotal:1});for(let t of Object.keys(s))i.push({id:"rotation.total_"+t,title:"rotation."+t,icon:"multi",isChild:!0,settings:{rotation_include:t},getTotal:1});return i}}function Ft(t,e){t=Array.isArray(t)?t:[t];for(let s of t)if(s.isActive(e)&&s.usedInRotation())return s}function Et(t,e){let s=Ft(t,e),i=s.getRotationHitDescription(e);if(i)return{descr:"talent_descr."+i,value:s.getDisplayRotationHitMiltiplier(e)}}class xt{constructor(t,e,s){this.build=t,this.rotation=e,this.opts=Object.assign({},s)}buildFeaturesList(){let t={},e=this.rotation.getfeaturesNames();for(let t of Object.keys(ht))e.push(ht[t]);for(let s of e){let e=this.build.getAllFeaturesByName(s,{ignoreRotation:!0});e.length&&(t[s]=e)}if(this.opts.loadArtifactsFeatures){let e=this.build.getBuildData();for(let s of DB.Artifacts.Sets.getList())for(let i of s.getFeatures(5)){let s=i.getResult(e.stats,e.settings);for(let e of Object.keys(s))t[e]=i}}return t}processConditions(t){if(0==this.conditions.length)return;let e=t.getBuildData(),s={},n=0;for(const i of this.conditions){let r,a={};if(i.static)a=i.getSettings(e.settings),r=i.object,++n;else{let e=ft.getConditionData(i,t);if(!e.invalid&&e.cond&&e.cond.getName()&&Lt.includes(e.object)){++n,r=e.object;let t=e.cond.getType();a[e.cond.getName()]="dropdown"==t||"dropdown_multiple"==t?e.cond.getValueById(i.value):i.value}}r&&(s=Object.assign(s,a),t[r].addSettings(a),t.setCommonSettings(a))}if(this.conditions=[],!n)return;let r=t.getBuildData(),a=r.getActivePostEffects(),l=i.diff(e.stats,r.stats),o=function(t,e){let s={};for(let i of Object.keys(e))void 0!==t[i]&&t[i]==e[i]||(s[i]=e[i]);for(let i of Object.keys(t))void 0===e[i]&&(s[i]=void 0);return s}(e.settings,r.settings);return Object.keys(l).length||Object.keys(o).length||a.length?{type:"condition",stats:l,settings:o,postEffects:a}:void 0}processBlock(t,e,s){let i=[],n=[],r=e.filter((t=>!t.disabled));r.length&&"condition"!=r[0].type&&n.push({type:"condition",static:1,getSettings:()=>({})});for(const t of e)if(n.push(t),"feature"==t.type&&this.features[t.feature])for(let e of this.features[t.feature])if(e&&e.getRotationAfterItems){let i=e.getRotationAfterItems(t,{insideBlock:s});for(const t of i)n.push(t)}for(const e of n)if(!e.disabled){if("condition"!=e.type){let e=this.processConditions(t);e&&i.push(e)}if("feature"==e.type){let t=this.features[e.feature];if(t){++this.featuresTotal;let s={type:e.type,feature:t,featureName:e.feature,count:e.count,reaction:e.reaction};i.push(s)}else i.push({type:"invalid"})}else if("condition"==e.type)this.conditions.push(e);else if("repeat"==e.type){let s=this.processBlock(t,e.items,1);s&&i.push({type:e.type,count:e.count,items:s})}else if("uptime"==e.type){let s=this.processBlock(t,e.features,1);if(!s)continue;let n=this.processBlock(t,e.conditions,1);0==n.length?i.push({type:"repeat",count:1,items:s}):i.push({type:e.type,percent:e.percent,conditions:n,items:s})}}let a=this.processConditions(t);return a&&i.push(a),i}buildInfoBlock(){let t={type:"info"},e=0;if(this.sideEffectStats.length&&(e=1,t.sideEffectStats=this.sideEffectStats),e)return t}compile(){this.features=this.buildFeaturesList(),this.featuresTotal=0,this.conditions=[],this.sideEffectStats=[];let t=[].concat(this.rotation.getItems());t.unshift({type:"condition",static:1,getSettings:()=>({})});let e=this.processBlock(this.build.cloneWithArtifactSettings(),t);if(0==this.featuresTotal)return null;let s=this.buildInfoBlock();return s&&e.unshift(s),new Pt({name:this.rotation.name,items:e})}}class Nt extends Y{constructor(){super(),this.object=new ft}set(t){this.object=t?t.clone():new ft}isBeta(){return!1}getConditions(){return[]}getFeatures(){return[]}getPostEffects(){return[]}getSettings(){return[]}getMultipliers(){return[]}serialize(){return this.object.serialize()}static deserialize(t){if(0==t.length)return new Nt;let e=ft.deserialize(t),s=new Nt;return s.set(e),s}}class Rt extends Y{isBeta(){return!1}getSettings(){return{}}getStats(t){return{stats:new i,settings:new H({})}}getConditions(){return[]}getFeatures(){return DB.Features.Stats}getPostEffects(){return[]}}class Mt extends Y{constructor(){super(),this.levels={level:1,ascension:0,refine:1}}setLevels(t){this.levels.level=t.level,this.levels.ascension=t.ascension,this.levels.refine=Math.min(5,Math.max(1,t.refine))}getStats(){var t=super.getStats();if(this.object&&this.object.refineTable)for(let e of this.object.refineTable)t.stats.add(e.getName(),e.getValue(this.levels.refine));return t}getSettings(){let t=super.getSettings(),e={weapon_level:this.levels.level,weapon_ascension:this.levels.ascension,weapon_refine:this.levels.refine};return this.object&&(e.weapon_id=this.object.getId(),e.weapon_type=this.object.weapon),t=Object.assign(t,e),t}getId(){return this.object?this.object.getId():0}getName(){return this.object?this.object.getName():""}getConditions(){let t=super.getConditions();return t=t.concat(DB.Conditions.Weapon),t}serialize(t){let e=[];if(!this.object)return null;e.push(this.object.getId()),e.push(this.levels.level,this.levels.ascension,this.levels.refine);let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=DB.Weapons.getById(t.shift());if(!e)return null;let s=t.shift();if(s<1||s>90)return null;let i=t.shift();if(i<0||i>6)return null;let n=t.shift();if(n<0||n>5)return null;let r=new Mt;r.set(e),r.setLevels({level:s,ascension:i,refine:n||1});let a=r.deserializeConditions(t);return a?(r.setSettings(a),r):null}}const Lt=["char","weapon","artifacts","enemy","buffs","rotation","food","reaction","static"],Vt=["char","weapon","artifacts","enemy","buffs","rotation","food"];class Ht{constructor(){this.char=new at,this.weapon=new Mt,this.artifacts=new tt,this.enemy=new lt,this.buffs=new it,this.rotation=new Nt,this.food=new ct,this.reaction=new ut,this.static=new Rt}getChar(){return this.char}setChar(t){let e=this.getCommonSettings("char");this.char.set(t);let s="";this.weapon.object&&(s=this.weapon.object.weapon),s!=t.weapon&&this.setWeapon(DB.Weapons.get(t.weapon).getFirst());let i=this.buffs.getPartyChars();this.buffs.setPartyChars(i.filter((e=>e!=t.getId()))),this.setCharSettings(e)}setCharLevels(t){this.char.setLevels(t)}setCharSkills(t){this.char.setSkills(t)}setCharSettings(t){this.char.setSettings(t),this.setCommonSettings(t)}getWeapon(){return this.weapon}setWeapon(t){let e=this.getCommonSettings("weapon");this.weapon.set(t),this.setWeaponSettings(e)}setWeaponLevels(t){this.weapon.setLevels(t)}setWeaponSettings(t){this.weapon.setSettings(t),this.setCommonSettings(t)}setEnemy(t){this.enemy.set(t)}setEnemyLevels(t){this.enemy.setLevels(t)}setEnemyResistances(t){this.enemy.setResistances(t)}setEnemySettings(t){this.enemy.setSettings(t),this.setCommonSettings(t)}getEnemy(){return this.enemy}setArtifact(t){this.artifacts.set(t)}replaceArtifacts(t){this.artifacts.replace(t)}getArtifacts(){return this.artifacts.get()}getArtifactsHashList(){let t=[],e=this.getArtifacts();return Object.keys(e).forEach((function(s){let i=e[s];i&&t.push(i.getHash())})),t}removeArtifact(t){this.artifacts.remove(t)}clearArtifacts(){this.artifacts.clearArtifacts()}setArtifactsSettings(t){this.artifacts.setSettings(t),this.setCommonSettings(t)}isEquipped(t){return this.artifacts.isEquipped(t)}getBuffs(){return this.buffs.get()}setBuffsSettings(t){this.buffs.setSettings(t),this.setCommonSettings(t)}modifyBuffsSettings(t){let e=this.buffs.modifySettings(t);this.setCommonSettings(e)}setPartyChars(t){this.buffs.setPartyChars(t)}getPartyChars(){return this.buffs.getPartyChars()}setRotation(t){this.rotation.set(t)}getRotation(){return this.rotation.get()}setFood(t,e,s){return this.food.set(t,e,s)}getFood(t){return this.food.get(t)}getFoodLevel(t){return this.food.getLevel(t)}hasBetaContent(){for(let t of Lt)if(this[t]&&this[t].isBeta())return!0;return!1}refreshCommonSettings(){let t=this.getSettings();for(let e of Lt){if(!this[e])continue;let s=this[e].getSettings(),i=this.getActiveConditions(t,{objects:[e]});K.setCommonValues(s,i),this[e].setSettings(s)}}getCommonSettings(t){let e=this.getSettings(),s=this[t].getSettings();for(let t of Object.keys(e))/^common\./.test(t)&&(s[t]=e[t]);return s}setCommonSettings(t){let e=[];for(const s of Object.keys(t))/^common\./.test(s)&&e.push(s);if(0!=e.length)for(let s of Lt){if(!this[s])continue;let i=this[s].getSettings();for(const s of Object.keys(i))e.includes(s)&&(i[s]=t[s]);this[s].setSettings(i)}}getConditions(t){let e=[],s=Lt;for(let i=0;i<s.length;++i){let n=s[i];this[n]&&(t&&t.objects&&!t.objects.includes(n)||(e=e.concat(this[n].getConditions())))}return e}getActiveConditions(t,e){let s=[],i=Lt;for(let n=0;n<i.length;++n){let r=i[n];if(!this[r])continue;if(e&&e.objects&&!e.objects.includes(r))continue;let a=this[r].getConditions();for(let e=0;e<a.length;++e){const i=a[e];i.params.hideInactive&&!i.checkSubconditions(t)||s.push(i)}}return s}getArtifactsConditions(){return this.artifacts?this.artifacts.getConditions():[]}getSettings(){let t={},e=Lt;for(let s=0;s<e.length;++s){let i=e[s];this[i]&&(t=Object.assign(t,this[i].getSettings()))}return t}getBaseStats(t,e){let s=new U;t&&s.stats.concat(t),s.settings.concat(this.getSettings(),e);let i=Lt;for(let t=0;t<i.length;++t){let e=i[t];if(!this[e])continue;let n=this[e].getConditions();for(let t=0;t<n.length;++t){let e=n[t].getData(s.settings);s.stats.concat(e.stats),s.settings.concat(s.settings,e.settings)}}for(let t=0;t<i.length;++t){let e=i[t];if(!this[e])continue;let n=this[e].getStats(s.settings);s.stats.concat(n.stats),s.settings.concat(s.settings,n.settings)}return s.stats.get("dmg_own")&&s.stats.add("dmg_"+s.settings.char_element,s.stats.get("dmg_own")),s.multipliers=this.getMultipliers(),s.postEffects=this.getPostEffects(),s}getBaseStatsWithSets(t,e){let s=this.getBaseStats(t,e),i=this.getPostEffects();return s.stats.applyPostEffects(s.settings,i,V),s}getPostEffects(){let t=[],e=Lt;for(let s=0;s<e.length;++s){let i=e[s];this[i]&&(t=t.concat(this[i].getPostEffects()))}return t}getMultipliers(){let t=[];for(let e of Lt)this[e]&&(t=t.concat(this[e].getMultipliers()));return t=t.concat(DB.CalcData.Multipliers),t}getStats(t,e){return this.getBaseStats(t,e)}getBuildData(t,e){let s=this.getBaseStats(t,e);return s.stats.processPercent(),s}calcFeatures(t){let e=this.getBuildData();return this.getFeatures(e,t)}getFeaturesList(t){let e=[];t=Object.assign({},t);for(let s of Lt){if(!this[s])continue;let i;if("rotation"==s){if(!t.ignoreRotation){let t=this.compileRotation();t&&(i=[t])}}else i=this[s].getFeatures();i&&(e=e.concat(i))}return e}compileRotation(){return new xt(this,this.getRotation()).compile()}getFeaturesHash(t,e){e=Object.assign({},e);let s={};for(let i of this.getFeaturesList())t&&!i.checkConditions(t)||e.checkCallback&&!e.checkCallback(i)||(s[i.getName()]=i);return s}getFeatures(t){let e={};for(let s of this.getFeaturesList())e=Object.assign(e,s.getResult(t));return e}getFeaturesNames(){let t={},e=this.getStats(),s=this.getFeaturesList();for(let i=0;i<s.length;++i){const n=s[i];Object.assign(t,n.getFeatureNamesHash(e.stats,e.settings))}return t}getFeatureResultByName(t){let e=this.getFeatureByName(t);if(!e)return;let s=this.getBuildData();return e.getResult(s)[t]}getFeatureByName(t,e){if(!t)return null;e||=this.getBuildData();for(let s of this.getFeaturesList())if(s.isActive(e)&&t==s.getName())return s;return null}getAllFeaturesByName(t,e){if(!t)return[];let s=[];for(let i of this.getFeaturesList(e))t==i.getName()&&s.push(i);return s}clone(){return Ht.deserialize(this.serialize())}cloneWithArtifactSettings(){let t=Ht.deserialize(this.serialize());return t.artifacts.modifySettings(this.artifacts.getSettings()),t}getHash(){return t.pack(this)}serialize(){let t=[1],e=this.getSettings();for(let t of Lt)if(this[t])for(let s of this[t].getConditions()){let t=s.getData(e);Object.assign(e,t.settings)}for(let s of Vt){if(!this[s])return null;let i=this[s].serialize(e);if(!i)return null;t=t.concat(i)}return t}static deserialize(t){let e=null;if(1==t.shift()){if(e=new Ht,e.char=at.deserialize(t),!e.char)return null;if(e.weapon=Mt.deserialize(t),!e.weapon)return null;if(e.artifacts=tt.deserialize(t),!e.artifacts)return null;if(e.enemy=lt.deserialize(t),!e.enemy)return null;if(e.buffs=it.deserialize(t),!e.buffs)return null;if(e.rotation=Nt.deserialize(t),!e.rotation)return null;if(e.food=ct.deserialize(t),!e.food)return null}return e}}importScripts("db.js?3.1.3b"),self.onmessage=function(t){let e=[];for(let s of t.data.artifacts)e.push(h.deserialize(s));let s=new q({build:Ht.deserialize(t.data.calcset),artifacts:e,featureName:t.data.feature,featureType:t.data.featureType,settings:t.data.settings,limit:t.data.limit});s.prepare();let i=s.getResult(((t,e,s)=>{self.postMessage({count:t,total:e,skipped:s})}));if(i.length>0){for(let t of i){let e=[];for(let s of t.artifacts)e.push(s?s.serialize():null);t.artifacts=e}self.postMessage({result:i})}else self.postMessage({result:[]})}})();