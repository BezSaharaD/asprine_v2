(()=>{"use strict";class t{static pack(t){let s=t.serialize(),i="";if(s){for(const t of s)i+=e(t);return i}}static unpack(t){let e=t.split(""),s=[],i=0;for(;e.length>0;){let t=e.shift();"\0"==t&&(t="b");let r=t.toUpperCase().charCodeAt(0)-65;if(r<0&&r>25)return null;i+=r,t.toLowerCase()==t?(s.push(i),i=0):i*=26}return i&&s.push(i),s}}function e(t){let e=parseInt(t),s="";for(;e>25;){let t=e%26;e-=t,e/=26,s=String.fromCharCode(65+t)+s}s=String.fromCharCode(65+e)+s;let i=s.substring(s.length-1);return s.substring(0,s.length-1).toUpperCase()+i.toLowerCase()}const s=new Map;new Map;class i{constructor(t){if(t){const e=Object.keys(t);for(let s=0;s<e.length;s++)this[e[s]]=t[e[s]]}}add(t,e){this[t]=(this[t]||0)+e}set(t,e){this[t]=e}get(t){return this[t]||0}del(t){delete this[t]}isSet(t){return this.hasOwnProperty(t)}getTotal(t){const e=this[t+"_base"]||0;let s=this[t]||0;const i=this[t+"_percent"]||0;return i&&e&&(s+=e*(i/100)),e+s}getTotalPercent(t){return(this[t+"_base"]||0)*(1+(this[t+"_percent"]||0))+(this[t]||0)}getBaseBonus(t){let e=this["base_dmg_bonus_"+t]||0,s=this[t+"_base_atk_percent"];return s&&(e+=this.getTotal("atk")*s/100),s=this[t+"_base_def_percent"],s&&(e+=this.getTotal("def")*s/100),s=this[t+"_base_hp_percent"],s&&(e+=this.getTotal("hp")*s/100),s=this[t+"_base_mastery_percent"],s&&(e+=this.getTotal("mastery")*s/100),e}isEmpty(){return 0===Object.keys(this).length}concat(t){const e=Object.keys(t);for(let s=0;s<e.length;s++){const i=e[s];this[i]=(this[i]||0)+t[i]}}clear(){const t=Object.keys(this);for(let e=0;e<t.length;e++)delete this[t[e]]}copyFrom(t){this.clear();const e=Object.keys(t);for(let s=0;s<e.length;s++)this[e[s]]=t[e[s]]}getSetFunc(){const t=Object.keys(this).sort(),e=t.join(",");if(s.get(e)){const e=t.map((t=>this[t]));return this._createSetFunc(t,e)}const i=[];for(let e=0;e<t.length;e++)i.push(`stats.${t[e]} = ${this[t[e]]}`);const r=Function("stats",i.join(";"));return s.set(e,!0),r}_createSetFunc(t,e){const s=[];for(let i=0;i<t.length;i++)s.push(`stats.${t[i]} = ${e[i]}`);return Function("stats",s.join(";"))}getConcatFunc(t){const e=Object.keys(this),s=[];for(let t=0;t<e.length;t++)s.push(`stats.${e[t]} += ${this[e[t]]}`);if(t){const e=Object.keys(t);for(let i=0;i<e.length;i++)s.push(`stats.${e[i]} = ${t[e[i]]}`)}return Function("stats",s.join(";"))}truncate(t){const e=Object.keys(this);for(let s=0;s<e.length;s++)t.includes(e[s])||delete this[e[s]]}ensure(t){for(let e=0;e<t.length;e++)this[t[e]]||(this[t[e]]=0)}processPercent(){const t=Object.keys(this);for(let e=0;e<t.length;e++)l(t[e])&&(this[t[e]]=this[t[e]]/100)}revertPercent(){const t=Object.keys(this);for(let e=0;e<t.length;e++)l(t[e])&&(this[t[e]]=100*this[t[e]])}calcPost(){const t=this.calcTotals();if(this.post_atk_hp_bonus){const e=(this.post_atk_hp_bonus||0)/100;this.atk=(this.atk||0)+(t.hp_total||0)*e}}calcTotals(t){const e=new i;t||="";const s=["atk","def","hp"];for(let i=0;i<s.length;i++){const r=s[i];if(t&&t!==r)continue;const n=this[r+"_base"]||0,a=n*(this[r+"_percent"]||0)/100+(this[r]||0),l=n+a;e[r+"_base"]=n,e[r+"_bonus"]=a,e[r+"_total"]=l}const r=["crit_rate","crit_dmg","mastery","healing","healing_recv","recharge","shield","recovery"];for(let s=0;s<r.length;s++){const i=r[s];if(t&&t!==i)continue;const n=this[i+"_base"]||0,a=this[i]||0,l=n+a;e[i+"_base"]=n,e[i+"_bonus"]=a,e[i+"_total"]=l}const n=["anemo","geo","electro","pyro","cryo","hydro","phys"],a=["dmg_","res_"];for(let s=0;s<n.length;s++)for(let i=0;i<a.length;i++){const r=a[i]+n[s];if(t&&t!==r)continue;const l=this[r+"_base"]||0,o=this[r]||0,c=l+o;e[r+"_base"]=l,e[r+"_bonus"]=o,e[r+"_total"]=c}return e}applyPostEffects(t,e,s){if(!e||!e.length)return;const r={};for(let t=0;t<e.length;t++){const i=e[t],n=i.getPriority();s&&n>s||(r[n]||(r[n]=[]),r[n].push(i))}const n=Object.keys(r).sort(((t,e)=>t-e));for(let e=0;e<n.length;e++){const s=new i,a=r[n[e]];for(let e=0;e<a.length;e++){const i=a[e].getData(this,t);s.concat(i)}this.concat(s)}}getFormatted(t,e){return i.format(t,this[t]||0,e)}revert(){const t=new i,e=Object.keys(this);for(let s=0;s<e.length;s++)t[e[s]]=-1*this[e[s]];return t}static roundStatValue(t,e,s){const i=s||l(t||"");return e=parseFloat(e)+1e-8,i?e.toFixed(1):Math.round(e)}static format(t,e,s){s||={};let i=e;const r=l(t);return Math.abs(e)<1e-5?s.zero?"0":"":(!function(t){return!!l(t)||a.test(t)}(t)?(i=Math.round(i),s.minimize&&(i>1e7?i=(i/1e6).toFixed(2)+"m":i>1e6&&(i=(i/1e6).toFixed(3)+"m"))):(i+=1e-8,i=i.toFixed(s.decimal_digits||1),s.no_decimal_zero&&(i=i.replace(/(\.\d*?)0+$/,"$1").replace(/\.$/,"")),r&&(i+="%")),i=i.toString().replace(/\B(?=(\d{3})+(?!\d))/g," "),s.signed&&(e<0?"0"===i&&(i="-0"):i="+"+i),i)}static diff(t,e){const s=Object.assign({},t,e),r=new i,n=Object.keys(s);for(let s=0;s<n.length;s++){const i=n[s],a=(e[i]||0)-(t[i]||0);a&&(r[i]=a)}return r}}const r=/_percent/,n=/^(bond_of_life|stamina|recovery|duration|atk_speed|move_speed|healing|recharge|crit_|dmg_|enemy_|res_|.*bonus_|.*shield|.*_multi)/,a=/(_cooldown|_decimal)/;function l(t){return!!r.test(t)||n.test(t)}function o(t,e,s){let r=DB.Artifacts.Substats.get(t),n=DB.Artifacts.Rarity[e-1],a=r.rolls[e-1],l="percent"==r.type,o=c([],s,a,n.maxUpgrades,l);o=function(t){let e={};for(let s of t){let t=s.pop();e[[].concat(s.sort(),[t]).join("-")]=1}let s=[];for(const t of Object.keys(e).sort())s.push(t.split("-"));return s}(o),o=o.sort((function(t,e){return t[t.length-1]-e[e.length-1]||t.length-e.length}));let u=o[0],h=[];u||(u=[0]);let f=i.roundStatValue("",u.pop(),l);for(let t of u){let e=1;for(let s=0;s<a.length;++s)t==a[s]&&(e=2+s);h.push({value:i.roundStatValue("",t,l),rarity:e})}return{steps:h,maxValue:h.length*a[a.length-1],last:f,maxUpgrades:n.maxUpgrades}}function c(t,e,s,i,r){let n=[];if(i<=0){let s=u(t,e,r),i=[].concat(t);return i.push(Math.abs(s)),[i]}for(let a of s){let l=[].concat(t);l.push(a);let o=u(l,e,r);o>0?n=n.concat(c(l,e,s,i-1,r)):(0==o?l.push(0):(l=[].concat(t),l.push(Math.abs(a+o))),n.push(l))}return n}function u(t,e,s){let r=t.reduce((function(t,e){return t+e}),0),n=i.roundStatValue("",e,s)-i.roundStatValue("",r,s);return Math.abs(n)<.001?0:e-r}class h{constructor(t,e,s,i,r,n){this.rarity=t,this.level=e,this.slot=s,this.set=i,this.mainStat=r,this.subStats=n||[],this.locked=!1,this.groups=[],this.calculated=null}addStat(t,e){this.subStats.push({stat:t,value:e}),this.calculated=null}calcStats(){var t=new i;let e=DB.Artifacts.Mainstats.get(this.mainStat);if(e){let s=e.values[this.rarity-1];t.add(this.mainStat,s.getValue(this.level))}for(let e=0;e<this.subStats.length;++e){let s=this.subStats[e],i=DB.Artifacts.Substats.get(s.stat);t.add(s.stat,i.getPreciseValue(s.value,this.rarity))}return t.add("crit_value",2*t.get("crit_rate")+t.get("crit_dmg")),t}calcCache(t){this.calculated=this.calcStats(),this.calculated.truncate(t),this.calculated.processPercent()}replace(t){this.rarity=t.rarity,this.level=t.level,this.slot=t.slot,this.set=t.set,this.mainStat=t.mainStat,this.subStats=t.subStats,this.groups=t.getGroups(),this.calculated=null}getLevel(){return this.level}getSet(){return this.set}getRarity(){return this.rarity}getMainStat(){return""+this.mainStat}getSetName(){return""+this.set}getSlot(){return""+this.slot}getMainStatValue(){let t=this.getMainStat();return t?DB.Artifacts.Mainstats.get(t).values[this.rarity-1].getValue(this.level):0}getSubStats(){return this.subStats}setGroups(t){let e=t;Array.isArray(t)||(e=[t]);let s=[];for(let t of e){let e=h.trimGroupName(t);h.inGroups(s,e)||s.push(e)}this.groups=s}getGroups(){return this.groups&&0!=this.groups.length?this.groups:[""]}hasGroup(t){let e=t.toUpperCase();for(let t of this.groups)if(e==t.toUpperCase())return!0;return!1}inGroups(t){for(let e of t)if(this.hasGroup(e))return!0;return!1}isValid(){return 0==this.getErrors().length}setLocked(t){this.locked=!!t}isLocked(){return this.locked}getHash(){return t.pack(this)}getErrors(){let t=[];DB.Artifacts.Sets.get(this.set)||t.push("no_set"),DB.Artifacts.Mainstats.get(this.mainStat)||t.push("no_main_stat");let e=DB.Artifacts.Rarity[this.rarity-1],s=this.subStats.length;(s<e.minSubstats||s>e.maxSubstats)&&t.push("substat_count_mismatch");let i=!1,r=!1,n=!1,a=!1,l=[],c=0;for(const t of this.subStats){t.stat==this.mainStat&&(i=!0),l.includes(t.stat)&&(a=!0),l.push(t.stat);let e=o(t.stat,this.rarity,t.value);e.last>0&&(e.steps.length<e.maxUpgrades?n=!0:r=!0),e.steps.length>1&&(c+=e.steps.length-1)}let u=e.maxSubstats-4+Math.floor(this.level/4),h=Math.max(0,e.minSubstats-4+Math.floor(this.level/4));return c>0&&this.subStats.length<4&&t.push("not_full_substats"),(c>u||c>=e.maxUpgrades)&&t.push("too_much_upgrades"),c<h-1&&t.push("too_low_upgrades"),i&&t.push("substat_equal_main"),n&&t.push("substat_value_rolls"),r&&t.push("substat_value_range"),a&&t.push("substat_duplicate"),t}getErrorsFormatted(){let t=this.getErrors();if(0==t.length)return"";let e="";for(const s of t)e+="<p>"+UI.Lang.get("artifact_error."+s)+"</p>";return e}toGood(){let t=DB.Artifacts.Sets.get(this.set),e=DB.Artifacts.Mainstats.get(this.mainStat),s={setKey:t.getGoodId(),slotKey:this.slot,level:this.level,rarity:this.rarity,mainStatKey:e.goodId,location:"",lock:!1,substats:[]};for(const t of this.subStats){let e=DB.Artifacts.Substats.get(t.stat);if(!e)return null;s.substats.push({key:e.goodId,value:t.value})}return s}serialize(){let t=[1];t.push(DB.Artifacts.Sets.getId(this.set)),t.push(this.rarity),t.push(this.level),t.push(DB.Artifacts.Slots.getId(this.slot)),t.push(DB.Artifacts.Mainstats.getId(this.mainStat)||0),t.push(this.subStats.length);for(const e of this.subStats){t.push(DB.Artifacts.Substats.getId(e.stat));let s=DB.Artifacts.Substats.get(e.stat),i=e.value;"percent"==s.type&&(i=Math.floor(10*i)),t.push(i)}return t}clone(){return h.deserialize(this.serialize())}static deserialize(t){let e=null;if(1==t.shift()){let s=DB.Artifacts.Sets.getKeyId(t.shift());if(!s)return null;let i=t.shift();if(i<1||i>5)return null;let r=t.shift();if(r<0||r>20)return null;let n=DB.Artifacts.Slots.getKeyId(t.shift());if(!n)return null;let a=DB.Artifacts.Mainstats.getKeyId(t.shift())||"",l=t.shift();if(l<0||l>4)return null;e=new h(i,r,n,s,a);for(let s=1;s<=l;++s){let s=DB.Artifacts.Substats.getKeyId(t.shift());if(!s)return null;let i=t.shift();if(i<1)return null;let r=DB.Artifacts.Substats.get(s);if(!r)return null;i="percent"==r.type?parseFloat(i)/10:parseInt(i),e.addStat(s,i)}}return e}static fromGood(t){let e=DB.Artifacts.Sets.getKeyIdGood(t.setKey),s=DB.Artifacts.Sets.get(e);if(!s)return null;if(!DB.Artifacts.Slots.get(t.slotKey))return null;let i=DB.Artifacts.Mainstats.getKeyIdGood(t.mainStatKey),r=DB.Artifacts.Mainstats.get(i);if(!r)return null;if(!r.slots.includes(t.slotKey))return null;if(t.rarity<s.minRarity&&t.rarity>s.maxRarity)return null;let n=DB.Artifacts.Rarity[t.rarity-1];if(t.level<0&&t.level>n.maxLevel)return null;let a=new h(t.rarity,t.level,t.slotKey,e,i);if(Array.isArray(t.substats)){if(t.substats.length>4)return null;for(const e of t.substats){if(!e.key)continue;let t=DB.Artifacts.Substats.getKeyIdGood(e.key);if(!t)return null;let s=e.value;a.addStat(t,s)}}return a}static subStatsIsSimilar(t,e){if(t.subStats.length<e.subStats.length)return!1;for(let s=0;s<e.subStats.length;++s)if(t.subStats[s].stat!=e.subStats[s].stat||t.subStats[s].value<e.subStats[s].value)return!1;return!0}static inGroups(t,e){for(let s of t)if(h.groupsAreEqual(s,e))return!0;return!1}static groupsAreEqual(t,e){return t.toUpperCase()==e.toUpperCase()}static trimGroupNames(t){Array.isArray(t)||(t=[t]);let e=[];for(let s of t)e.push(h.trimGroupName(s));return e}static trimGroupName(t){let e=t||"";return e=e.replace(/[^\w\u0400-\u04ff\d_\-\s]/g,""),e=e.replace(/\s+/g," "),e.trim()}static settingName(t){return"set_pieces."+t.toLowerCase()}static settingNameShort(t){return t.toLowerCase()}}function f(){let t={};for(let e of arguments)e.walk((e=>{if(e.getUsedStats)for(let s of e.getUsedStats()){let e=g(s);e!=s&&(t[e]=(t[e]||0)+1),t[s]=(t[s]||0)+1}}));return Object.keys(t)}function g(t){return t.replace(/(_\d+)+$/,"")}class p{constructor(t,e){this.items=t||[],e&&Object.assign(this,e)}getType(){return"block"}hasItems(){return!0}compileChildrens(t){return this.items.filter((t=>!t.isBlank())).map((e=>e.compile(t)))}isBlank(){for(let t of this.items)if(!t.isBlank())return!1;return!0}isCollapsable(){return!0}isVariableSet(){return!1}isVariableGet(){return!1}process(t){return this}compile(t){return this.compileChildrens(t).join(";\n")}execute(t,e){return t.stats.ensure(f(this)),Function("stats","return "+this.compile(e))(t.stats)}getSignature(){return"("+(this.isCollapsable()?"":"!")+this.getType()+":"+this.items.map((t=>t.getSignature())).join(",")+")"}treeBlockFields(){return[this.items]}makeResult(){return this.noReturn?this:new d([this])}walk(t,e){for(let s of this.treeBlockFields()){for(let i of s)e&&e(i)||t(i);for(let i of s)e&&e(i)||i.walk&&i.walk(t,e)}}walkReplace(t){for(let e of this.treeBlockFields()){let s=[];for(let i of e){let e=t(i);e&&s.push(e)}e.splice(0,e.length,...s);for(let s of e)s.walkReplace&&s.walkReplace(t)}}getInfoProperties(){let t={};for(let e of Object.keys(this))"object"!=typeof this[e]&&(t[e]=this[e]);return t}}class d extends p{getType(){return"block_return"}appendChildren(){let t=this.items.pop();for(let t of arguments)this.items.push(t);t&&this.items.push(t)}compile(t){let e=this.items.map((e=>e.compile(t)));return e[e.length-1]="return "+e[e.length-1],e.join(";\n")}}class m{constructor(t){Object.assign(this,t)}getType(){return"item"}hasItems(){return!1}isVariableSet(){return!1}isVariableGet(){return!1}compile(t){return this.value||0}isBlank(){return this.static&&this.blank}process(t){return this}getSignature(){throw`Item ${this.constructor.name} has no "getSignature" method!`}}const y=["atk","hp","def"];class b extends m{getType(){return"item_const"}getSignature(){return"(const:"+this.value+")"}}class w extends m{getType(){return"item_stat"}compile(t){return"stats."+this.stat}process(t){return t.staticStats&&t.staticStats.includes(this.stat)?new b({value:this.value,comment:this.stat}):super.process()}getUsedStats(){return[this.stat]}getSignature(){return"(stat:"+this.stat+")"}}class v extends w{getType(){return"item_stat_total"}getUsedStats(){return[this.stat,this.stat+"_base",this.stat+"_percent"]}process(t){return new I([new O([new w({stat:this.statBaseName(),value:this.baseBalue}),new B([new w({stat:this.statPercentName(),value:this.percentValue})],{comment:this.stat+"_percent",percent:!0})]),new w({stat:this.statFlatName(),value:this.flatValue})],{comment:this.stat}).process(t)}statBaseName(){return this.replaceName(this.stat+"_base")}statPercentName(){return this.replaceName(this.stat+"_percent")}statFlatName(){return this.replaceName(this.stat)}replaceName(t){return this.replace&&this.replace[t]?this.replace[t]:t}compile(t){return`(stats.${this.statBaseName()} * (1 + stats.${this.statPercentName()}) + stats.${this.statFlatName()})`}}class S extends m{constructor(t){t.name=t.ref.name,delete t.ref,super(t)}getType(){return"variable_get"}isVariableGet(){return!0}compile(t){return this.name}getSignature(){return"(var_value:"+this.name+")"}}function _(t,e){return t.indexOf("*")>0?function(t,e){if(!y.includes(t))return new I([_(t+"_base",e),_(t,e)],{comment:t,percent:l(t)});return new v({stat:t,value:e.getTotalPercent(t),baseBalue:e.get(t+"_base"),percentValue:e.get(t+"_percent"),flatValue:e.get(t)})}(t.replace("*",""),e):new w({stat:t,value:e.get(t)})}let C=BigInt(0);function k(t){return(t||"var")+"_"+ ++C}function j(t,e){let s=new S({ref:t}),i=new T([new D([new b({value:1}),new I([s,e])])]),r=new T([new D([new b({value:1}),new I([s,new O([new b({value:2}),e])])])]),n=new T([new D([new b({value:1}),new I([s,new O([new b({value:3}),e])])])]),a=new T([new D([new b({value:1}),new I([s,new O([new b({value:4}),e])])])]),l=new T([new D([new b({value:1}),new I([s,new O([new b({value:5}),e])])])]),o=new S({ref:i}),c=new S({ref:r}),u=new S({ref:n}),h=new S({ref:a}),f=new S({ref:l}),g=new A([new O([new b({value:-1}),f]),new I([s,o,c,u,h,new b({value:-1}),new O([new b({value:-1}),s,o]),new O([new b({value:-1}),s,c]),new O([s,o,c]),new O([new b({value:-1}),o,c]),new O([new b({value:-1}),s,u]),new O([s,o,u]),new O([new b({value:-1}),o,u]),new O([s,c,u]),new O([new b({value:-1}),s,o,c,u]),new O([o,c,u]),new O([new b({value:-1}),c,u]),new O([new b({value:-1}),s,h]),new O([s,o,h]),new O([new b({value:-1}),o,h]),new O([s,c,h]),new O([new b({value:-1}),s,o,c,h]),new O([o,c,h]),new O([new b({value:-1}),c,h]),new O([s,u,h]),new O([new b({value:-1}),s,o,u,h]),new O([o,u,h]),new O([new b({value:-1}),s,c,u,h]),new O([s,o,c,u,h]),new O([new b({value:-1}),o,c,u,h]),new O([c,u,h]),new O([new b({value:-1}),u,h]),new O([new b({value:4}),s,f]),new O([new b({value:-3}),s,o,f]),new O([new b({value:3}),o,f]),new O([new b({value:-2}),s,c,f]),new O([new b({value:2}),s,o,c,f]),new O([new b({value:-2}),o,c,f]),new O([new b({value:2}),c,f]),new O([new b({value:-1}),s,u,f]),new O([s,o,u,f]),new O([new b({value:-1}),o,u,f]),new O([s,c,u,f]),new O([new b({value:-1}),s,o,c,u,f]),new O([o,c,u,f]),new O([new b({value:-1}),c,u,f]),new O([u,f]),new O([new b({value:-5}),f])])]);return[[t,i,r,n,a,l],new T([g],{name:"crit_rate_avg"})]}class I extends p{getType(){return"block_sum"}dontShrink(){return 0}compile(t){let e=this.compileChildrens(t),s=e.join(" + ");return e.length>1&&(s="("+s+")"),s||"0"}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof b&&0!=t.value)),s=this.items.filter((t=>!(t instanceof b)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=0;for(let t of e)i+=t.value;let r=new b({value:i,comment:"processed"});if(0==s.length&&!this.dontShrink())return r;t.push(r);for(let e of s)t.push(e);this.items=t}else this.items=[...e,...s];return 0==this.items.length&&(this.items=[new b({value:0})]),super.process(t)}}class B extends I{getType(){return"block_sum_plus"}compile(t){let e=this.compileChildrens(t);return 0==e.length?"":(e.unshift(1),"("+e.join(" + ")+")")}process(t){return new I([new b({value:1}),...this.items.map((e=>e.process(t)))],this.getInfoProperties(t)).process(t)}}class z extends p{getType(){return"block_subtract"}compile(t){let e=this.compileChildrens(t),s=e.join(" - ");return e.length>1&&(s="("+s+")"),s||"0"}}class O extends p{getType(){return"block_multi"}compile(t){let e=this.compileChildrens(t),s=e.join(" * ");return e.length>1&&(s="("+s+")"),s||0}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof b&&1!=t.value)),s=this.items.filter((t=>!(t instanceof b)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=1;for(let t of e)i*=t.value;let r=new b({value:i,comment:"processed"});if(0==s.length)return r;t.push(r);for(let e of s)t.push(e);this.items=t}else this.items=[...e,...s];return 1==this.items.length&&"block_multi"==this.getType()?this.items[0]:super.process()}}class A extends p{getType(){return"block_divide"}compile(t){let e=this.compileChildrens(t),s=e.join(" / ");return e.length>1&&(s="("+s+")"),s||0}process(t){this.items=this.items.map((e=>e.process(t)));let e=this.items.filter((t=>t instanceof b)),s=this.items.filter((t=>!(t instanceof b)));if(e.length>1&&!t.dontProcessStaticValues){let t=[],i=e.shift().value;for(let t of e)i/=t.value;let r=new b({value:i,comment:"processed"});if(0==s.length)return r;t.push(r);for(let e of s)t.push(e);this.items=t}return super.process()}}class D extends p{getType(){return"block_min"}compile(t){let e=this.compileChildrens(t);return e.length>1?"Math.min("+e.join(", ")+")":e[0]}}class T extends I{getType(){return"variable_set"}isCollapsable(){return!1}isVariableSet(){return!0}constructor(t,e){(e=Object.assign({},e)).name=k(e.name),super(t,e)}compile(t){return"let "+this.name+" = "+super.compile(t)}}class P extends I{constructor(t,e){e.name=e.ref.name,delete e.ref,super(t,e)}getType(){return"variable_inc"}isCollapsable(){return!1}isVariableSet(){return!0}isVariableGet(){return!0}compile(t){return this.name+" += "+super.compile(t)}}class E extends p{getType(){return"post"}}class x extends p{getType(){return"isolated"}}class F extends I{getType(){return"stat_increase"}isCollapsable(){return!1}getAssignedStats(){return[this.stat]}compile(t){let e=super.compile(t);return this.newName?"stats."+this.newName+" = stats."+this.stat+" + "+e:"stats."+this.stat+" += "+e}}class R extends I{getType(){return"stat_decrease"}isCollapsable(){return!1}getAssignedStats(){return[this.stat]}compile(t){let e=super.compile(t);return"stats."+this.stat+" -= "+e}}class N{constructor(t,e){this.tree=t,this.postItems=e||[],this.usedStats=f(this.tree,...this.postItems),this.assignedStats=function(){let t={};for(let e of arguments){if(e.getAssignedStats)for(let s of e.getAssignedStats())t[s]=(t[s]||0)+1;e.walk((e=>{if(e.getAssignedStats)for(let s of e.getAssignedStats())t[s]=(t[s]||0)+1}))}return Object.keys(t)}(this.tree,...this.postItems),this.isReacted=!1}checkForReaction(){this.tree.walk((t=>{t.isReacted&&(this.isReacted=!0)}))}prepare(t,e){e=Object.assign({},e);let s,i="damage_rotation_result"==this.tree.getType(),r=this.tree.makeResult();if(i||(s=this.makePostTree(e)),this.processed=new p,e.dontProcessTree||(this.processBlock(r,e),s&&this.processBlock(s,e)),s&&this.processed.items.push(s),this.processed.items.push(r),s&&s.revert&&s.revert.length){let t=this.processed.items[this.processed.items.length-1];t.appendChildren?t.appendChildren(...s.revert):this.processed.items.push(...s.revert)}}processBlock(t,e){t.walkReplace((t=>t.process(e))),t.process(e),this.processVariables(t,e)}makePostTree(t){let e=[];for(let s of this.postItems)(t.dontProcessStats||s.stat&&this.usedStats.includes(s.stat))&&e.push(s);if(0==e.length)return;let[s,i]=N.postTreeBlocks(e,t);return new E(s,{revert:i})}static filterPostByStats(t,e){let s=[],i=V(t);e=[].concat(e);for(let t of Object.keys(i).sort().reverse())for(let r of i[t]){let t=g(r.stat);if(r.stat&&(e.includes(r.stat)||e.includes(t))){s.push(r);for(let t of f(r))e.includes(t)||e.push(t)}}return s}static postTreeBlocks(t){let e=[],s=[],i=V(t);for(let t of Object.keys(i).sort()){let r=[],n=[];for(let e of i[t]){let t=new T([e],{name:"post_"+e.stat});r.push(t),n.push(new F([new S({ref:t})],{stat:e.stat})),s.unshift(new R([new S({ref:t})],{stat:e.stat}))}e.push(new x([...r,...n]))}return[e,s]}getCode(t){return this.processed.compile(t)}compile(t){let e=this.getCode(t);return this.compiled=Function("stats",e),e}compilePostTree(t){let e=this.makePostTree(t);return e?(t.dontProcessTree||this.processBlock(e,t),Function("stats",e.compile(t))):Function("stats","")}execute(t){return this.compiled(t.stats)}processVariables(t,e){e.dontInsertVariables||t.walk((t=>{"isolated"==t.getType()&&this.replaceBlockRepeat(t)}))}replaceBlockRepeat(t){for(let e=0;e<10;++e){let e={};t.walk((t=>{if(t.hasItems()){let s=t.getSignature();s&&!s.includes("!")&&(e[s]=(e[s]||0)+1)}}),(t=>"isolated"==t.getType()));let s=[];for(let[t,i]of Object.entries(e))i<2||s.push(t);let i=[];for(let t of s){let e=!0;for(let i of s)if(t!=i&&i.indexOf(t)>=0){e=!1;break}e&&i.push(t)}if(0==i.length)break;let r={},n={};t.walkReplace((t=>{let e=t.getSignature();if(e&&i.includes(e)){if(!r[e]){let s=new T([t]);r[e]=s,n[s.name]=s}return new S({ref:r[e]})}return t})),t.items=M(t.items,n)}}}function M(t,e){let s=[];for(;Object.keys(e).length;){s=[];for(let r of t){let t={};for(var i of(r.walk((e=>{e.isVariableGet()&&!e.isVariableSet()&&(t[e.name]=1)})),Object.keys(t)))e[i]&&(s.push(e[i]),delete e[i]);s.push(r)}t=s}return s}function V(t){let e={};for(let s of t){let t=s.priority;e[t]||(e[t]=[]),e[t].push(s)}return e}const L=1;class H{constructor(t){Object.assign(this,t)}set(t,e){this[t]=e}get(t){return this[t]}getNumber(t){return this[t]||0}concat(){for(let t of arguments)Object.assign(this,t)}getLevel(t){return G(t,this)}}function G(t,e){let s=e[t]||1;s+=e[t+"_bonus"]||0,s+=e[t+"_bonus_2"]||0;let i=/\w+_(char_skill_\w+)/.exec(t);return i&&(s+=e[i[1]+"_bonus_party"]||0),s}class U{constructor(t,e){this.stats=new i(e),this.settings=new H(t),this.multipliers=[],this.postEffects=[]}addStats(t){this.stats.concat(t)}addSettings(t){this.settings.concat(t)}getActivePostEffects(){return this.postEffects.filter((t=>t.isActive(this.settings)))}getActivePostEffectsTree(){let t=this.getActivePostEffects(),e=[];for(let s of t)if(s.getTree)for(let t of s.getTree(this))e.push(t);return e}applyPostEffects(t){for(let t of this.postEffectTreeByPriority()){let e=new N(new p([]),t),s=e.compilePostTree({dontProcessStats:!0});s&&(this.stats.ensure(e.usedStats),this.stats.ensure(e.assignedStats),s(this.stats))}this.postEffects=[]}postEffectByPriority(t){t=Object.assign({},t);let e=this.getActivePostEffects(),s={};for(let i of e){let e=i.getPriority();t.maxPriority&&e>t.maxPriority||(s[e]||(s[e]=[]),s[e].push(i))}let i=[];for(let t of Object.keys(s).sort())i.push(s[t]);return i}postEffectTreeByPriority(t){let e=this.postEffectByPriority(t),s=[];for(let t of e){let e=[];for(let s of t)e=e.concat(s.getTree(this));s.push(e)}return s}getResistance(t){return this.settings.get("enemy_res_"+t)+100*this.stats.get("enemy_res_"+t)}clone(){let t=new U(this.settings,this.stats);return t.postEffects=[].concat(this.postEffects),t.multipliers=[].concat(this.multipliers),t}}class W{constructor(t){this.params=t||{},this.entityId=0}getId(){return this.params.serializeId||0}getEntityId(){return this.entityId}getName(){return this.params.name}getNamesList(){return[this.getName()]}getType(){return""}getTitle(t){return this.params.title?UI.Lang.getTalent(this.params.title,t):""}getIcon(){return this.params.icon?this.params.icon.name:""}getDescription(t){return this.params.description?UI.Lang.getTalent(this.params.description,t):""}getInfo(){return this.params.info}getLevel(t){return G(this.params.levelSetting,t)}isHidden(t){if(this.params.isHidden)return!0;let e=this.params.hideCondition;if(e)for(let s=0;s<e.length;++s){if(e[s].isActive(t))return!0}return!1}isActive(t){return this.checkSubconditions(t)}isSerializable(){let t=this.getName(),e=this.getType();return!(!t&&!e||"static"==e)}getMaxStacks(t){return this.params.maxStacks||0}checkSubconditions(t){if(this.params.condition)return this.params.condition.isActive(t);{let e=this.params.subConditions;if(e)for(let s=0;s<e.length;++s){if(!e[s].isActive(t))return!1}}return!0}getData(t){let e={settings:{}};return this.isActive(t)?(e.settings=this.params.settings||{},e.stats=this.getStats(t)):e.stats=new i,e}getStats(t){return new i(this.params.stats||{})}getBuffRotationSection(t){return this.params.rotation||""}static allConditionsOn(t,e){let s={};for(let i=0;i<t.length;++i){const r=t[i];let n=r.getType();"stacks"==n?s[r.getName()]=r.getMaxStacks():"checkbox"==n?s[r.getName()]=!0:"dropdown"==n?s[r.getName()]=r.params.suggesterValue||0:r.getAllConditionsOn&&Object.assign(s,r.getAllConditionsOn(e))}return s}static allConditionsOff(t){let e={};for(let s=0;s<t.length;++s){const i=t[s];let r=i.getType();"stacks"==r?e[i.getName()]=0:"checkbox"==r&&(e[i.getName()]=!1)}return e}static setCommonValues(t,e){let s={};for(let i=0;i<e.length;++i){const r=e[i].getName();/^common\./.test(r)&&(t[r]||=0,s[r]=t[r])}return s}static unwrap(t,e){let s=[];for(let i of t)if(i.getCondtitionList)for(let t of i.getCondtitionList())e&&!t.isActive(e)||s.push(t);else s.push(i);return s}}class ${constructor(){this.object=null,this.settings={}}getName(){return this.object&&this.object.getName()||""}getIcon(){return this.object&&this.object.getIcon()||""}getRarity(){return this.object&&this.object.getRarity()||1}set(t){this.object=t,this.removeInvalidSettings()}get(){return this.object}getConditions(){return this.object&&this.object.getConditions()||[]}getFeatures(){return this.object&&this.object.getFeatures()||[]}getPostEffects(){return this.object&&this.object.getPostEffects()||[]}getMultipliers(){return this.object&&this.object.getMultipliers()||[]}getSettings(){return Object.assign({},this.settings)}getLevels(){return this.levels}getStats(){var t=new i;if(this.object&&this.object.statTable)for(let e=0;e<this.object.statTable.length;++e){let s=this.object.statTable[e],i=s.getValue(this.levels.level,this.levels.ascension);t.add(s.getName(),i)}return{stats:t,settings:{}}}setSettings(t){this.settings=t}modifySettings(t){return Object.assign(this.settings,t),this.getSettings()}addSettings(t){this.settings=Object.assign(this.settings,t)}isBeta(){return this.object&&this.object.isBeta()}serialize(){return[]}removeInvalidSettings(){let t=this.getConditions(),e=W.allConditionsOn(t);for(const t of Object.keys(this.settings))void 0===e[t]&&delete this.settings[t]}serializeConditions(t,e){let s=0,i=[],r=[];if(e)for(const s of W.unwrap(e,t))s.isActive(t)&&r.push(s);else for(const e of W.unwrap(this.getConditions({serialize:!0}),t))e.isActive(t)&&r.push(e);for(const e of r){if(!e.params.serializeId)continue;let r=e.getType();if("checkbox"==r)++s,i.push(e.params.serializeId);else if("stacks"==r)++s,i.push(e.params.serializeId),i.push(t[e.getName()]);else if("number"==r){++s,i.push(e.params.serializeId);let r=t[e.getName()]||0;r="decimal"==e.params.format?Math.floor(10*parseFloat(r)):parseInt(r),i.push(Math.max(0,r))}else if("dropdown"==r||"dropdown_multiple"==r){let r=e.getSelectedId(t);r&&(++s,i.push(e.params.serializeId),i.push(r))}else if("char"==r){let r=this.serializeChars(t);r.length&&(++s,i.push(e.params.serializeId),i=i.concat(r))}else if("custom_buffs"==r){let r=this.serializeCustomBuffs(t);r.length&&(++s,i.push(e.params.serializeId),i=i.concat(r))}}return i.unshift(s),i}serializeChars(t){return[]}serializeCustomBuffs(t){return[]}deserializeChars(t){return{}}deserializeCustomBuffs(t){return{}}deserializeConditions(t,e){let s={},i=t.shift(),r={};if(e)for(const t of W.unwrap(e))t.params.serializeId&&(r[t.params.serializeId]=t);else for(const t of W.unwrap(this.getConditions({serialize:!0})))t.params.serializeId&&(r[t.params.serializeId]=t);for(let e=1;e<=i;++e){let i=t.shift();if(e<1)return;let n=r[i];if(!n)return;let a=n.getType();if("checkbox"==a)s[n.getName()]=!0;else if("stacks"==a){let e=t.shift();e>n.params.maxStack&&(e=n.params.maxStack),s[n.getName()]=e}else if("number"==a){let e=t.shift();"decimal"==n.params.format&&(e=(e/10).toFixed(1)),s[n.getName()]=e}else if("dropdown"==a||"dropdown_multiple"==a){let e=n.getValueById(t.shift());s[n.getName()]=e||""}else"char"==a?s=Object.assign(s,this.deserializeChars(t)):"custom_buffs"==a&&(s=Object.assign(s,this.deserializeCustomBuffs(t)))}return s}}const K=["flower","plume","sands","goblet","circlet"];class q extends ${constructor(){super(),this.artifacts={flower:null,plume:null,sands:null,goblet:null,circlet:null}}get(){return this.artifacts}hasEquipped(){for(let t of K)if(this.artifacts[t])return!0;return!1}getSettings(){let t=Object.assign({},this.settings),e={};for(let t of K){let s=this.artifacts[t];s&&(e[s.set]=1+(e[s.set]||0))}for(let s of Object.keys(e))t[h.settingName(s)]=e[s];return t}getFeatures(){let t=[],e=this.activeSets(),s=Object.keys(e);for(let i=0;i<s.length;++i){let r=s[i],n=DB.Artifacts.Sets.get(r);if(n){let s=n.getFeatures(e[r]);t=t.concat(s)}}return t}isBeta(){let t=this.activeSets(),e=Object.keys(t);for(let t of e){let e=DB.Artifacts.Sets.get(t);if(e&&e.isBeta())return!0}return!1}getStats(t){let e={stats:new i,settings:{}};for(let s=0;s<K.length;++s){const i=K[s];let r=this.artifacts[i];r&&e.stats.concat(r.calcStats(t))}return e}getConditions(){let t=[],e=this.activeSets(),s=Object.keys(e);for(let i=0;i<s.length;++i){let r=s[i],n=DB.Artifacts.Sets.get(r);if(n){let s=n.getConditions(e[r]);t=t.concat(s)}}return t}getPostEffects(){let t=[];for(let e of DB.Artifacts.Sets.getList()){let s=e.getPostEffects();t=t.concat(s)}return t}getMultipliers(){let t=[],e=this.activeSets();for(const[s,i]of Object.entries(e)){let e=DB.Artifacts.Sets.get(s);if(e){let s=e.getMultipliers(i);t=t.concat(s)}}return t}modifySets(t){let e=[].concat(t),s={},i=DB.Artifacts.Sets.getKeys();for(let t=0;t<K.length;++t){const r=K[t];let n=this.artifacts[r];if(n){let t=e.shift();if(!t)for(const e of i){if(s[e])continue;let i=DB.Artifacts.Sets.get(e);i.getConditions(1).length||i.minRarity<=n.rarity&&i.maxRarity>=n.rarity&&(t=e)}s[t]=1,n.set=t}}}set(t){let e=t.slot;this.artifacts[e]=t,this.removeInvalidSettings()}replace(t){for(let e of t){let t=e.slot;this.artifacts[t]=e}this.removeInvalidSettings()}remove(t){let e=t.getHash();for(let t=0;t<K.length;++t){const s=K[t];let i=this.artifacts[s];i&&i.getHash()==e&&(this.artifacts[s]=null,this.removeInvalidSettings())}}clearArtifacts(){for(let t=0;t<K.length;++t){const e=K[t];this.artifacts[e]=null}}isEquipped(t){let e=t.slot;return!(!this.artifacts[e]||this.artifacts[e]!=t)}activeSets(){let t={};for(let e=0;e<K.length;++e){const s=K[e];let i=this.artifacts[s];i&&(i.set&&(t[i.set]||(t[i.set]=0),++t[i.set]))}return t}serialize(t){let e=[],s=0;for(let t=0;t<K.length;++t){const i=K[t];let r=this.artifacts[i];r&&(++s,e=e.concat(r.serialize()))}e.unshift(s);let i=this.serializeConditions(t);return e.concat(i)}static deserialize(t){let e=t.shift();if(e<0||e>5)return null;let s=new q;for(let i=1;i<=e;++i){let e=h.deserialize(t);if(!e)return null;s.set(e)}let i=s.deserializeConditions(t);return i?(s.setSettings(i),s):null}}const J={atk:{serializeId:1,flat:!0},atk_percent:{serializeId:2},def:{serializeId:3,flat:!0},def_percent:{serializeId:4},hp:{serializeId:5,flat:!0},hp_percent:{serializeId:6},mastery:{serializeId:7,flat:!0},recharge:{serializeId:8},crit_rate:{serializeId:9},crit_dmg:{serializeId:10},healing:{serializeId:11},healing_recv:{serializeId:12},shield:{serializeId:13},recharge:{serializeId:14},crit_rate:{serializeId:15},crit_dmg:{serializeId:16},healing:{serializeId:17},healing_recv:{serializeId:18},shield:{serializeId:19},dmg_all:{serializeId:20},dmg_anemo:{serializeId:21},dmg_cryo:{serializeId:22},dmg_dendro:{serializeId:23},dmg_electro:{serializeId:24},dmg_geo:{serializeId:25},dmg_hydro:{serializeId:26},dmg_pyro:{serializeId:27},dmg_phys:{serializeId:28},dmg_normal:{serializeId:29},dmg_charged:{serializeId:30},dmg_plunge:{serializeId:31},dmg_skill:{serializeId:32},dmg_burst:{serializeId:33},enemy_def_reduce:{serializeId:34},enemy_def_ignore:{serializeId:35}};let Q={};for(let t of Object.keys(J))Q[J[t].serializeId]=t;class X extends ${constructor(){super(),this.buffs=DB.Buffs,this.partyCharIds=[]}get(){return this.buffs}getFeatures(){return[]}isBeta(){return!1}getStats(t){return{stats:new i,settings:{}}}getConditions(t){let e=[];t||={};for(const t of this.buffs.getList())e=e.concat(t.getConditions());let s=this.getPartyChars();if(!t.serialize)for(let t=0;t<s.length;++t){let i=s[t];const r=DB.Chars.getById(i);r&&(e=e.concat(r.getPartyConditions()))}return e}getMultipliers(){let t=[];for(const e of this.buffs.getList())t=t.concat(e.getMultipliers());let e=this.getPartyChars();for(let s of e){const e=DB.Chars.getById(s);e&&(t=t.concat(e.getPartyMultipliers()))}return t}getPostEffects(){let t=[],e=this.getPartyChars();for(const e of this.buffs.getList())t=t.concat(e.getPostEffects());for(let s=0;s<e.length;++s){let i=e[s];const r=DB.Chars.getById(i);r&&(t=t.concat(r.getPartyPostEffects()))}return t}setPartyChars(t){this.partyCharIds=[];for(const e of t)e&&DB.Chars.getById(e)&&this.partyCharIds.push(e)}getPartyChars(){return[].concat(this.partyCharIds)}getSettings(){let t=super.getSettings(),e=1;for(let s=1;s<=3;++s){let i=this.partyCharIds[s-1];const r=DB.Chars.getById(i);r?(++e,t["party_char_"+s]=i,t["resonance_element_"+s]=r.getElement()):(t["party_char_"+s]=0,t["resonance_element_"+s]="")}return t.party_size=e,t}serialize(t){let e=this.serializeConditions(t);return[].concat(e)}serializeChars(t){let e=this.getPartyChars(),s=[],i=0;for(let r=0;r<e.length;++r){let n=e[r],a=DB.Chars.getById(n);if(a){++i;let e=a.getPartyConditions(),r=this.serializeConditions(t,e);s.push(n),s=s.concat(r)}}return s.unshift(i),s}serializeCustomBuffs(t){let e=0,s=[];for(let i of Object.keys(J)){let r=t["custom_buffs."+i];if(!r)continue;++e;let n=J[i];s.push(n.serializeId),n.flat?s.push(Math.floor(r)):s.push(Math.floor(10*r))}return e&&s.unshift(e),s}deserializeChars(t){let e=t.shift(),s={};for(let i=0;i<e;++i){let e=t.shift(),r=DB.Chars.getById(e);if(!r)return null;let n=r.getPartyConditions();s["party_char_"+(i+1)]=e;let a=this.deserializeConditions(t,n);s=Object.assign(s,a)}return s}deserializeCustomBuffs(t){let e=t.shift(),s={};for(let i=0;i<e;++i){let e=t.shift(),i=Q[e];if(!i)return null;let r=J[i],n=t.shift();r.flat||(n/=10),s["custom_buffs."+i]=n}return s}static deserialize(t){let e=new X,s=e.deserializeConditions(t);if(!s)return null;let i={};e.partyCharIds=[];for(let t=1;t<=3;++t)s["party_char_"+t]&&e.partyCharIds.push(s["party_char_"+t]);if(0==e.partyCharIds.length)for(let t=1;t<=3;++t){let r=s["old_resonance_element_"+t];if(r){delete s["old_resonance_element_"+t];for(const t of DB.Chars.getList()){let s=t.getId();if(!i[s]&&r==t.getElement()){e.partyCharIds.push(s),i[s]=1;break}}}}return e.setSettings(s),e}}class Y{constructor(t,e){this.stat=t,this.values=e}getName(){return this.stat}getValue(t){return t>0?(t>this.values.length&&(t=this.values.length),this.values[t-1]):0}getValues(){return this.values}multiply(t){let e=[];for(let s of this.values)e.push(s*t);return new Y(this.stat,e)}}const Z=new Y("",[1,2,4,6,8,10]);class tt extends ${constructor(){super(),this.levels={level:1,ascension:0,constellation:0},this.skills={attack:1,elemental:1,burst:1}}setLevels(t){this.levels.level=t.level,this.levels.ascension=t.ascension,this.levels.constellation=t.constellation}getLevels(){return{level:this.levels.level,ascension:this.levels.ascension,constellation:this.levels.constellation}}setSkills(t){this.skills.attack=t.attack,this.skills.elemental=t.elemental,this.skills.burst=t.burst}getId(){return this.object?this.object.getId():0}getName(){return this.object?this.object.getName():""}getSkills(){return{attack:this.skills.attack,elemental:this.skills.elemental,burst:this.skills.burst}}getConditions(){let t=super.getConditions();if(!this.object)return t;let e=this.object.constellation;return e&&(t=t.concat(e.getConditions(this.levels.constellation))),t=t.concat(DB.Conditions.Character),t}getFeatures(){let t=super.getFeatures();if(!this.object)return t;let e=this.getConstellation();return e&&(t=t.concat(e.getFeatures(this.levels.constellation))),t}getSettings(){let t=super.getSettings(),e=Z.getValue(this.levels.ascension||1),s={char_skill_attack:Math.min(e,this.skills.attack),char_skill_elemental:Math.min(e,this.skills.elemental),char_skill_burst:Math.min(e,this.skills.burst),char_level:this.levels.level,char_ascension:this.levels.ascension,char_constellation:this.levels.constellation};return this.object&&(s.char_id=this.object.getId(),s.char_name=this.object.name,s.char_element=this.object.element,s.char_origin=this.object.origin),t=Object.assign(t,s),t}getConstellation(){return this.object.constellation}getElement(){return this.object&&this.object.getElement()||""}getWeaponType(){return this.object&&this.object.getWeapon()||""}serialize(t){let e=[];if(!this.object)return null;e.push(this.object.getId()),e.push(this.levels.level,this.levels.ascension,this.levels.constellation),e.push(this.skills.attack,this.skills.elemental,this.skills.burst);let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=DB.Chars.getById(t.shift());if(!e)return null;let s=t.shift();if(s<1||s>90)return null;let i=t.shift();if(i<0||i>6)return null;let r=t.shift();if(r<0||r>6)return null;let n=t.shift();if(n<1||n>10)return null;let a=t.shift();if(a<1||a>10)return null;let l=t.shift();if(l<1||l>10)return null;let o=new tt;o.set(e),o.setLevels({level:s,ascension:i,constellation:r}),o.setSkills({attack:n,elemental:a,burst:l});let c=o.deserializeConditions(t);return c?(o.setSettings(c),o):null}}class et extends ${constructor(){super(),this.levels={level:1},this.resistances={phys:0,anemo:0,cryo:0,geo:0,hydro:0,pyro:0,electro:0,dendro:0}}setLevels(t){this.levels.level=t.level}setResistances(t){for(const e of["anemo","cryo","dendro","electro","geo","hydro","phys","pyro"])this.resistances[e]=parseInt(t[e])||0}getResistances(){return this.object?this.object.getResistances():this.resistances}getStats(){return{stats:new i,settings:{}}}getSettings(){let t=super.getSettings(),e=this.getResistances();return t=Object.assign(t,{enemy_level:this.levels.level,enemy_res_phys:e.phys||0,enemy_res_anemo:e.anemo||0,enemy_res_cryo:e.cryo||0,enemy_res_geo:e.geo||0,enemy_res_hydro:e.hydro||0,enemy_res_pyro:e.pyro||0,enemy_res_electro:e.electro||0,enemy_res_dendro:e.dendro||0}),this.object&&(t.enemy_type=this.object.type,t=Object.assign(t,this.object.getSettings())),t}getConditions(){let t=super.getConditions();return t=t.concat(DB.Conditions.Enemy),t}serialize(t){let e=[];e.push(this.levels.level),this.object?(e.push(2),e.push(this.object.getId())):(e.push(1),e.push(this.resistances.anemo+100),e.push(this.resistances.cryo+100),e.push(this.resistances.dendro+100),e.push(this.resistances.electro+100),e.push(this.resistances.geo+100),e.push(this.resistances.hydro+100),e.push(this.resistances.phys+100),e.push(this.resistances.pyro+100));let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=t.shift();if(e<1||e>110)return null;let s=t.shift(),i=new et;if(i.setLevels({level:e}),1==s){let e={};for(const s of["anemo","cryo","dendro","electro","geo","hydro","phys","pyro"]){let i=t.shift()-100;if(i<-100||i>1e3)return null;e[s]=i}i.setResistances(e)}else{if(2!=s)return null;{let e=DB.Enemies.getById(t.shift());if(!e)return null;i.set(e)}}let r=i.deserializeConditions(t);return r?(i.setSettings(r),i):null}}const st=["Attack","Defence","Potion"];class it extends ${constructor(){super(),this.food={Attack:{item:null,level:0},Defence:{item:null,level:0},Potion:{item:null,level:0}}}get(t){let e=this.food[t];if(e.item)return e.item}getLevel(t){let e=this.food[t];return e.item?e.level:0}set(t,e,s){this.food[t]={item:e,level:s}}isBeta(){return!1}getSettings(){return{}}getStats(t){let e={stats:new i,settings:{}};for(let t=0;t<st.length;++t){const s=st[t];let i=this.food[s];i.item&&e.stats.concat(i.item.getStats(i.level))}return e}getConditions(){return[]}getPostEffects(){return[]}serialize(){let t=[],e=0;for(let s=0;s<st.length;++s){const i=st[s];++e;let r=this.food[i];r.item?(t.push(r.item.getId()),t.push(r.level)):t.push(0)}return t.unshift(e),t}static deserialize(t){let e=new it,s=t.shift();for(let i=0;i<s;++i){let s=st[i];if(!s)return null;let r=t.shift(),n=0,a=DB.Food.get(s).getById(r);r>0&&(n=t.shift()),a&&(e.food[s]={item:a,level:n})}return e}}class rt extends ${isBeta(){return!1}getSettings(){return{}}getStats(t){return{stats:new i,settings:new H({})}}getConditions(){return[]}getFeatures(){return DB.Features.Reactions}getPostEffects(){return[]}}const nt={1:"reaction.melt",2:"reaction.vaporize"};class at{constructor(t){this.name=t&&t.name||"",this.items=t&&t.items||[]}addItem(t){this.items.push(t)}getItems(){return this.items}getfeaturesNames(){let t=ct(this.items);return Object.keys(t)}getItem(t){return ut(t,this.items)}replaceItem(t,e){let s=this.getItem(t);if(s){for(let t of Object.getOwnPropertyNames(s))"id"!=t&&delete s[t];for(let t of Object.getOwnPropertyNames(e))s[t]=e[t]}}deleteItem(t){let e=this.getItem(t);e&&ht(e,this.items)}clone(){return at.deserialize(this.serialize())}getHash(){return t.pack(this)}serialize(){let t=lt(this.getItems());return t.unshift(0),t.unshift(3),t}static deserialize(t){let e=t.shift(),s=null;if(1==e||2==e||3==e){e>=2&&t.shift();let i=ot(t,0,e);s=new at({items:i})}return s}static getConditionData(t,e){let s={cond:null,typeId:0,icon:"",object:"",dbObject:null,invalid:!0},i=[],r=[];if("char"==t.subtype){let n=DB.Chars.getById(t.itemId);n&&(s.typeId=1,s.object="char",s.dbObject=n,s.icon="sprite-char "+n.getIcon(),i=n.getAllConditions(),e&&t.itemId==e.getChar().getId()&&(r=i))}else if("weapon"==t.subtype){let n=DB.Conditions.Weapon;i=i.concat(n);let a=DB.Weapons.getById(t.itemId);a&&(s.typeId=2,s.object="weapon",s.icon="sprite-weapon-"+a.weapon+" "+a.getIcon(),i=i.concat(a.getConditions()),e&&t.itemId==e.getWeapon().getId()&&(r=i))}else if("artifacts"==t.subtype){let n=DB.Artifacts.Sets.getById(t.itemId);n&&(s.typeId=3,s.object="artifacts",s.icon="sprite-artifact "+n.getImage()+" flower",i=n.getConditions(5),e&&(r=e.getConditions({objects:[t.subtype]})))}else if("enemy"==t.subtype){if(i=i.concat(DB.Conditions.Enemy),s.typeId=4,s.object="enemy",t.itemId){let e=DB.Enemies.getById(t.itemId);e&&(s.icon="sprite-enemy "+e.getImage(),i=i.concat(e.getConditions()),r=i)}}else if("party"==t.subtype){let n=DB.Chars.getById(t.itemId);if(n&&(s.typeId=5,s.object="buffs",s.icon="sprite-char "+n.getIcon(),i=W.unwrap(n.getPartyConditions()),e)){let s=e.getSettings();for(let e=1;e<=3;++e)s["party_char_"+e]==t.itemId&&(r=i)}}else if("buffs"==t.subtype){let e,n=[];for(const t of DB.Buffs.getList())n=n.concat(t.getConditions());for(let s of W.unwrap(n))if(s.getId()==t.conditionId){e=s;break}e&&(s.typeId=6,s.object="buffs",s.icon=e.getIcon(),i=[e],r=i)}for(const e of i)if(e.getId()==t.conditionId){s.cond=e;break}for(const e of r)if(e.getId()==t.conditionId){s.invalid=!1;break}return s}static getArtSetByCondition(t){for(const e of DB.Artifacts.Sets.getList())for(const s of e.getConditions(5))if(s.getId()==t)return e.getId();return 0}static getEnemyByCondition(t){for(const e of DB.Enemies.getList())for(const s of e.getConditions())if(s.getId()==t)return e.getId();return 0}}function lt(t){let e=[],s=0;for(const i of t)if(i)if(e.push(i.disabled?1:0),e.push(i.collapsed?1:0),"feature"==i.type){let t=DB.Features.Rotation.getByName(i.feature);t&&(++s,e.push(1),e.push(t),e.push(Math.max(1,i.count)),e.push(i.reaction||0))}else if("condition"==i.type){let t=at.getConditionData(i);if(t.cond){let r;++s,e.push(2),e.push(t.typeId),e.push(i.itemId),e.push(t.cond.params.serializeId),r="decimal"==t.cond.params.format?Math.floor(10*parseFloat(i.value)):+i.value,e.push(r||0)}}else if("repeat"==i.type){++s,e.push(3),e.push(Math.max(1,i.count));let t=lt(i.items);e=e.concat(t)}else if("uptime"==i.type){++s,e.push(4),e.push(1),e.push(Math.min(100,Math.max(0,i.percent)));let t=lt([].concat(i.conditions,i.features));e=e.concat(t)}return e.unshift(s),e}function ot(t,e,s){let r=t.shift(),n=[];for(let a=0;a<r;++a){let r={disabled:!1};s>=2&&(r.disabled=!!t.shift()),s>=3&&(r.collapsed=!!t.shift());let a=t.shift();if(r.id=++e,1==a){r.type="feature";let e=t.shift();if(r.feature=DB.Features.Rotation.getById(e),!r.feature)return null;r.count=Math.max(1,t.shift()),r.reaction=t.shift()}else if(2==a){r.type="condition";let e=t.shift();if(1==e)r.subtype="char";else if(2==e)r.subtype="weapon";else if(3==e)r.subtype="artifacts";else if(4==e)r.subtype="enemy";else if(5==e)r.subtype="party";else{if(6!=e)return null;r.subtype="buffs"}r.itemId=t.shift(),r.conditionId=t.shift();let s=at.getConditionData(r),n=t.shift();s&&s.cond&&"decimal"==s.cond.params.format&&(n=i.format("text_decimal",n/10,{no_decimal_zero:!0})),r.value=n}else if(3==a)r.type="repeat",r.count=Math.max(1,t.shift()),r.items=ot(t,e,s),e+=r.items.length;else{if(4!=a)return null;{r.type="uptime",r.typeId=t.shift(),r.percent=Math.min(100,Math.max(0,t.shift())),r.conditions=[],r.features=[];let i=ot(t,e,s);e+=i.length;for(let t of i)"condition"==t.type?r.conditions.push(t):r.features.push(t)}}n.push(r)}return n}function ct(t){let e={};for(const s of t){"feature"==s.type&&(e[s.feature]=1);for(let t of["items","conditions","features"])if(s.hasOwnProperty(t)){let i=ct(s[t]);e=Object.assign(e,i)}}return e}function ut(t,e){for(let s of e){if(s.id==t)return s;for(let e of["items","conditions","features"])if(s.hasOwnProperty(e)){let i=ut(t,s[e]);if(i)return i}}return null}function ht(t,e){let s=e.indexOf(t);if(s>=0)return e.splice(s,1),1;for(let s of e)for(let e of["items","conditions","features"])if(s.hasOwnProperty(e)){if(ht(t,s[e]))return 1}return 0}class ft extends I{compile(t){return`Math.max(0, Math.min(1, ${super.compile(t)}))`}}class gt extends B{}class pt extends p{getType(){return"damage_result"}isCollapsable(){return!1}compile(t){return"["+this.compileChildrens(t).join(", ")+"]"}getSignature(){return null}}class dt extends O{getType(){return"damage_rotation_result"}makeResult(t){return t=Object.assign({},t),new d([...this.items,new pt(this.vars)])}}class mt{constructor(t){if(this.critChance=0,this.critMulti=1,t){let e=Object.keys(t);for(let s=0;s<e.length;++s){const i=e[s];this[i]=t[i]}}this.calcCritValues()}isHealing(){return this.icon&&"heal"==this.icon}calcCritValues(){void 0===this.average&&(this.normal?(this.crit=this.normal*this.critMulti,this.average=this.normal*(1-this.critChance)+this.crit*this.critChance):(this.normal=0,this.crit=0,this.average=0))}clone(){let t=Object.assign({},this);return Object.setPrototypeOf(t,mt.prototype),t}}class yt{constructor(t){this.name=t.name||(t.multipliers&&t.multipliers.length>0?t.multipliers[0].getName():""),this.isChild=t.isChild,this.hits=t.hits,this.icon=t.icon,this.tags=t.tags||[],this.multipliers=t.multipliers||[],this.category=t.category,this.condition=t.condition,this.element="",this.damageType="",this.rotationHitDescription=t.rotationHitDescription||"",this.rotationHitCount=t.rotationHitCount||1,this.critRateBonuses=t.critRateBonuses||[],this.critDamageBonuses=t.critDamageBonuses||[]}getDamageType(){return this.damageType}getElement(){return this.element}getName(){return this.category+"."+this.name}getIsChild(){return this.isChild}getHits(){return this.hits}getTags(){return this.tags}isRotation(){return!1}hasDetails(){return!1}canReact(){}usedInRotation(){return!1}isActive(t){return!this.condition||this.condition.isActive(t.settings)}compile(t){this.compiled=this.getCompiled(t)}getDisplaySettings(t){}getMultipliers(t){let e=[];for(let s of this.multipliers)s.isActive(t)&&e.push(s);for(let s of t.multipliers)s.isActive(t)&&s.isMatchFeature(this,t)&&e.push(s);return e}getActivePostEffectsTree(t){return t.getActivePostEffectsTree()}getCritRateBlock(t){let e=this.getStatsCritRate(t).map((e=>_(e,t.stats)));return 0==e.length&&(e=[new b({value:0})]),new ft(e)}getCritDmgBlock(t){let e=this.getStatsCritDamage(t).map((e=>_(e,t.stats)));return 0==e.length&&(e=[new b({value:0})]),new gt(e)}getCompiled(t,e){if(this.compiled)return this.compiled;e=Object.assign({dontProcessTree:1},e);let s=this.getTree(t),i=this.getActivePostEffectsTree(t),r=new N(s,i);return t.settings.reaction&&r.checkForReaction(),t.stats.ensure(r.usedStats),t.stats.ensure(r.assignedStats),r.prepare(t,e),r.compile(e),r}checkConditions(t){return!this.condition||this.condition.isActive(t.settings)}compile(t,e){let s=this.getTree(t);return this.compileTree(s,e)}compileTree(t,e){return e=Object.assign({},e),t.compile(e)}getResult(t){if(!this.checkConditions(t))return{};let e=this.getCompiled(t),[s,i,r]=e.execute(t);return{[this.getName()]:new mt({icon:this.icon||this.getElement(t),normal:s,crit:i,average:r,isReacted:e.isReacted,format:this.format,digits:this.digits,damageType:this.damageType,noCritValues:this.noCritValues})}}getUsedStats(t){let e=this.getTree(t),s=t.getActivePostEffectsTree(),i=new N(e,s);return t.stats.ensure(i.usedStats),i.prepare(t,{}),f(i.processed)}getRotationHitMiltiplier(t){return this.rotationHitCount}getDisplayRotationHitMiltiplier(t){return this.getRotationHitMiltiplier(t)}getRotationHitDescription(){return this.rotationHitDescription}static getTree(t){let e={};for(const s of Object.keys(t)){let i=s.split("."),r=i.shift(),n=i.join(".");void 0===e[r]&&(e[r]={}),e[r][n]=t[s]}return e}static buildDropdown(t,e){e=Object.assign({},e);let s=[],i=t.getFeaturesHash(t.getBuildData(),e),r=yt.getTree(i);for(let t of Object.keys(r)){s.push({isCaption:!0,value:"section_"+t,text:UI.Lang.get("feature_section."+t)});for(let e of Object.keys(r[t])){let i=r[t][e];if(i.hidden)continue;let n=t+"."+e,a="feature_"+n;i.title&&(a=i.title),a=UI.Lang.get(a),i.isChild&&(a=" "+a),s.push({value:n,text:a,isSubitem:!0,isChild:!!i.isChild})}}return s}}const bt=["","melt","vaporize","quicken"];class wt{constructor(t,e){t=[].concat(t),this.infoBlock,t.length>0&&"info"==t[0].type&&(this.infoBlock=t.shift()),this.items=t,this.opts=Object.assign({},e)}getTree(t,e){let[s,i,r,n]=this.processBlock(this.items,t,{usedStats:e});return new dt(s,{vars:[new S({ref:i}),new S({ref:r}),new S({ref:n})]})}processBlock(t,e,s){let i=new T([new b({value:0})],{name:"total_normal"}),r=new T([new b({value:0})],{name:"total_crit"}),n=new T([new b({value:0})],{name:"total_average"}),a=[i,r,n],l=e.clone(),o=l.settings?l.settings.rotation_include:"",c=[],u=[],h=[];t=function(t){let e=[],s=[];for(let i of t)"feature"==i.type?e.push(i):"condition"==i.type?(s&&(e=e.concat(s),s=[]),e.push(i)):("repeat"==i.type||"uptime"==i.type)&&s.push(i);s&&(e=e.concat(s));return e}(t),this.opts.ignoreSideEffects||(s=Ct(s));for(let e of t)if("feature"==e.type){l.settings.reaction=St(e);let t=_t(e.feature,l);if(!t)continue;if(!t.usedInRotation())continue;if(o){let e=t.getElement(l),s=t.getDamageType();if(o!=e&&o!=s)continue}let a=t.getTree(l);It(a,s);let u=[new b({value:e.count,comment:"rotation_hit_count"}),new O(a.items)],h=t.getRotationHitMiltiplier(l);"object"==typeof h?u.push(h):1!=h&&u.push(new b({value:h,comment:"rotation_hit_multi"}));let f=new T([new O(u)],{name:"normal"}),g=new T([a.critRate],{name:"crit_rate"}),p=new T([a.critDmg],{name:"crit_dmg"}),d=new T([new O([new S({ref:f}),new S({ref:p})])],{name:"crit_hit"}),m=[];a.royalCrit&&([m,g]=j(g,a.royalCrit)),m.length>0&&(c=c.concat(m)),c.push(f),c.push(g),c.push(p),c.push(d),c.push(new P([new S({ref:f})],{ref:i})),c.push(new P([new S({ref:d})],{ref:r})),c.push(new P([new O([new S({ref:f}),new z([new b({value:1}),new S({ref:g})])]),new O([new S({ref:d}),new S({ref:g})])],{ref:n}))}else if("condition"==e.type){if(c.length||u.length||h.length){let t=vt(c,u,h,s);t&&a.push(t),c=[],u=[],h=[]}for(let t of Object.keys(e.stats)){if(/^text_/.test(t))continue;let i={stat:t};if(s.copyStats){let e=kt(s,t),r=jt(t);i={stat:e,newName:r},s.stats[t]=r}u.push(new F([new b({value:e.stats.get(t)})],i))}s.usedStats&&e.stats.truncate(s.usedStats),l.addStats(e.stats),l.addSettings(e.settings);let t=s&&s.stats?Object.keys(s.stats):[];for(let i of e.postEffects)if(i.getTree)for(let e of i.getTree(l,s))t.includes(e.stat)&&(e.stat=s.stats[e.stat]),It(e,s),h.push(e)}else if("repeat"==e.type){if(c.length||u.length||h.length){let t=vt(c,u,h,s);t&&a.push(t),c=[],u=[],h=[]}let[t,o,f,g]=this.processBlock(e.items,l,Ct(s));c.push(vt([...t,...[[o,i],[f,r],[g,n]].map((t=>{let[s,i]=t;return new P([new O([new b({value:e.count}),new S({ref:s})])],{ref:i})}))],[],[],s))}else if("uptime"==e.type){if(c.length||u.length||h.length){let t=vt(c,u,h,s);t&&a.push(t),c=[],u=[],h=[]}if(e.percent>0){let t=e.percent/100,[a,o,u,h]=this.processBlock([...e.conditions,...e.items],l,Ct(s));c.push(vt([...a,...[[o,i],[u,r],[h,n]].map((e=>{let[s,i]=e;return new P([new O([new b({value:t}),new S({ref:s})])],{ref:i})}))],[],[],s))}if(e.percent<100){let t=1-e.percent/100,[a,o,u,h]=this.processBlock(e.items,l,Ct(s));c.push(vt([...a,...[[o,i],[u,r],[h,n]].map((e=>{let[s,i]=e;return new P([new O([new b({value:t}),new S({ref:s})])],{ref:i})}))],[],[],s))}}if(c.length||u.length||h.length){let t=vt(c,u,h,s);t&&a.push(t)}return[a,i,r,n]}}function vt(t,e,s,i){if(0==t.length&&0==e.length)return null;let r=f(...t),n=t,a=N.filterPostByStats(s,r);if(a.length){let[t,e]=N.postTreeBlocks(a);n=[...t,new x(n),...e]}return e.length&&(n=[...e,...n]),new x(n)}function St(t){return bt[t.reaction||0]}function _t(t,e){t=Array.isArray(t)?t:[t];for(let s of t)if(s.isActive(e)&&s.usedInRotation())return s}function Ct(t){let e=Object.assign({},t);if(e.stats={},e.copyStats=!0,t.stats)for(let s of Object.keys(t.stats))e.stats[s]=t.stats[s];return e}function kt(t,e){return t.stats&&t.stats[e]||e}function jt(t){return k(t)}function It(t,e){if(e.stats){let s=Object.keys(e.stats);t.walk((t=>{if("item_stat_total"==t.getType())for(let i of[t.stat,t.stat+"_base",t.stat+"_percent"])s.includes(i)&&(t.replace||(t.replace={}),t.replace[i]=e.stats[i]);else t.stat&&s.includes(t.stat)&&(t.stat=e.stats[t.stat])}))}}class Bt extends yt{constructor(t){super(t),this.items=t.items}getName(){return"rotation.total"}getTree(t,e){return new wt(this.items,e).getTree(t)}compile(t,e){let s=this.getTree(t,e);return this.compileTree(s,e)}compileTree(t,e){return e=Object.assign({},e),t.compile(e)}getResult(t){if(!this.checkConditions(t))return{};let e=this.getCompiled(t),[s,i,r]=e.execute(t),n=this.getElement(t);return t.settings&&t.settings.rotation_include&&(n=t.settings.rotation_include),{[this.getName()]:new mt({icon:n,normal:s,crit:i,average:r})}}getResultForEditor(t){let e=t.getBuildData();return this.processBlock(this.items,e)}processBlock(t,e){let s=[];for(let i of t)if("feature"==i.type){e.settings.reaction=St(i);let t=zt(i.feature,e);if(t){let r=t.getResult(e)[t.getName()];s.push({result:r,count:i.count,subLine:Ot(i.feature,e)})}else s.push({})}else if("condition"==i.type)i.settings&&e.addSettings(i.settings),i.stats&&e.addStats(i.stats),i.postEffects&&i.postEffects.length&&(e.postEffects=i.postEffects),i.multipliers&&i.multipliers.length&&(e.multipliers=i.multipliers);else if("repeat"==i.type){let t=e.clone();t.addSettings({inside_rotation_block:1});let r=this.processBlock(i.items,t);s=s.concat(r)}else if("uptime"==i.type){let t=e.clone();t.addSettings({inside_rotation_block:1});let r=t.clone(),n=this.processBlock(i.items,t),a=this.processBlock(i.conditions.concat(i.items),r),l=i.percent/100,o=1-l;for(let t=0;t<n.length;++t){let e=n[t].result,s=a[t].result;if(e||s){s?e||(n[t]=Object.assign({},a[t]),e=n[t].result={normal:0,crit:0,average:0}):s={normal:0,crit:0,average:0};for(let t of["normal","crit","average"])e[t]=e[t]*o+s[t]*l}}s=s.concat(n)}else"invalid"==i.type&&s.push({});return s}getDisplaySettings(t){let e={},s={},i=[{settings:{rotation_include:null},setTotal:1,icon:"multi"}];!function t(e,s,i,r){let n=s.clone();for(let s of e)if("feature"==s.type){let t=zt(s.feature,n);t&&(i[t.getElement(n)]=1,r[t.getDamageType()]=1)}else"condition"==s.type?(s.settings&&n.addSettings(s.settings),s.stats&&n.addStats(s.stats)):"repeat"==s.type?t(s.items,n,i,r):"uptime"==s.type&&(t(s.items,n,i,r),t([...s.conditions,...s.items],n,i,r))}(this.items,t,e,s);for(let t of Object.keys(e))i.push({id:"rotation.total_"+t,title:"rotation."+t,isChild:!0,settings:{rotation_include:t},getTotal:1});for(let t of Object.keys(s))i.push({id:"rotation.total_"+t,title:"rotation."+t,icon:"multi",isChild:!0,settings:{rotation_include:t},getTotal:1});return i}}function zt(t,e){t=Array.isArray(t)?t:[t];for(let s of t)if(s.isActive(e)&&s.usedInRotation())return s}function Ot(t,e){let s=zt(t,e),i=s.getRotationHitDescription(e);if(i)return{descr:"talent_descr."+i,value:s.getDisplayRotationHitMiltiplier(e)}}class At{constructor(t,e,s){this.build=t,this.rotation=e,this.opts=Object.assign({},s)}buildFeaturesList(){let t={},e=this.rotation.getfeaturesNames();for(let t of Object.keys(nt))e.push(nt[t]);for(let s of e){let e=this.build.getAllFeaturesByName(s,{ignoreRotation:!0});e.length&&(t[s]=e)}if(this.opts.loadArtifactsFeatures){let e=this.build.getBuildData();for(let s of DB.Artifacts.Sets.getList())for(let i of s.getFeatures(5)){let s=i.getResult(e.stats,e.settings);for(let e of Object.keys(s))t[e]=i}}return t}processConditions(t){if(0==this.conditions.length)return;let e=t.getBuildData(),s={},r=0;for(const i of this.conditions){let n,a={};if(i.static)a=i.getSettings(e.settings),n=i.object,++r;else{let e=at.getConditionData(i,t);if(!e.invalid&&e.cond&&e.cond.getName()&&Et.includes(e.object)){++r,n=e.object;let t=e.cond.getType();a[e.cond.getName()]="dropdown"==t||"dropdown_multiple"==t?e.cond.getValueById(i.value):i.value}}n&&(s=Object.assign(s,a),t[n].addSettings(a),t.setCommonSettings(a))}if(this.conditions=[],!r)return;let n=t.getBuildData(),a=n.getActivePostEffects(),l=i.diff(e.stats,n.stats),o=function(t,e){let s={};for(let i of Object.keys(e))void 0!==t[i]&&t[i]==e[i]||(s[i]=e[i]);for(let i of Object.keys(t))void 0===e[i]&&(s[i]=void 0);return s}(e.settings,n.settings);return Object.keys(l).length||Object.keys(o).length||a.length?{type:"condition",stats:l,settings:o,postEffects:a}:void 0}processBlock(t,e,s){let i=[],r=[],n=e.filter((t=>!t.disabled));n.length&&"condition"!=n[0].type&&r.push({type:"condition",static:1,getSettings:()=>({})});for(const t of e)if(r.push(t),"feature"==t.type&&this.features[t.feature])for(let e of this.features[t.feature])if(e&&e.getRotationAfterItems){let i=e.getRotationAfterItems(t,{insideBlock:s});for(const t of i)r.push(t)}for(const e of r)if(!e.disabled){if("condition"!=e.type){let e=this.processConditions(t);e&&i.push(e)}if("feature"==e.type){let t=this.features[e.feature];if(t){++this.featuresTotal;let s={type:e.type,feature:t,featureName:e.feature,count:e.count,reaction:e.reaction};i.push(s)}else i.push({type:"invalid"})}else if("condition"==e.type)this.conditions.push(e);else if("repeat"==e.type){let s=this.processBlock(t,e.items,1);s&&i.push({type:e.type,count:e.count,items:s})}else if("uptime"==e.type){let s=this.processBlock(t,e.features,1);if(!s)continue;let r=this.processBlock(t,e.conditions,1);0==r.length?i.push({type:"repeat",count:1,items:s}):i.push({type:e.type,percent:e.percent,conditions:r,items:s})}}let a=this.processConditions(t);return a&&i.push(a),i}buildInfoBlock(){let t={type:"info"},e=0;if(this.sideEffectStats.length&&(e=1,t.sideEffectStats=this.sideEffectStats),e)return t}compile(){this.features=this.buildFeaturesList(),this.featuresTotal=0,this.conditions=[],this.sideEffectStats=[];let t=[].concat(this.rotation.getItems());t.unshift({type:"condition",static:1,getSettings:()=>({})});let e=this.processBlock(this.build.cloneWithArtifactSettings(),t);if(0==this.featuresTotal)return null;let s=this.buildInfoBlock();return s&&e.unshift(s),new Bt({name:this.rotation.name,items:e})}}class Dt extends ${constructor(){super(),this.object=new at}set(t){this.object=t?t.clone():new at}isBeta(){return!1}getConditions(){return[]}getFeatures(){return[]}getPostEffects(){return[]}getSettings(){return[]}getMultipliers(){return[]}serialize(){return this.object.serialize()}static deserialize(t){if(0==t.length)return new Dt;let e=at.deserialize(t),s=new Dt;return s.set(e),s}}class Tt extends ${isBeta(){return!1}getSettings(){return{}}getStats(t){return{stats:new i,settings:new H({})}}getConditions(){return[]}getFeatures(){return DB.Features.Stats}getPostEffects(){return[]}}class Pt extends ${constructor(){super(),this.levels={level:1,ascension:0,refine:1}}setLevels(t){this.levels.level=t.level,this.levels.ascension=t.ascension,this.levels.refine=Math.min(5,Math.max(1,t.refine))}getStats(){var t=super.getStats();if(this.object&&this.object.refineTable)for(let e of this.object.refineTable)t.stats.add(e.getName(),e.getValue(this.levels.refine));return t}getSettings(){let t=super.getSettings(),e={weapon_level:this.levels.level,weapon_ascension:this.levels.ascension,weapon_refine:this.levels.refine};return this.object&&(e.weapon_id=this.object.getId(),e.weapon_type=this.object.weapon),t=Object.assign(t,e),t}getId(){return this.object?this.object.getId():0}getName(){return this.object?this.object.getName():""}getConditions(){let t=super.getConditions();return t=t.concat(DB.Conditions.Weapon),t}serialize(t){let e=[];if(!this.object)return null;e.push(this.object.getId()),e.push(this.levels.level,this.levels.ascension,this.levels.refine);let s=this.serializeConditions(t);return e.concat(s)}static deserialize(t){let e=DB.Weapons.getById(t.shift());if(!e)return null;let s=t.shift();if(s<1||s>90)return null;let i=t.shift();if(i<0||i>6)return null;let r=t.shift();if(r<0||r>5)return null;let n=new Pt;n.set(e),n.setLevels({level:s,ascension:i,refine:r||1});let a=n.deserializeConditions(t);return a?(n.setSettings(a),n):null}}const Et=["char","weapon","artifacts","enemy","buffs","rotation","food","reaction","static"],xt=["char","weapon","artifacts","enemy","buffs","rotation","food"];class Ft{constructor(){this.char=new tt,this.weapon=new Pt,this.artifacts=new q,this.enemy=new et,this.buffs=new X,this.rotation=new Dt,this.food=new it,this.reaction=new rt,this.static=new Tt}getChar(){return this.char}setChar(t){let e=this.getCommonSettings("char");this.char.set(t);let s="";this.weapon.object&&(s=this.weapon.object.weapon),s!=t.weapon&&this.setWeapon(DB.Weapons.get(t.weapon).getFirst());let i=this.buffs.getPartyChars();this.buffs.setPartyChars(i.filter((e=>e!=t.getId()))),this.setCharSettings(e)}setCharLevels(t){this.char.setLevels(t)}setCharSkills(t){this.char.setSkills(t)}setCharSettings(t){this.char.setSettings(t),this.setCommonSettings(t)}getWeapon(){return this.weapon}setWeapon(t){let e=this.getCommonSettings("weapon");this.weapon.set(t),this.setWeaponSettings(e)}setWeaponLevels(t){this.weapon.setLevels(t)}setWeaponSettings(t){this.weapon.setSettings(t),this.setCommonSettings(t)}setEnemy(t){this.enemy.set(t)}setEnemyLevels(t){this.enemy.setLevels(t)}setEnemyResistances(t){this.enemy.setResistances(t)}setEnemySettings(t){this.enemy.setSettings(t),this.setCommonSettings(t)}getEnemy(){return this.enemy}setArtifact(t){this.artifacts.set(t)}replaceArtifacts(t){this.artifacts.replace(t)}getArtifacts(){return this.artifacts.get()}getArtifactsHashList(){let t=[],e=this.getArtifacts();return Object.keys(e).forEach((function(s){let i=e[s];i&&t.push(i.getHash())})),t}removeArtifact(t){this.artifacts.remove(t)}clearArtifacts(){this.artifacts.clearArtifacts()}setArtifactsSettings(t){this.artifacts.setSettings(t),this.setCommonSettings(t)}isEquipped(t){return this.artifacts.isEquipped(t)}getBuffs(){return this.buffs.get()}setBuffsSettings(t){this.buffs.setSettings(t),this.setCommonSettings(t)}modifyBuffsSettings(t){let e=this.buffs.modifySettings(t);this.setCommonSettings(e)}setPartyChars(t){this.buffs.setPartyChars(t)}getPartyChars(){return this.buffs.getPartyChars()}setRotation(t){this.rotation.set(t)}getRotation(){return this.rotation.get()}setFood(t,e,s){return this.food.set(t,e,s)}getFood(t){return this.food.get(t)}getFoodLevel(t){return this.food.getLevel(t)}hasBetaContent(){for(let t of Et)if(this[t]&&this[t].isBeta())return!0;return!1}refreshCommonSettings(){let t=this.getSettings();for(let e of Et){if(!this[e])continue;let s=this[e].getSettings(),i=this.getActiveConditions(t,{objects:[e]});W.setCommonValues(s,i),this[e].setSettings(s)}}getCommonSettings(t){let e=this.getSettings(),s=this[t].getSettings();for(let t of Object.keys(e))/^common\./.test(t)&&(s[t]=e[t]);return s}setCommonSettings(t){let e=[];for(const s of Object.keys(t))/^common\./.test(s)&&e.push(s);if(0!=e.length)for(let s of Et){if(!this[s])continue;let i=this[s].getSettings();for(const s of Object.keys(i))e.includes(s)&&(i[s]=t[s]);this[s].setSettings(i)}}getConditions(t){let e=[],s=Et;for(let i=0;i<s.length;++i){let r=s[i];this[r]&&(t&&t.objects&&!t.objects.includes(r)||(e=e.concat(this[r].getConditions())))}return e}getActiveConditions(t,e){let s=[],i=Et;for(let r=0;r<i.length;++r){let n=i[r];if(!this[n])continue;if(e&&e.objects&&!e.objects.includes(n))continue;let a=this[n].getConditions();for(let e=0;e<a.length;++e){const i=a[e];i.params.hideInactive&&!i.checkSubconditions(t)||s.push(i)}}return s}getArtifactsConditions(){return this.artifacts?this.artifacts.getConditions():[]}getSettings(){let t={},e=Et;for(let s=0;s<e.length;++s){let i=e[s];this[i]&&(t=Object.assign(t,this[i].getSettings()))}return t}getBaseStats(t,e){let s=new U;t&&s.stats.concat(t),s.settings.concat(this.getSettings(),e);let i=Et;for(let t=0;t<i.length;++t){let e=i[t];if(!this[e])continue;let r=this[e].getConditions();for(let t=0;t<r.length;++t){let e=r[t].getData(s.settings);s.stats.concat(e.stats),s.settings.concat(s.settings,e.settings)}}for(let t=0;t<i.length;++t){let e=i[t];if(!this[e])continue;let r=this[e].getStats(s.settings);s.stats.concat(r.stats),s.settings.concat(s.settings,r.settings)}return s.stats.get("dmg_own")&&s.stats.add("dmg_"+s.settings.char_element,s.stats.get("dmg_own")),s.multipliers=this.getMultipliers(),s.postEffects=this.getPostEffects(),s}getBaseStatsWithSets(t,e){let s=this.getBaseStats(t,e),i=this.getPostEffects();return s.stats.applyPostEffects(s.settings,i,L),s}getPostEffects(){let t=[],e=Et;for(let s=0;s<e.length;++s){let i=e[s];this[i]&&(t=t.concat(this[i].getPostEffects()))}return t}getMultipliers(){let t=[];for(let e of Et)this[e]&&(t=t.concat(this[e].getMultipliers()));return t=t.concat(DB.CalcData.Multipliers),t}getStats(t,e){return this.getBaseStats(t,e)}getBuildData(t,e){let s=this.getBaseStats(t,e);return s.stats.processPercent(),s}calcFeatures(t){let e=this.getBuildData();return this.getFeatures(e,t)}getFeaturesList(t){let e=[];t=Object.assign({},t);for(let s of Et){if(!this[s])continue;let i;if("rotation"==s){if(!t.ignoreRotation){let t=this.compileRotation();t&&(i=[t])}}else i=this[s].getFeatures();i&&(e=e.concat(i))}return e}compileRotation(){return new At(this,this.getRotation()).compile()}getFeaturesHash(t,e){e=Object.assign({},e);let s={};for(let i of this.getFeaturesList())t&&!i.checkConditions(t)||e.checkCallback&&!e.checkCallback(i)||(s[i.getName()]=i);return s}getFeatures(t){let e={};for(let s of this.getFeaturesList())e=Object.assign(e,s.getResult(t));return e}getFeaturesNames(){let t={},e=this.getStats(),s=this.getFeaturesList();for(let i=0;i<s.length;++i){const r=s[i];Object.assign(t,r.getFeatureNamesHash(e.stats,e.settings))}return t}getFeatureResultByName(t){let e=this.getFeatureByName(t);if(!e)return;let s=this.getBuildData();return e.getResult(s)[t]}getFeatureByName(t,e){if(!t)return null;e||=this.getBuildData();for(let s of this.getFeaturesList())if(s.isActive(e)&&t==s.getName())return s;return null}getAllFeaturesByName(t,e){if(!t)return[];let s=[];for(let i of this.getFeaturesList(e))t==i.getName()&&s.push(i);return s}clone(){return Ft.deserialize(this.serialize())}cloneWithArtifactSettings(){let t=Ft.deserialize(this.serialize());return t.artifacts.modifySettings(this.artifacts.getSettings()),t}getHash(){return t.pack(this)}serialize(){let t=[1],e=this.getSettings();for(let t of Et)if(this[t])for(let s of this[t].getConditions()){let t=s.getData(e);Object.assign(e,t.settings)}for(let s of xt){if(!this[s])return null;let i=this[s].serialize(e);if(!i)return null;t=t.concat(i)}return t}static deserialize(t){let e=null;if(1==t.shift()){if(e=new Ft,e.char=tt.deserialize(t),!e.char)return null;if(e.weapon=Pt.deserialize(t),!e.weapon)return null;if(e.artifacts=q.deserialize(t),!e.artifacts)return null;if(e.enemy=et.deserialize(t),!e.enemy)return null;if(e.buffs=X.deserialize(t),!e.buffs)return null;if(e.rotation=Dt.deserialize(t),!e.rotation)return null;if(e.food=it.deserialize(t),!e.food)return null}return e}}importScripts("db.js?3.1.3b");const Rt={flower:1,plume:2,sands:3,goblet:4,circlet:5};self.onmessage=function(e){let s,i=e.data.artifacts,r=Ft.deserialize(e.data.calcSet),n=e.data.feature,a=e.data.featureType,l=e.data.sortByFeature,o=e.data.sortByStat,c=e.data.setsOrders,u=[];l&&(s=r.getFeatureByName(n));let f=r.artifacts.getSettings(),g=r.getConditions({objects:"artifacts"}),p=W.allConditionsOff(g);Object.assign(p,f);for(let e of i){let i=h.deserialize(t.unpack(e)),f={hash:e,featureValue:0,statValue:0,setValue:c[i.getSet()],slotValue:Rt[i.getSlot()]};if(l&&s){let t=r.clone();t.setArtifact(i);let e=t.getConditions({objects:"artifacts"}),l=W.allConditionsOn(e),o=Object.assign({},l,p);t.setArtifactsSettings(o);let c=t.getBuildData(),u=s.getResult(c);u[n]&&(f.featureValue=u[n][a])}if(o){let t=i.calcStats();f.statValue=t.get(o)}u.push(f)}u=u.sort(((t,e)=>e.featureValue-t.featureValue||e.statValue-t.statValue||t.setValue-e.setValue||t.slotValue-e.slotValue)),self.postMessage({result:u.map((t=>t.hash))})}})();